# å¡”ç½—å åœåº”ç”¨ - æ¶æ„è®¾è®¡æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº AI çš„å¡”ç½—å åœåº”ç”¨ï¼Œä½¿ç”¨ Google Gemini 2.0 Flash æ¨¡å‹æä¾›ä¸“ä¸šçš„å¡”ç½—ç‰Œè§£è¯»ã€‚åº”ç”¨é‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œå‰ç«¯ä½¿ç”¨ Reactï¼Œåç«¯ä½¿ç”¨ FastAPIï¼Œæ•°æ®å­˜å‚¨ä½¿ç”¨æœ¬åœ° JSON æ–‡ä»¶ã€‚

## æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚         â”‚                 â”‚         â”‚                  â”‚
â”‚  React Frontend â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚  FastAPI Backendâ”‚ â—„â”€â”€â”€â”€â”€â–º â”‚ Gemini 2.0 Flash â”‚
â”‚                 â”‚  HTTP   â”‚                 â”‚   API   â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â”‚                           â”‚
         â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚         â”‚                 â”‚
â”‚  LocalStorage   â”‚         â”‚   JSON Files    â”‚
â”‚   (Browser)     â”‚         â”‚   (Backend)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

**åç«¯ï¼š**
- FastAPI 0.115.0 - Web æ¡†æ¶
- Uvicorn - ASGI æœåŠ¡å™¨
- Google GenerativeAI 0.8.3 - Gemini API SDK
- Pydantic 2.9.2 - æ•°æ®éªŒè¯
- Passlib - å¯†ç åŠ å¯†
- Aiofiles - å¼‚æ­¥æ–‡ä»¶æ“ä½œ

**å‰ç«¯ï¼š**
- React 18.3.1 - UI æ¡†æ¶
- TypeScript 5.7.2 - ç±»å‹å®‰å…¨
- Vite 6.0.5 - æ„å»ºå·¥å…·
- Tailwind CSS 3.4.17 - æ ·å¼æ¡†æ¶
- Framer Motion 11.11.17 - åŠ¨ç”»åº“
- Zustand 5.0.2 - çŠ¶æ€ç®¡ç†
- Axios 1.7.9 - HTTP å®¢æˆ·ç«¯

---

## åç«¯æ¶æ„è®¾è®¡

### 1. æ ¸å¿ƒæ¨¡å—

#### 1.1 æ•°æ®æ¨¡å‹å±‚ (models.py)

**åŠŸèƒ½ï¼š** å®šä¹‰æ‰€æœ‰æ•°æ®ç»“æ„å’Œç±»å‹

**æ ¸å¿ƒæ¨¡å‹ï¼š**
- `User` - ç”¨æˆ·æ¨¡å‹ï¼ˆåŒ…å« IDã€ç±»å‹ã€ç”¨æˆ·åã€å¯†ç å“ˆå¸Œã€ä¸ªäººèµ„æ–™ï¼‰
- `UserProfile` - ç”¨æˆ·èµ„æ–™ï¼ˆæ˜µç§°ã€æ€§åˆ«ã€å‡ºç”Ÿæ—¥æœŸï¼‰
- `Conversation` - å¯¹è¯æ¨¡å‹ï¼ˆåŒ…å«æ¶ˆæ¯åˆ—è¡¨ã€ä¼šè¯ç±»å‹ã€å®ŒæˆçŠ¶æ€ï¼‰
- `Message` - æ¶ˆæ¯æ¨¡å‹ï¼ˆè§’è‰²ã€å†…å®¹ã€æ—¶é—´æˆ³ã€å¡”ç½—ç‰Œç»“æœã€æŠ½ç‰Œè¯·æ±‚ï¼‰
  - `tarot_cards`: æŠ½åˆ°çš„ç‰Œåˆ—è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºåœ¨å¯¹è¯ä¸­æ˜¾ç¤ºæŠ½ç‰Œç»“æœï¼‰
  - `draw_request`: æŠ½ç‰Œè¯·æ±‚ä¿¡æ¯ï¼ˆå¯é€‰ï¼ŒåŒ…å«ç‰Œé˜µç±»å‹ã€ç‰Œæ•°ã€ä½ç½®å«ä¹‰ï¼‰
- `TarotCard` - å¡”ç½—ç‰Œæ¨¡å‹ï¼ˆç‰ŒIDã€ç‰Œåã€æ˜¯å¦é€†ä½ï¼‰
- `DrawCardsRequest` - æŠ½ç‰Œè¯·æ±‚ï¼ˆç‰Œé˜µç±»å‹ã€ç‰Œæ•°ã€ä½ç½®å«ä¹‰ï¼‰

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ Pydantic BaseModel å®ç°æ•°æ®éªŒè¯
- ä½¿ç”¨ Enum å®šä¹‰æšä¸¾ç±»å‹ï¼ˆUserType, Gender, MessageRole, SessionType, TarotSpreadï¼‰
- ä½¿ç”¨ Field æ·»åŠ é»˜è®¤å€¼å’ŒéªŒè¯è§„åˆ™
- **æŠ½ç‰Œç»“æœæ˜¾ç¤ºæœºåˆ¶**ï¼šAIè§£è¯»æ¶ˆæ¯ä¼šé™„åŠ  `tarot_cards` å’Œ `draw_request` å­—æ®µï¼Œå‰ç«¯æ ¹æ®è¿™äº›å­—æ®µåœ¨å¯¹è¯çª—å£ä¸­æ¸²æŸ“ç¾åŒ–çš„å¡ç‰ŒUI

#### 1.2 é…ç½®å±‚ (config.py)

**åŠŸèƒ½ï¼š** é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®é¡¹

**é…ç½®å†…å®¹ï¼š**
- API å¯†é’¥é…ç½®ï¼ˆGemini API Keyï¼‰
- æ–‡ä»¶è·¯å¾„é…ç½®ï¼ˆæ•°æ®ç›®å½•ã€ç”¨æˆ·æ–‡ä»¶ã€å¯¹è¯æ–‡ä»¶ï¼‰
- CORS é…ç½®ï¼ˆå…è®¸çš„æºï¼‰
- å¡”ç½—ç‰Œæ•°æ®ï¼ˆ78å¼ ç‰Œçš„åç§°åˆ—è¡¨ï¼‰

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ç¯å¢ƒå˜é‡åŠ è½½æ•æ„Ÿé…ç½®
- ä½¿ç”¨ pathlib ç®¡ç†æ–‡ä»¶è·¯å¾„
- è‡ªåŠ¨åˆ›å»ºå¿…è¦çš„ç›®å½•

#### 1.3 å­˜å‚¨æœåŠ¡å±‚ (services/storage_service.py)

**åŠŸèƒ½ï¼š** ç»Ÿä¸€ç®¡ç†æœ¬åœ° JSON æ–‡ä»¶å­˜å‚¨

**æ ¸å¿ƒæ–¹æ³•ï¼š**

**ç”¨æˆ·ç›¸å…³ï¼š**
- `get_user(user_id)` - æ ¹æ® ID è·å–ç”¨æˆ·
- `get_user_by_username(username)` - æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·
- `save_user(user)` - ä¿å­˜ç”¨æˆ·
- `delete_user(user_id)` - åˆ é™¤ç”¨æˆ·

**å¯¹è¯ç›¸å…³ï¼š**
- `get_conversation(conversation_id)` - è·å–å¯¹è¯
- `get_user_conversations(user_id)` - è·å–ç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯
- `save_conversation(conversation)` - ä¿å­˜å¯¹è¯
- `delete_conversation(conversation_id)` - åˆ é™¤å¯¹è¯

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ aiofiles å®ç°å¼‚æ­¥æ–‡ä»¶æ“ä½œï¼Œæé«˜æ€§èƒ½
- æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯å¼‚æ­¥çš„ï¼ˆasync/awaitï¼‰
- ä½¿ç”¨ JSON æ ¼å¼å­˜å‚¨ï¼Œæ˜“äºè°ƒè¯•å’Œè¿ç§»
- å†…éƒ¨ä½¿ç”¨å­—å…¸ä½œä¸ºç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡

#### 1.4 ç”¨æˆ·æœåŠ¡å±‚ (services/user_service.py)

**åŠŸèƒ½ï¼š** å¤„ç†ç”¨æˆ·ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `hash_password(password)` - å¯†ç å“ˆå¸Œ
- `verify_password(plain, hashed)` - å¯†ç éªŒè¯
- `create_guest_user(profile)` - åˆ›å»ºæ¸¸å®¢ç”¨æˆ·
- `create_registered_user(register_data)` - åˆ›å»ºæ³¨å†Œç”¨æˆ·
- `authenticate_user(username, password)` - ç”¨æˆ·è®¤è¯
- `update_user_profile(user_id, profile)` - æ›´æ–°ç”¨æˆ·èµ„æ–™
- `get_user(user_id)` - è·å–ç”¨æˆ·ä¿¡æ¯

**è°ƒç”¨å…³ç³»ï¼š**
```
create_guest_user â†’ generate UUID â†’ save_user (StorageService)
create_registered_user â†’ check username â†’ hash_password â†’ save_user
authenticate_user â†’ get_user_by_username â†’ verify_password
update_user_profile â†’ get_user â†’ save_user
```

**è®¾è®¡æœºåˆ¶ï¼š**
- æ¸¸å®¢ ID ä½¿ç”¨ `guest_` å‰ç¼€ + 12ä½éšæœºå­—ç¬¦
- æ³¨å†Œç”¨æˆ· ID ä½¿ç”¨ `user_` å‰ç¼€ + 12ä½éšæœºå­—ç¬¦
- ä½¿ç”¨ bcrypt ç®—æ³•åŠ å¯†å¯†ç ï¼Œä¿è¯å®‰å…¨æ€§
- æ³¨å†Œæ—¶æ£€æŸ¥ç”¨æˆ·åå”¯ä¸€æ€§

#### 1.5 å¯¹è¯æœåŠ¡å±‚ (services/conversation_service.py)

**åŠŸèƒ½ï¼š** ç®¡ç†å¯¹è¯ç”Ÿå‘½å‘¨æœŸå’Œæ¶ˆæ¯

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `create_conversation(user_id, session_type)` - åˆ›å»ºæ–°å¯¹è¯
- `get_conversation(conversation_id)` - è·å–å¯¹è¯
- `get_user_conversations(user_id)` - è·å–ç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯
- `add_message(conversation_id, role, content, tarot_cards, draw_request)` - æ·»åŠ æ¶ˆæ¯
  - æ”¯æŒé™„åŠ  `tarot_cards` å’Œ `draw_request` å‚æ•°
  - ç”¨äºåœ¨AIè§£è¯»æ¶ˆæ¯ä¸­åŒ…å«æŠ½ç‰Œç»“æœ
- `get_latest_tarot_cards(conversation)` - ä»å¯¹è¯å†å²ä¸­è·å–æœ€è¿‘çš„æŠ½ç‰Œç»“æœ
  - è¿”å› `(tarot_cards, draw_request)` å…ƒç»„
  - ç”¨äºåœ¨AIå›å¤æ—¶é™„åŠ æŠ½ç‰Œæ•°æ®
- `update_conversation_title(conversation_id, title)` - æ›´æ–°æ ‡é¢˜
- `mark_cards_drawn(conversation_id)` - æ ‡è®°å·²æŠ½ç‰Œ
- `mark_completed(conversation_id)` - æ ‡è®°å·²å®Œæˆ
- `delete_conversation(conversation_id)` - åˆ é™¤å¯¹è¯

**è°ƒç”¨å…³ç³»ï¼š**
```
create_conversation â†’ generate UUID â†’ save_conversation
add_message â†’ get_conversation â†’ append message â†’ update timestamp â†’ save_conversation
mark_cards_drawn â†’ get_conversation â†’ set flag â†’ save_conversation
```

**è®¾è®¡æœºåˆ¶ï¼š**
- å¯¹è¯ ID ä½¿ç”¨ `conv_` å‰ç¼€ + 16ä½éšæœºå­—ç¬¦
- è‡ªåŠ¨æ ¹æ®ä¼šè¯ç±»å‹ç”Ÿæˆé»˜è®¤æ ‡é¢˜
- ç”¨æˆ·ç¬¬ä¸€æ¡æ¶ˆæ¯è‡ªåŠ¨ç”Ÿæˆå¯¹è¯æ ‡é¢˜ï¼ˆæˆªå–å‰20å­—ç¬¦ï¼‰
- æ¯æ¬¡æ·»åŠ æ¶ˆæ¯éƒ½æ›´æ–° `updated_at` æ—¶é—´æˆ³
- ä½¿ç”¨ `has_drawn_cards` æ ‡è®°é˜²æ­¢é‡å¤æŠ½ç‰Œ
- ä½¿ç”¨ `is_completed` æ ‡è®°å®ŒæˆçŠ¶æ€

#### 1.6 Gemini AI æœåŠ¡å±‚ (services/gemini_service.py)

**åŠŸèƒ½ï¼š** ä¸ Gemini API äº¤äº’ï¼Œå®ç° AI å¯¹è¯ã€å¡”ç½—è§£è¯»å’Œæ˜Ÿç›˜åˆ†æï¼Œæ”¯æŒ Function Calling Agent Loop

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `_build_user_context(user)` - æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯
- `_format_messages_for_gemini(messages, user, session_type)` - æ ¼å¼åŒ–æ¶ˆæ¯
- `stream_response(messages, user, session_type)` - æµå¼ç”Ÿæˆå›å¤ï¼ˆæ”¯æŒFunction Callingçš„Agent Loopï¼‰
- `continue_with_function_result(messages, user, session_type, function_name, function_result)` - åœ¨æ”¶åˆ°å‡½æ•°æ‰§è¡Œç»“æœåç»§ç»­Agent Loop

**Function Calling å·¥å…·å®šä¹‰ï¼š**

**æ³¨æ„ï¼šå¡”ç½—AIå’Œæ˜Ÿåº§AIéƒ½å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ‰€æœ‰å·¥å…·ï¼Œå®ç°çµæ´»çš„è·¨é¢†åŸŸè§£è¯»**

1. **draw_tarot_cards** - å¡”ç½—æŠ½ç‰Œå·¥å…·
   ```python
   å‚æ•°:
   - spread_type: ç‰Œé˜µç±»å‹ (single/three_card/celtic_cross/custom)
   - card_count: æŠ½ç‰Œæ•°é‡ (1-10å¼ )
   - positions: ç‰Œé˜µä½ç½®å«ä¹‰ (å¯é€‰)
   
   é€‚ç”¨åœºæ™¯ï¼š
   - å¡”ç½—AIï¼šä¸»è¦åŠŸèƒ½ï¼Œä¸ºç”¨æˆ·æŠ½ç‰Œå åœ
   - æ˜Ÿåº§AIï¼šè¾…åŠ©åŠŸèƒ½ï¼Œå¯ç»“åˆæ˜Ÿç›˜åˆ†ææŠ½ç‰Œï¼Œæä¾›ç»¼åˆæ€§æŒ‡å¼•
   ```

2. **get_astrology_chart** - è·å–æ˜Ÿç›˜æ•°æ®å·¥å…·
   ```python
   å‚æ•°:
   - reason: è°ƒç”¨åŸå› è¯´æ˜
   
   é€‚ç”¨åœºæ™¯ï¼š
   - æ˜Ÿåº§AIï¼šä¸»è¦åŠŸèƒ½ï¼Œè·å–æœ¬å‘½ç›˜è¿›è¡Œæ·±å…¥åˆ†æ
   - å¡”ç½—AIï¼šæ‰©å±•åŠŸèƒ½ï¼Œå¯åœ¨å¡”ç½—è§£è¯»ä¸­ç»“åˆç”¨æˆ·æ˜Ÿç›˜ï¼Œæä¾›æ›´ä¸ªæ€§åŒ–çš„å»ºè®®
   ```

3. **request_user_profile** - è¯·æ±‚ç”¨æˆ·è¡¥å……ä¸ªäººä¿¡æ¯å·¥å…·
   ```python
   å‚æ•°:
   - reason: è¯·æ±‚ä¿¡æ¯çš„åŸå› è¯´æ˜
   - required_fields: éœ€è¦çš„å­—æ®µåˆ—è¡¨ (birth_date/birth_time/birth_city/nickname/gender)
   
   é€‚ç”¨åœºæ™¯ï¼š
   - æ˜Ÿåº§AIï¼šå½“éœ€è¦æ˜Ÿç›˜åˆ†æä½†ç”¨æˆ·èµ„æ–™ä¸å®Œæ•´æ—¶è°ƒç”¨
   - å¡”ç½—AIï¼šå½“éœ€è¦ç»“åˆæ˜Ÿç›˜è¿›è¡Œæ·±å…¥è§£è¯»æ—¶è°ƒç”¨
   ```

**ç³»ç»Ÿæç¤ºè¯ï¼ˆTAROT_SYSTEM_PROMPTï¼‰ï¼š**
```
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¡”ç½—å åœå¸ˆå’Œå‘½ç†å¸ˆ...
1. é¦–æ¬¡å¯¹è¯æ—¶ï¼Œå¼•å¯¼ç”¨æˆ·è¯´å‡ºé—®é¢˜
2. åˆ†æé—®é¢˜ï¼Œå†³å®šç‰Œé˜µå’Œç‰Œæ•°
3. ä½¿ç”¨ draw_tarot_cards å·¥å…·ä¸ºç”¨æˆ·æŠ½ç‰Œï¼ˆæ¯æ¬¡å¯¹è¯åªèƒ½æŠ½ä¸€æ¬¡ï¼‰
4. æ”¶åˆ°æŠ½ç‰Œç»“æœåï¼Œè¿›è¡Œä¸“ä¸šè§£è¯»
5. è§£è¯»å®Œæ¯•åï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­æ¢è®¨
6. ä¸èƒ½å†æ¬¡æŠ½ç‰Œ
```

**ç³»ç»Ÿæç¤ºè¯ï¼ˆASTROLOGY_SYSTEM_PROMPTï¼‰ï¼š**
```
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å æ˜Ÿå¸ˆå’Œæ˜Ÿåº§åˆ†æå¸ˆ...
1. é¦–æ¬¡å¯¹è¯æ—¶ï¼Œå¼•å¯¼ç”¨æˆ·æé—®
2. åˆ¤æ–­é—®é¢˜æ˜¯å¦éœ€è¦æ˜Ÿç›˜èµ„æ–™
3. å¦‚éœ€æ˜Ÿç›˜ä¸”ç”¨æˆ·èµ„æ–™å®Œæ•´ï¼Œä½¿ç”¨ get_astrology_chart å·¥å…·è·å–æ•°æ®
4. æ”¶åˆ°æ˜Ÿç›˜æ•°æ®åï¼Œè¿›è¡Œæ·±å…¥è§£è¯»
5. å¦‚ä¸éœ€è¦æ˜Ÿç›˜ï¼Œç›´æ¥å›ç­”æ˜Ÿåº§çŸ¥è¯†é—®é¢˜
```

**Agent Loop è°ƒç”¨å…³ç³»ï¼š**
```
stream_response â†’ _format_messages_for_gemini â†’ _build_user_context
              â†’ create GenerativeModel with tools
              â†’ start_chat â†’ send_message_async (non-stream)
              â†’ check for function_call
              â†’ yield {"function_call": {...}} if found
              â†’ yield {"content": text} for text chunks
              â†’ yield {"done": True} when complete

è·¯ç”±å±‚æ‰§è¡Œå‡½æ•° â†’ è°ƒç”¨å®é™…æœåŠ¡ï¼ˆTarotService/AstrologyServiceï¼‰
              â†’ æ„é€  function_result

continue_with_function_result â†’ format messages with function result
                              â†’ send function_response to AI
                              â†’ stream final AI response
                              â†’ yield {"content": text} chunks
                              â†’ yield {"done": True}
```

**è®¾è®¡æœºåˆ¶ï¼š**
- **Agent Loopæ¶æ„**ï¼šAIå¯ä»¥ä¸»åŠ¨è°ƒç”¨å·¥å…·ï¼Œå·¥å…·æ‰§è¡Œåå°†ç»“æœå–‚å›AIç»§ç»­å¤„ç†
- **Function Callingåè®®**ï¼šä½¿ç”¨Geminiæ ‡å‡†çš„Function Callingæœºåˆ¶ï¼Œç¬¦åˆAPIè§„èŒƒ
- **å¯æ‰©å±•æ€§**ï¼šå·¥å…·å®šä¹‰ä¸ä¸šåŠ¡é€»è¾‘åˆ†ç¦»ï¼Œæ˜“äºæ·»åŠ æ–°å·¥å…·
- **ç»Ÿä¸€å·¥å…·é›†**ï¼šå¡”ç½—å’Œæ˜Ÿåº§AIä½¿ç”¨ç›¸åŒçš„å·¥å…·é›†ï¼ˆæ‰€æœ‰3ä¸ªå·¥å…·ï¼‰ï¼Œå®ç°è·¨é¢†åŸŸè§£è¯»èƒ½åŠ›
  - å¡”ç½—AIå¯ä»¥è°ƒç”¨æ˜Ÿç›˜æ•°æ®ï¼Œæä¾›æ›´ç²¾å‡†çš„ä¸ªæ€§åŒ–è§£è¯»
  - æ˜Ÿåº§AIå¯ä»¥æŠ½å¡”ç½—ç‰Œï¼Œä»å¦ä¸€è§’åº¦è¾…åŠ©æ˜Ÿç›˜åˆ†æ
  - ä¸¤ä¸ªAIéƒ½å¯ä»¥è¯·æ±‚ç”¨æˆ·è¡¥å……èµ„æ–™
- **æµå¼è¾“å‡º**ï¼šæ”¯æŒæµå¼è¿”å›æ–‡æœ¬å’Œå‡½æ•°è°ƒç”¨äº‹ä»¶
- **é”™è¯¯å¤„ç†**ï¼šå‡½æ•°æ‰§è¡Œå¤±è´¥æ—¶è¿”å›é”™è¯¯ä¿¡æ¯ï¼ŒAIä¼šæ®æ­¤è°ƒæ•´å›å¤
- ç”¨æˆ·èµ„æ–™ï¼ˆæ˜µç§°ã€æ€§åˆ«ã€ç”Ÿæ—¥ï¼‰ä¼šè¢«æ·»åŠ åˆ°ç³»ç»Ÿæç¤ºä¸­ï¼Œç”¨äºä¸ªæ€§åŒ–
- å†å²æ¶ˆæ¯ä¼šè¢«å®Œæ•´ä¼ é€’ç»™ AIï¼Œä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§
- å‡½æ•°ç»“æœä¼šè¢«ä¿å­˜ä¸ºSYSTEMæ¶ˆæ¯ï¼Œä¾›AIå‚è€ƒ

#### 1.7 æ˜Ÿç›˜æœåŠ¡å±‚ (services/astrology_service.py)

**åŠŸèƒ½ï¼š** å¤„ç†æ˜Ÿç›˜æ•°æ®è·å–å’Œæ ¼å¼åŒ–

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `fetch_natal_chart(birth_info)` - è°ƒç”¨å¤–éƒ¨æ˜Ÿç›˜APIè·å–æœ¬å‘½ç›˜æ•°æ®
- `format_chart_data_to_text(chart_data, user_info)` - å°†æ˜Ÿç›˜æ•°æ®æ ¼å¼åŒ–ä¸ºæ–‡å­—æè¿°
- `get_city_coordinates(city)` - è·å–åŸå¸‚ç»çº¬åº¦
- `get_current_zodiac_sign()` - è·å–å½“å‰æ—¶é—´å¯¹åº”çš„æ˜Ÿåº§

**æ˜Ÿç›˜APIé›†æˆï¼š**
```python
1. ä½¿ç”¨ httpx å¼‚æ­¥è°ƒç”¨å¤–éƒ¨æ˜Ÿç›˜API
2. ä¼ é€’ç”¨æˆ·å‡ºç”Ÿä¿¡æ¯ï¼ˆå¹´æœˆæ—¥æ—¶åˆ†ã€åŸå¸‚ï¼‰
3. åŸå¸‚åè½¬æ¢ä¸ºç»çº¬åº¦å’Œæ—¶åŒº
4. è·å–è¡Œæ˜Ÿä½ç½®ã€å®«ä½ã€æ˜Ÿåº§ç­‰ä¿¡æ¯
5. æ ¼å¼åŒ–ä¸ºæ˜“è¯»çš„æ–‡å­—æè¿°
```

**åŸå¸‚åæ ‡æ•°æ®ï¼š**
- å†…ç½®ä¸»è¦åŸå¸‚ï¼ˆåŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·ç­‰18ä¸ªåŸå¸‚ï¼‰çš„ç»çº¬åº¦å’Œæ—¶åŒº
- å¦‚æœåŸå¸‚ä¸åœ¨åˆ—è¡¨ï¼Œä½¿ç”¨åŒ—äº¬ä½œä¸ºé»˜è®¤å€¼
- æœªæ¥å¯æ‰©å±•ä¸ºå®Œæ•´çš„åœ°ç†ç¼–ç æœåŠ¡

**æ˜Ÿç›˜æ•°æ®æ ¼å¼åŒ–ï¼š**
- åŸºæœ¬ä¿¡æ¯ï¼šå‡ºç”Ÿæ—¥æœŸã€æ—¶é—´ã€åœ°ç‚¹
- è¡Œæ˜Ÿè½åº§ï¼šå¤ªé˜³ã€æœˆäº®ã€æ°´æ˜Ÿç­‰10é¢—è¡Œæ˜Ÿçš„æ˜Ÿåº§å’Œå®«ä½
- å››è½´ç‚¹ï¼šä¸Šå‡ç‚¹(ASC)ã€å¤©åº•(IC)ã€ä¸‹é™ç‚¹(DSC)ã€å¤©é¡¶(MC)

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨å¤–éƒ¨æ˜Ÿç›˜APIï¼ˆhttp://www.xingpan.vipï¼‰
- Access Token é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®
- å¼‚æ­¥HTTPè¯·æ±‚ï¼Œè®¾ç½®30ç§’è¶…æ—¶
- é”™è¯¯å¤„ç†ï¼šAPIå¤±è´¥è¿”å›Noneï¼Œç”±è°ƒç”¨æ–¹å¤„ç†

#### 1.8 å¡”ç½—ç‰ŒæœåŠ¡å±‚ (services/tarot_service.py)

**åŠŸèƒ½ï¼š** å¤„ç†å¡”ç½—ç‰ŒæŠ½ç‰Œé€»è¾‘

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `draw_cards(draw_request)` - æŠ½å–å¡”ç½—ç‰Œ
- `get_all_cards()` - è·å–æ‰€æœ‰å¡”ç½—ç‰Œåç§°
- `get_card_name(card_id)` - æ ¹æ®IDè·å–ç‰Œå

**æŠ½ç‰Œç®—æ³•ï¼š**
```python
1. ç”Ÿæˆ0-77çš„å®Œæ•´ç‰Œç»„ï¼ˆ78å¼ ï¼‰
2. ä½¿ç”¨ random.shuffle æ´—ç‰Œ
3. æŠ½å–å‰ N å¼ ç‰Œ
4. æ¯å¼ ç‰Œæœ‰30%æ¦‚ç‡é€†ä½
5. è¿”å› TarotCard å¯¹è±¡åˆ—è¡¨
```

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ Python å†…ç½® random æ¨¡å—å®ç°éšæœºæŠ½ç‰Œ
- ç‰Œ ID ä» 0-77 å¯¹åº” TAROT_CARDS åˆ—è¡¨
- é€†ä½æ¦‚ç‡è®¾ç½®ä¸º 30%ï¼Œç¬¦åˆå¡”ç½—å åœæƒ¯ä¾‹
- æŠ½ç‰Œç»“æœåŒ…å«ç‰Œ IDã€ç‰Œåã€é€†ä½çŠ¶æ€

### 2. API è·¯ç”±å±‚

#### 2.1 ç”¨æˆ·è·¯ç”± (routers/users.py)

**ç«¯ç‚¹ï¼š**
- `POST /api/users/guest` - åˆ›å»ºæ¸¸å®¢ç”¨æˆ·
- `POST /api/users/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /api/users/login` - ç”¨æˆ·ç™»å½•
- `GET /api/users/{user_id}` - è·å–ç”¨æˆ·ä¿¡æ¯
- `PUT /api/users/{user_id}/profile` - æ›´æ–°ç”¨æˆ·èµ„æ–™

**è°ƒç”¨æµç¨‹ï¼š**
```
POST /api/users/register
  â†’ UserService.create_registered_user
  â†’ UserService.hash_password
  â†’ StorageService.save_user
  â†’ è¿”å› Userï¼ˆä¸åŒ…å«å¯†ç å“ˆå¸Œï¼‰
```

**è®¾è®¡æœºåˆ¶ï¼š**
- æ‰€æœ‰è¿”å›çš„ User å¯¹è±¡éƒ½ä¸åŒ…å« password_hashï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
- ä½¿ç”¨ HTTPException ç»Ÿä¸€é”™è¯¯å¤„ç†
- ç™»å½•å¤±è´¥è¿”å› 401 çŠ¶æ€ç 
- ç”¨æˆ·ä¸å­˜åœ¨è¿”å› 404 çŠ¶æ€ç 

#### 2.2 å¯¹è¯è·¯ç”± (routers/conversations.py)

**ç«¯ç‚¹ï¼š**
- `POST /api/conversations?user_id={user_id}` - åˆ›å»ºæ–°å¯¹è¯
- `GET /api/conversations/{conversation_id}` - è·å–å¯¹è¯è¯¦æƒ…
- `GET /api/conversations/user/{user_id}` - è·å–ç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯
- `PUT /api/conversations/title` - æ›´æ–°å¯¹è¯æ ‡é¢˜
- `DELETE /api/conversations/{conversation_id}` - åˆ é™¤å¯¹è¯

**è°ƒç”¨æµç¨‹ï¼š**
```
POST /api/conversations
  â†’ ConversationService.create_conversation
  â†’ StorageService.save_conversation
  â†’ è¿”å› Conversation
```

**è®¾è®¡æœºåˆ¶ï¼š**
- åˆ›å»ºå¯¹è¯æ—¶é€šè¿‡ query å‚æ•°ä¼ é€’ user_id
- è·å–ç”¨æˆ·å¯¹è¯æ—¶æŒ‰ updated_at å€’åºæ’åº
- åˆ é™¤å¯¹è¯è¿”å›æˆåŠŸæ¶ˆæ¯

#### 2.3 å¡”ç½—è·¯ç”± (routers/tarot.py)

**ç«¯ç‚¹ï¼š**
- `POST /api/tarot/message` - å‘é€æ¶ˆæ¯å¹¶è·å–AIæµå¼å›å¤ï¼ˆå¡”ç½—å åœï¼Œæ”¯æŒFunction Callingï¼‰
- `POST /api/tarot/draw?conversation_id={id}` - æŠ½å–å¡”ç½—ç‰Œï¼ˆä¿ç•™ç”¨äºæ‰‹åŠ¨æŠ½ç‰Œï¼‰
- `GET /api/tarot/cards` - è·å–æ‰€æœ‰å¡”ç½—ç‰Œ

#### 2.4 æ˜Ÿç›˜è·¯ç”± (routers/astrology.py)

**ç«¯ç‚¹ï¼š**
- `POST /api/astrology/message` - å‘é€æ¶ˆæ¯å¹¶è·å–AIæµå¼å›å¤ï¼ˆæ˜Ÿç›˜è§£è¯»ï¼Œæ”¯æŒFunction Callingï¼‰
- `POST /api/astrology/draw?conversation_id={id}` - æŠ½å–å¡”ç½—ç‰Œï¼ˆæ˜Ÿåº§AIè¾…åŠ©è§£è¯»ç”¨ï¼‰
- `POST /api/astrology/fetch-chart?conversation_id={id}` - è·å–ç”¨æˆ·æ˜Ÿç›˜æ•°æ®ï¼ˆä¿ç•™ç”¨äºæ‰‹åŠ¨è·å–ï¼‰
- `GET /api/astrology/check-profile/{user_id}` - æ£€æŸ¥ç”¨æˆ·æ˜Ÿç›˜èµ„æ–™å®Œæ•´æ€§
- `GET /api/astrology/current-zodiac` - è·å–å½“å‰æ—¶é—´å¯¹åº”çš„æ˜Ÿåº§

**æ ¸å¿ƒåŠŸèƒ½ - Agent Loopæµå¼æ¶ˆæ¯ï¼ˆæ”¯æŒFunction Callingï¼‰ï¼š**

```python
POST /api/tarot/message (æ–°æ¶æ„)
  1. è·å–å¯¹è¯å’Œç”¨æˆ·ä¿¡æ¯
  2. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  3. è°ƒç”¨ GeminiService.stream_responseï¼ˆè¿”å›äº‹ä»¶æµï¼‰
  4. å¤„ç†äº‹ä»¶æµï¼š
     a. {"content": "..."} - æµå¼è¾“å‡ºæ–‡æœ¬
     b. {"function_call": {...}} - æ£€æµ‹åˆ°å‡½æ•°è°ƒç”¨
        â†’ æ‰§è¡Œå¯¹åº”çš„å‡½æ•°ï¼ˆdraw_tarot_cardsï¼‰
        â†’ è°ƒç”¨ TarotService.draw_cards
        â†’ ä¿å­˜æŠ½ç‰Œç»“æœåˆ°å¯¹è¯ï¼ˆSYSTEMæ¶ˆæ¯ï¼‰
        â†’ è°ƒç”¨ GeminiService.continue_with_function_result
        â†’ æµå¼è¾“å‡ºAIçš„æœ€ç»ˆè§£è¯»
     c. {"done": True} - å¯¹è¯å®Œæˆ
  5. ä¿å­˜æ‰€æœ‰AIæ¶ˆæ¯

POST /api/astrology/message (æ–°æ¶æ„)
  1. è·å–å¯¹è¯å’Œç”¨æˆ·ä¿¡æ¯
  2. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  3. è°ƒç”¨ GeminiService.stream_responseï¼ˆè¿”å›äº‹ä»¶æµï¼‰
  4. å¤„ç†äº‹ä»¶æµï¼š
     a. {"content": "..."} - æµå¼è¾“å‡ºæ–‡æœ¬
     b. {"function_call": {...}} - æ£€æµ‹åˆ°å‡½æ•°è°ƒç”¨
        â†’ æ‰§è¡Œå¯¹åº”çš„å‡½æ•°ï¼š
           - get_astrology_chart: è·å–æ˜Ÿç›˜æ•°æ®
           - draw_tarot_cards: æŠ½å¡”ç½—ç‰Œï¼ˆè¾…åŠ©è§£è¯»ï¼‰
           - request_user_profile: è¯·æ±‚ç”¨æˆ·è¡¥å……èµ„æ–™
        â†’ è°ƒç”¨ GeminiService.continue_with_function_result
        â†’ æµå¼è¾“å‡ºAIçš„æœ€ç»ˆè§£è¯»
     c. {"done": True} - å¯¹è¯å®Œæˆ
  5. ä¿å­˜æ‰€æœ‰AIæ¶ˆæ¯

POST /api/astrology/draw (æŠ½ç‰Œæ¥å£)
  1. éªŒè¯å¯¹è¯å­˜åœ¨æ€§
  2. æ£€æŸ¥æ˜¯å¦å·²æŠ½è¿‡ç‰Œ
  3. è°ƒç”¨ TarotService.draw_cards æŠ½ç‰Œ
  4. ä¿å­˜æŠ½ç‰Œç»“æœåˆ°å¯¹è¯ï¼ˆSYSTEMæ¶ˆæ¯ï¼‰
  5. æ ‡è®°å·²æŠ½ç‰ŒçŠ¶æ€
  6. è¿”å›æŠ½ç‰Œç»“æœ
```

**æµå¼å“åº”æ ¼å¼ï¼ˆServer-Sent Eventsï¼‰ï¼š**
```
data: {"content": "æ–‡æœ¬å†…å®¹"}\n\n
data: {"draw_cards": {...}, "cards": [...]}\n\n  # å¡”ç½—æŠ½ç‰Œç»“æœ
data: {"need_profile": {...}}\n\n  # éœ€è¦è¡¥å……èµ„æ–™
data: [DONE]\n\n
```

**è°ƒç”¨æµç¨‹ï¼š**
```
POST /api/tarot/draw
  â†’ ConversationService.get_conversation
  â†’ æ£€æŸ¥ has_drawn_cards
  â†’ TarotService.draw_cards
  â†’ ConversationService.add_message (SYSTEM role)
  â†’ ConversationService.mark_cards_drawn
  â†’ è¿”å› DrawCardsResponse
```

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ StreamingResponse å®ç°æµå¼è¾“å‡º
- ä½¿ç”¨ SSEï¼ˆServer-Sent Eventsï¼‰åè®®
- æŠ½ç‰Œå‰æ£€æŸ¥ has_drawn_cards é˜²æ­¢é‡å¤æŠ½ç‰Œ
- æŠ½ç‰Œç»“æœä»¥ SYSTEM è§’è‰²ä¿å­˜ï¼Œä¸åœ¨å‰ç«¯æ˜¾ç¤º
- æŠ½ç‰ŒæŒ‡ä»¤ä» AI å›å¤ä¸­æå–å¹¶ç§»é™¤ï¼Œä¸æ˜¾ç¤ºç»™ç”¨æˆ·

### 3. ä¸»åº”ç”¨ (main.py)

**åŠŸèƒ½ï¼š** FastAPI åº”ç”¨å…¥å£

**é…ç½®ï¼š**
- CORS ä¸­é—´ä»¶ï¼ˆå…è®¸å‰ç«¯è·¨åŸŸè¯·æ±‚ï¼‰
- è·¯ç”±æ³¨å†Œï¼ˆusers, conversations, tarot, astrologyï¼‰
- å¥åº·æ£€æŸ¥ç«¯ç‚¹

**å¼€å‘ç¯å¢ƒ CORS/ä»£ç†æœºåˆ¶ï¼š**
- å‰ç«¯é€šè¿‡ Vite ä»£ç†å°†åŒæº `/api/*` è¯·æ±‚è½¬å‘åˆ°åç«¯ `http://localhost:8000`
- å‰ç«¯ `services/api.ts` é»˜è®¤ `API_BASE_URL = ''`ï¼Œä¼˜å…ˆä½¿ç”¨åŒæºï¼Œé¿å…é¢„æ£€è¯·æ±‚ 400 é—®é¢˜
- å¦‚éœ€ç»•è¿‡ä»£ç†ç›´è¿åç«¯ï¼Œå¯åœ¨ `.env` è®¾ç½® `VITE_API_URL`ï¼Œä¾‹å¦‚ `VITE_API_URL=http://localhost:8000`

**ç«¯ç‚¹ï¼š**
- `GET /` - æ ¹è·¯å¾„ï¼Œè¿”å›APIä¿¡æ¯
- `GET /health` - å¥åº·æ£€æŸ¥
- `GET /docs` - Swagger UI æ–‡æ¡£

---

## å‰ç«¯æ¶æ„è®¾è®¡

### 1. çŠ¶æ€ç®¡ç†

#### 1.1 è®¤è¯çŠ¶æ€ (stores/useAuthStore.ts)

**åŠŸèƒ½ï¼š** ç®¡ç†ç”¨æˆ·ç™»å½•çŠ¶æ€

**çŠ¶æ€ï¼š**
- `user: User | null` - å½“å‰ç™»å½•ç”¨æˆ·
- `setUser(user)` - è®¾ç½®ç”¨æˆ·
- `logout()` - é€€å‡ºç™»å½•

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ Zustand persist ä¸­é—´ä»¶æŒä¹…åŒ–åˆ° localStorage
- å­˜å‚¨é”®åä¸º `auth-storage`
- é€€å‡ºç™»å½•æ—¶æ¸…ç©ºç”¨æˆ·ä¿¡æ¯

#### 1.2 å¯¹è¯çŠ¶æ€ (stores/useConversationStore.ts)

**åŠŸèƒ½ï¼š** ç®¡ç†å¯¹è¯åˆ—è¡¨å’Œå½“å‰å¯¹è¯

**çŠ¶æ€ï¼š**
- `conversations: Conversation[]` - å¯¹è¯åˆ—è¡¨
- `currentConversation: Conversation | null` - å½“å‰å¯¹è¯
- `setConversations` - è®¾ç½®å¯¹è¯åˆ—è¡¨
- `setCurrentConversation` - è®¾ç½®å½“å‰å¯¹è¯
- `addConversation` - æ·»åŠ å¯¹è¯ï¼ˆæ’å…¥åˆ°åˆ—è¡¨å¤´éƒ¨ï¼‰
- `updateConversation` - æ›´æ–°å¯¹è¯
- `removeConversation` - ç§»é™¤å¯¹è¯

**è®¾è®¡æœºåˆ¶ï¼š**
- ä¸æŒä¹…åŒ–åˆ° localStorageï¼Œæ¯æ¬¡ç™»å½•åä»æœåŠ¡å™¨åŠ è½½
- æ·»åŠ å¯¹è¯æ—¶æ’å…¥åˆ°åˆ—è¡¨å¤´éƒ¨ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
- æ›´æ–°å¯¹è¯æ—¶åŒæ—¶æ›´æ–°åˆ—è¡¨å’Œå½“å‰å¯¹è¯ï¼ˆå¦‚æœåŒ¹é…ï¼‰
- `addMessageToCurrentConversation` - å°†å•ä¸ªæ¶ˆæ¯æ·»åŠ åˆ°å½“å‰å¯¹è¯ï¼ˆç”¨äºç«‹å³æ˜¾ç¤ºç”¨æˆ·è¾“å…¥ï¼‰

### 2. API æœåŠ¡å±‚ (services/api.ts)

#### 2.1 ç”¨æˆ· API (userApi)

**æ–¹æ³•ï¼š**
- `createGuest(profile)` - åˆ›å»ºæ¸¸å®¢
- `register(username, password, profile)` - æ³¨å†Œ
- `login(username, password)` - ç™»å½•
- `getUser(userId)` - è·å–ç”¨æˆ·ä¿¡æ¯
- `updateProfile(userId, profile)` - æ›´æ–°èµ„æ–™

#### 2.2 å¯¹è¯ API (conversationApi)

**æ–¹æ³•ï¼š**
- `create(userId, sessionType)` - åˆ›å»ºå¯¹è¯
- `get(conversationId)` - è·å–å¯¹è¯
- `getUserConversations(userId)` - è·å–ç”¨æˆ·å¯¹è¯åˆ—è¡¨
- `updateTitle(conversationId, title)` - æ›´æ–°æ ‡é¢˜
- `delete(conversationId)` - åˆ é™¤å¯¹è¯

#### 2.3 å¡”ç½— API (tarotApi)

**æ–¹æ³•ï¼š**
- `sendMessage(conversationId, content, onChunk, onDrawCards)` - å‘é€æ¶ˆæ¯
- `drawCards(conversationId, drawRequest)` - æŠ½ç‰Œ
- `getAllCards()` - è·å–æ‰€æœ‰å¡”ç½—ç‰Œ

**æµå¼æ¶ˆæ¯å¤„ç†ï¼š**
```javascript
sendMessage æµç¨‹ï¼š
1. ä½¿ç”¨ fetch API å‘é€è¯·æ±‚
2. è·å– response.body.getReader()
3. ä½¿ç”¨ TextDecoder è§£ç å­—èŠ‚æµ
4. æŒ‰è¡Œåˆ†å‰²ï¼Œè§£æ SSE æ ¼å¼
5. å¦‚æœæ˜¯ contentï¼Œè°ƒç”¨ onChunk å›è°ƒ
6. å¦‚æœæ˜¯ draw_cardsï¼Œè°ƒç”¨ onDrawCards å›è°ƒ
7. é‡åˆ° [DONE] ç»“æŸ
```

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ Axios å¤„ç†æ™®é€š HTTP è¯·æ±‚
- ä½¿ç”¨åŸç”Ÿ Fetch API å¤„ç†æµå¼è¯·æ±‚
- æµå¼æ¶ˆæ¯ä½¿ç”¨å›è°ƒå‡½æ•°å®æ—¶å¤„ç†æ•°æ®å—
- é”™è¯¯å¤„ç†ç»Ÿä¸€æŠ›å‡ºå¼‚å¸¸

### 3. UI ç»„ä»¶

#### 3.1 ä¾§è¾¹æ ç»„ä»¶ (Sidebar.tsx)

**åŠŸèƒ½ï¼š** æ˜¾ç¤ºå¯¹è¯åˆ—è¡¨å’ŒåŠŸèƒ½æŒ‰é’®

**Propsï¼š**
- `conversations` - å¯¹è¯åˆ—è¡¨
- `currentConversationId` - å½“å‰å¯¹è¯ID
- `onNewConversation` - æ–°å»ºå¯¹è¯å›è°ƒ
- `onSelectConversation` - é€‰æ‹©å¯¹è¯å›è°ƒ
- `onDeleteConversation` - åˆ é™¤å¯¹è¯å›è°ƒ
- `onOpenSettings` - æ‰“å¼€è®¾ç½®å›è°ƒ

**UI ç»“æ„ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [+ æ–°å åœ]      â”‚  <- Header
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¯¹è¯1 [åˆ é™¤]    â”‚
â”‚  å¯¹è¯2 [åˆ é™¤]    â”‚  <- å¯¹è¯åˆ—è¡¨ï¼ˆå¯æ»šåŠ¨ï¼‰
â”‚  å¯¹è¯3 [åˆ é™¤]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [âš™ï¸ è®¾ç½®]       â”‚  <- Footer
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’ï¼š**
- é¼ æ ‡æ‚¬åœæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
- å½“å‰å¯¹è¯é«˜äº®æ˜¾ç¤º
- å¯¹è¯æŒ‰æ›´æ–°æ—¶é—´æ’åº
- æ—¶é—´æ˜¾ç¤ºç›¸å¯¹æ—¶é—´ï¼ˆä»Šå¤©ã€æ˜¨å¤©ã€Nå¤©å‰ï¼‰

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ Framer Motion å®ç°è¿›å…¥åŠ¨ç”»
- ä½¿ç”¨ group-hover å®ç°æ‚¬åœæ•ˆæœ
- åˆ é™¤æ—¶é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼ˆstopPropagationï¼‰

#### 3.2 èŠå¤©æ¶ˆæ¯ç»„ä»¶ (ChatMessage.tsx)

**åŠŸèƒ½ï¼š** æ˜¾ç¤ºå•æ¡æ¶ˆæ¯

**Propsï¼š**
- `message: Message` - æ¶ˆæ¯å¯¹è±¡

**UI ç»“æ„ï¼š**
```
ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§ï¼‰:
[å¤´åƒ]  [æ¶ˆæ¯æ°”æ³¡]  [æ—¶é—´]

AIæ¶ˆæ¯ï¼ˆå·¦ä¾§ï¼‰:
[æ—¶é—´]  [æ¶ˆæ¯æ°”æ³¡]  [å¤´åƒ]

å¦‚æœæœ‰å¡”ç½—ç‰Œç»“æœï¼Œåœ¨æ¶ˆæ¯ä¸‹æ–¹æ˜¾ç¤ºï¼š
æŠ½åˆ°çš„ç‰Œï¼š
ä½ç½®1: ç‰Œå (æ­£/é€†ä½)
ä½ç½®2: ç‰Œå (æ­£/é€†ä½)
```

**è®¾è®¡æœºåˆ¶ï¼š**
- ç”¨æˆ·æ¶ˆæ¯ä½¿ç”¨ä¸»é¢˜è‰²èƒŒæ™¯ï¼ŒAIæ¶ˆæ¯ä½¿ç”¨æš—è‰²èƒŒæ™¯
- ä½¿ç”¨ Framer Motion å®ç°æ·¡å…¥åŠ¨ç”»
- ç³»ç»Ÿæ¶ˆæ¯ä¸æ˜¾ç¤ºï¼ˆrole === 'system'ï¼‰
- æ”¯æŒæ˜¾ç¤ºæŠ½ç‰Œç»“æœå’Œä½ç½®å«ä¹‰

#### 3.3 èŠå¤©è¾“å…¥ç»„ä»¶ (ChatInput.tsx)

**åŠŸèƒ½ï¼š** æ¶ˆæ¯è¾“å…¥æ¡†

**Propsï¼š**
- `onSend(message)` - å‘é€æ¶ˆæ¯å›è°ƒ
- `disabled` - æ˜¯å¦ç¦ç”¨
- `placeholder` - å ä½ç¬¦æ–‡æœ¬

**äº¤äº’ï¼š**
- å›è½¦é”®å‘é€æ¶ˆæ¯
- å‘é€æŒ‰é’®åŠ¨ç”»æ•ˆæœï¼ˆhover æ”¾å¤§ï¼Œtap ç¼©å°ï¼‰
- å‘é€åè‡ªåŠ¨æ¸…ç©ºè¾“å…¥æ¡†
- ç¦ç”¨æ—¶æ˜¾ç¤ºä¸å¯ç”¨çŠ¶æ€

#### 3.4 å¿«æ·å›å¤ç»„ä»¶ (QuickReplies.tsx)

**åŠŸèƒ½ï¼š** åœ¨è¾“å…¥æ¡†ä¸Šæ–¹æ˜¾ç¤ºé¢„è®¾çš„å¿«æ·å›å¤è¯è¯­ï¼Œç”¨æˆ·ç‚¹å‡»åè‡ªåŠ¨å‘é€

**Propsï¼š**
- `conversationType: SessionType` - ä¼šè¯ç±»å‹ï¼ˆtarot/astrologyï¼‰
- `onReplyClick(text)` - ç‚¹å‡»å›å¤å›è°ƒ

**é¢„è®¾è¯è¯­ï¼š**

**å¡”ç½—å åœï¼ˆ10ä¸ªï¼‰ï¼š**
1. ç¡®å®æ˜¯è¿™æ ·ï¼Œä½ ç»§ç»­è¯´
2. å¥½åƒæ˜¯æœ‰ç‚¹è¿™ç§æ„Ÿè§‰
3. æˆ‘å¯ä»¥é—®ä»€ä¹ˆé—®é¢˜ï¼Ÿ
4. å¡”ç½—ç®—å¾—å‡†å—ï¼Ÿ
5. ä½ æœ€æ“…é•¿ä»€ä¹ˆé—®é¢˜ï¼Ÿ
6. çœ‹çœ‹æˆ‘ä¸‹åŠå¹´çš„æ„Ÿæƒ…è¿åŠ¿
7. æˆ‘ä¸‹ä¸ªæœˆçš„äº‹ä¸šè¿æ€ä¹ˆæ ·ï¼Ÿ
8. å¸®æˆ‘çœ‹çœ‹æœ€è¿‘çš„è¿åŠ¿
9. æˆ‘è¯¥æ€ä¹ˆåšå†³å®šï¼Ÿ
10. èƒ½å†è¯¦ç»†è§£é‡Šä¸€ä¸‹å—ï¼Ÿ

**æ˜Ÿåº§å åœï¼ˆ10ä¸ªï¼‰ï¼š**
1. ç¡®å®æ˜¯è¿™æ ·ï¼Œä½ ç»§ç»­è¯´
2. å¥½åƒæ˜¯æœ‰ç‚¹è¿™ç§æ„Ÿè§‰
3. æˆ‘å¯ä»¥é—®ä»€ä¹ˆé—®é¢˜ï¼Ÿ
4. æ˜Ÿç›˜æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿå‡†å—ï¼Ÿ
5. ä½ æœ€æ“…é•¿ä»€ä¹ˆé—®é¢˜ï¼Ÿ
6. çœ‹çœ‹æˆ‘ä¸‹åŠå¹´çš„æ„Ÿæƒ…è¿åŠ¿
7. æˆ‘ä¸‹ä¸ªæœˆçš„äº‹ä¸šè¿æ€ä¹ˆæ ·ï¼Ÿ
8. åˆ†æä¸€ä¸‹æˆ‘çš„æ€§æ ¼ç‰¹ç‚¹
9. æˆ‘å’Œä»€ä¹ˆæ˜Ÿåº§æœ€é…ï¼Ÿ
10. èƒ½å†è¯¦ç»†è§£é‡Šä¸€ä¸‹å—ï¼Ÿ

**UI æ ·å¼ï¼š**
- æ‚¬æµ®çª—å£æ ·å¼ï¼ˆç™½è‰²åŠé€æ˜èƒŒæ™¯ï¼Œé˜´å½±æ•ˆæœï¼‰
- åœ†è§’èƒ¶å›ŠæŒ‰é’®
- hover æ—¶æ”¾å¤§å¹¶åŠ æ·±è¾¹æ¡†é¢œè‰²
- æ°´å¹³æ’åˆ—ï¼Œè‡ªåŠ¨æ¢è¡Œ

**è®¾è®¡æœºåˆ¶ï¼š**
- æ ¹æ®ä¼šè¯ç±»å‹è‡ªåŠ¨æ˜¾ç¤ºå¯¹åº”çš„é¢„è®¾è¯è¯­
- ç‚¹å‡»åç›´æ¥è°ƒç”¨ `onReplyClick` å‘é€æ¶ˆæ¯
- ä½¿ç”¨ Tailwind CSS å®ç°å“åº”å¼å¸ƒå±€å’ŒåŠ¨ç”»æ•ˆæœ
- æ¯ä¸ªæŒ‰é’®æ˜¾ç¤ºå®Œæ•´æ–‡æœ¬ï¼Œé¼ æ ‡æ‚¬åœæ—¶æœ‰ tooltip

#### 3.5 ä¼šè¯æŒ‰é’®ç»„ä»¶ (SessionButtons.tsx)

**åŠŸèƒ½ï¼š** é€‰æ‹©ä¼šè¯ç±»å‹ï¼ˆå¡”ç½—ã€æ˜Ÿç›˜ã€èŠæ„ˆï¼‰

**Propsï¼š**
- `onSelectSession(sessionType)` - é€‰æ‹©ä¼šè¯å›è°ƒ
- `disabled` - æ˜¯å¦ç¦ç”¨

**UI ç»“æ„ï¼š**
```
[å¡”ç½—å åœ]  [æ˜Ÿç›˜è§£è¯»]  [èŠæ„ˆ]
    âœ¨         â­        ğŸ’¬
```

**è®¾è®¡æœºåˆ¶ï¼š**
- æ¯ä¸ªæŒ‰é’®æœ‰ç‹¬ç‰¹çš„æ¸å˜è‰²
- hover æ—¶æ”¾å¤§å¹¶ä¸Šç§»
- æ˜Ÿç›˜å’ŒèŠæ„ˆæ ‡è®°ä¸º"å³å°†æ¨å‡º"
- å³å°†æ¨å‡ºçš„æŒ‰é’®ç¦ç”¨å¹¶æ˜¾ç¤ºæç¤º

#### 3.6 å¡”ç½—ç‰ŒæŠ½ç‰Œå™¨ç»„ä»¶ (TarotCardDrawer.tsx)

**åŠŸèƒ½ï¼š** å¡”ç½—ç‰ŒæŠ½ç‰ŒåŠ¨ç”»å’Œäº¤äº’

**Propsï¼š**
- `isOpen` - æ˜¯å¦æ‰“å¼€
- `drawRequest` - æŠ½ç‰Œè¯·æ±‚
- `onClose` - å…³é—­å›è°ƒ
- `onCardsDrawn(cards)` - æŠ½ç‰Œå®Œæˆå›è°ƒ

**äº¤äº’æµç¨‹ï¼š**
```
1. æ‰“å¼€å¼¹çª— â†’ æ˜¾ç¤º"å¼€å§‹æ´—ç‰Œ"æŒ‰é’®
2. ç‚¹å‡»æ´—ç‰Œ â†’ æ’­æ”¾æ´—ç‰ŒåŠ¨ç”»ï¼ˆ2ç§’ï¼‰
3. æ´—ç‰Œå®Œæˆ â†’ ç‰Œä»¥æ‰‡å½¢å±•å¼€
4. ç”¨æˆ·ç‚¹å‡»ç‰Œ â†’ ç‰Œè¢«é€‰ä¸­å¹¶é«˜äº®
5. é€‰å¤ŸæŒ‡å®šæ•°é‡ â†’ æ˜¾ç¤º"ç¡®è®¤æŠ½ç‰Œ"æŒ‰é’®
6. ç¡®è®¤æŠ½ç‰Œ â†’ ç‰Œç§»åŠ¨åˆ°é¡¶éƒ¨å¡æ§½
7. å»¶è¿Ÿ1.5ç§’ â†’ å…³é—­å¹¶è¿”å›ç»“æœ
```

**UI ç»“æ„ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŠ½å–å¡”ç½—ç‰Œ            [X]    â”‚  <- Header
â”‚  è¯·é€‰æ‹©3å¼ ç‰Œ (å·²é€‰2å¼ )        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å¡æ§½1] [å¡æ§½2] [å¡æ§½3]      â”‚  <- é¡¶éƒ¨å¡æ§½
â”‚                              â”‚
â”‚       ğŸ´ğŸ´ğŸ´ğŸ´ğŸ´              â”‚  <- æ‰‡å½¢å±•å¼€çš„ç‰Œ
â”‚      ğŸ´       ğŸ´             â”‚
â”‚     ğŸ´         ğŸ´            â”‚
â”‚                              â”‚
â”‚     [ç¡®è®¤æŠ½ç‰Œ]               â”‚  <- ç¡®è®¤æŒ‰é’®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ´—ç‰ŒåŠ¨ç”»ï¼š**
- 10å¼ ç‰Œåœ¨ä¸­å¿ƒæ—‹è½¬ã€ç¼©æ”¾ã€ç§»åŠ¨
- æ¯å¼ ç‰Œæœ‰ä¸åŒçš„å»¶è¿Ÿå’Œè·¯å¾„

**æ‰‡å½¢å±•å¼€ç®—æ³•ï¼š**
```javascript
78å¼ ç‰Œæ’åˆ—æˆ180åº¦æ‰‡å½¢ï¼š
- è§’åº¦èŒƒå›´ï¼š-90Â° ~ 90Â°
- åŠå¾„ï¼š400px
- Yè½´å‹ç¼©ï¼š0.6å€ï¼ˆæ¤­åœ†æ•ˆæœï¼‰
- æ¯å¼ ç‰Œæ—‹è½¬ï¼šangle + 90Â°
```

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ Framer Motion å®ç°æ‰€æœ‰åŠ¨ç”»
- ç‚¹å‡»èƒŒæ™¯å…³é—­ï¼ˆæ´—ç‰Œæ—¶ç¦ç”¨ï¼‰
- é€‰ä¸­çš„ç‰Œæ”¾å¤§å¹¶ä¸Šç§»
- ä½¿ç”¨åŠé€æ˜é»‘è‰²èƒŒæ™¯+æ¨¡ç³Šæ•ˆæœ
- å¡æ§½æ˜¾ç¤ºä½ç½®åç§°æˆ–åºå·

#### 3.7 æ˜Ÿç›˜èµ„æ–™å¡«å†™å¼¹çª—ç»„ä»¶ (AstrologyProfileModal.tsx)

**åŠŸèƒ½ï¼š** ç”¨æˆ·å¡«å†™æ˜Ÿç›˜æ‰€éœ€çš„å‡ºç”Ÿèµ„æ–™

**Propsï¼š**
- `isOpen` - æ˜¯å¦æ‰“å¼€
- `currentProfile` - å½“å‰ç”¨æˆ·èµ„æ–™
- `onClose` - å…³é—­å›è°ƒ
- `onSubmit(profile)` - æäº¤èµ„æ–™å›è°ƒ
- `onSkip()` - è·³è¿‡å¡«å†™å›è°ƒ

**UI ç»“æ„ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®Œå–„æ˜Ÿç›˜èµ„æ–™            [X]  â”‚  <- Header
â”‚  æä¾›å‡†ç¡®çš„å‡ºç”Ÿä¿¡æ¯...        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ€§åˆ«ï¼š[ç”·] [å¥³] [å…¶ä»–] [ä¿å¯†]â”‚
â”‚                              â”‚
â”‚  å‡ºç”Ÿæ—¥æœŸï¼š*                 â”‚
â”‚  [å¹´ä»½â–¼] [æœˆä»½â–¼] [æ—¥æœŸâ–¼]     â”‚
â”‚                              â”‚
â”‚  å‡ºç”Ÿæ—¶é—´ï¼š*                 â”‚
â”‚  [å°æ—¶â–¼] [åˆ†é’Ÿâ–¼]             â”‚
â”‚  å‡†ç¡®çš„å‡ºç”Ÿæ—¶é—´å¯¹æ˜Ÿç›˜è§£è¯»å¾ˆé‡è¦â”‚
â”‚                              â”‚
â”‚  å‡ºç”ŸåŸå¸‚ï¼š*                 â”‚
â”‚  [è¯·é€‰æ‹©åŸå¸‚â–¼]               â”‚
â”‚  åŒ—äº¬ã€ä¸Šæµ·ã€å¹¿å·...         â”‚
â”‚                              â”‚
â”‚  [ä¿å­˜å¹¶ç»§ç»­] [æš‚æ—¶è·³è¿‡]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’ï¼š**
- æ€§åˆ«ä¸ºå¯é€‰é¡¹ï¼Œå…¶ä»–ä¸ºå¿…å¡«é¡¹
- å¹´ä»½èŒƒå›´ï¼š1950-2024
- æ—¶é—´ï¼š0-23å°æ—¶ï¼Œ0-59åˆ†é’Ÿ
- åŸå¸‚ï¼š18ä¸ªä¸»è¦åŸå¸‚ä¸‹æ‹‰é€‰æ‹©
- æäº¤å‰éªŒè¯å¿…å¡«é¡¹
- è·³è¿‡åè¿›å…¥æ— èµ„æ–™æ¨¡å¼

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ä¸‹æ‹‰é€‰æ‹©å™¨ç®€åŒ–è¾“å…¥
- æ—¥æœŸå’Œæ—¶é—´ä½¿ç”¨æ•°å­—é€‰æ‹©å™¨
- åŸå¸‚åˆ—è¡¨ä¸åç«¯ä¿æŒä¸€è‡´
- è¡¨å•éªŒè¯æç¤ºå‹å¥½

#### 3.8 è®¤è¯å¼¹çª—ç»„ä»¶ (AuthModal.tsx)

**åŠŸèƒ½ï¼š** ç”¨æˆ·ç™»å½•/æ³¨å†Œ

**Propsï¼š**
- `isOpen` - æ˜¯å¦æ‰“å¼€
- `onClose` - å…³é—­å›è°ƒ
- `onGuestLogin(profile)` - æ¸¸å®¢ç™»å½•å›è°ƒ
- `onRegister(username, password, profile)` - æ³¨å†Œå›è°ƒ
- `onLogin(username, password)` - ç™»å½•å›è°ƒ

**æ¨¡å¼åˆ‡æ¢ï¼š**
```
choice (é€‰æ‹©) â†’ guest (æ¸¸å®¢)
             â†’ register (æ³¨å†Œ)
             â†’ login (ç™»å½•)
```

**UI ç»“æ„ï¼ˆé€‰æ‹©æ¨¡å¼ï¼‰ï¼š**
```
æ¬¢è¿æ¥åˆ°å¡”ç½—å åœ

[æ¸¸å®¢æ¨¡å¼]
 å¿«é€Ÿå¼€å§‹ï¼Œä½†ä¸ä¿å­˜å†å²è®°å½•

[æ³¨å†Œè´¦å·]
 ä¿å­˜å†å²è®°å½•ï¼Œéšæ—¶æŸ¥çœ‹

[å·²æœ‰è´¦å·ï¼Ÿç«‹å³ç™»å½•]
```

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨çŠ¶æ€æœºç®¡ç†æ¨¡å¼åˆ‡æ¢
- æ¸¸å®¢æ¨¡å¼å¯å¡«å†™æ˜µç§°ï¼ˆå¯é€‰ï¼‰
- æ³¨å†Œ/ç™»å½•éœ€è¦ç”¨æˆ·åå’Œå¯†ç 
- ä½¿ç”¨å›¾æ ‡å¢å¼ºè¾“å…¥æ¡†è§†è§‰æ•ˆæœ
- è¡¨å•æäº¤åè‡ªåŠ¨å…³é—­å¼¹çª—

### 4. ä¸»åº”ç”¨ (App.tsx)

**åŠŸèƒ½ï¼š** åº”ç”¨ä¸»å…¥å£ï¼Œæ•´åˆæ‰€æœ‰ç»„ä»¶å’Œé€»è¾‘

**çŠ¶æ€ï¼š**
- `showAuthModal` - æ˜¯å¦æ˜¾ç¤ºè®¤è¯å¼¹çª—
- `showSettings` - æ˜¯å¦æ˜¾ç¤ºè®¾ç½®
- `isLoading` - æ˜¯å¦åŠ è½½ä¸­
- `streamingMessage` - æµå¼è¾“å‡ºçš„æ¶ˆæ¯
- `showCardDrawer` - æ˜¯å¦æ˜¾ç¤ºæŠ½ç‰Œå™¨
- `pendingDrawRequest` - å¾…å¤„ç†çš„æŠ½ç‰Œè¯·æ±‚

**ç”Ÿå‘½å‘¨æœŸï¼š**
```
1. ç»„ä»¶æŒ‚è½½ â†’ æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
   - æœªç™»å½• â†’ æ˜¾ç¤ºè®¤è¯å¼¹çª—
   - å·²ç™»å½• â†’ åŠ è½½ç”¨æˆ·å¯¹è¯åˆ—è¡¨

2. ç”¨æˆ·ç™»å½•æˆåŠŸ â†’ åŠ è½½å¯¹è¯åˆ—è¡¨ â†’ éšè—è®¤è¯å¼¹çª—

3. é€‰æ‹©ä¼šè¯ç±»å‹ â†’ åˆ›å»ºæ–°å¯¹è¯ â†’ è‡ªåŠ¨å‘é€åˆå§‹æ¶ˆæ¯

4. ç”¨æˆ·å‘é€æ¶ˆæ¯ â†’ æµå¼æ¥æ”¶AIå›å¤ â†’ æ£€æµ‹æŠ½ç‰ŒæŒ‡ä»¤
   - æœ‰æŠ½ç‰ŒæŒ‡ä»¤ â†’ æ‰“å¼€æŠ½ç‰Œå™¨
   - æ— æŠ½ç‰ŒæŒ‡ä»¤ â†’ æ­£å¸¸æ˜¾ç¤ºå›å¤

5. ç”¨æˆ·æŠ½ç‰Œ â†’ ä¿å­˜æŠ½ç‰Œç»“æœ â†’ è‡ªåŠ¨å‘é€è§£è¯»è¯·æ±‚

6. æ¶ˆæ¯æ›´æ–° â†’ è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
```

**æ ¸å¿ƒæ–¹æ³•ï¼š**

**handleSelectSession(sessionType):**
```
1. åˆ›å»ºæ–°å¯¹è¯ï¼ˆAPI è°ƒç”¨ï¼‰
2. æ·»åŠ åˆ°å¯¹è¯åˆ—è¡¨
3. è®¾ç½®ä¸ºå½“å‰å¯¹è¯ï¼ˆReact çŠ¶æ€æ›´æ–°ï¼‰
4. å¦‚æœæ˜¯å¡”ç½—å åœï¼š
   a. éšæœºé€‰æ‹©ä¸€ç§å¼€åœºç™½ï¼ˆ5ç§ï¼‰
   b. ç›´æ¥ä½¿ç”¨ newConv.conversation_id å‘é€æ¶ˆæ¯
   c. è®¾ç½® loading çŠ¶æ€
   d. è°ƒç”¨ tarotApi.sendMessageï¼ˆæµå¼æ¥æ”¶ï¼‰
   e. åˆ·æ–°å¯¹è¯å¹¶æ›´æ–°çŠ¶æ€
```

**é‡è¦**ï¼šç›´æ¥ä½¿ç”¨ `newConv.conversation_id` è€Œä¸æ˜¯ä¾èµ– `currentConversation` çŠ¶æ€ï¼Œé¿å… JavaScript é—­åŒ…æ•è·æ—§çŠ¶æ€çš„é—®é¢˜ã€‚è¿™æ˜¯å¤„ç† React å¼‚æ­¥çŠ¶æ€æ›´æ–°çš„æ­£ç¡®æ–¹å¼ã€‚

**handleSendMessage(content):**
```
1. ç«‹å³å°†ç”¨æˆ·æ¶ˆæ¯æ·»åŠ åˆ°å¯¹è¯ä¸­ï¼ˆç”¨æˆ·è¾“å…¥ç«‹å³æ˜¾ç¤ºï¼‰
   - åˆ›å»º Message å¯¹è±¡ï¼Œrole='user'
   - è°ƒç”¨ addMessageToCurrentConversation å°†æ¶ˆæ¯åŠ å…¥æœ¬åœ°çŠ¶æ€
   - æ— éœ€ç­‰å¾… API å“åº”
2. è®¾ç½®åŠ è½½çŠ¶æ€
3. è°ƒç”¨ tarotApi.sendMessage æˆ– astrologyApi.sendMessage
4. å®æ—¶æ¥æ”¶æ–‡æœ¬å— â†’ æ›´æ–° streamingMessage
5. æ¥æ”¶åˆ°æŒ‡ä»¤ï¼ˆæŠ½ç‰Œã€è·å–èµ„æ–™ã€è·å–æ˜Ÿç›˜ç­‰ï¼‰ â†’ è§¦å‘å¯¹åº”å¤„ç†
6. æµå¼ç»“æŸ â†’ åˆ·æ–°å¯¹è¯ â†’ æ¸…ç©º streamingMessage
```

**è®¾è®¡æœºåˆ¶ï¼š**
- **ç«‹å³æ˜¾ç¤ºåŸåˆ™**ï¼šç”¨æˆ·çš„è¾“å…¥åœ¨æŒ‰ä¸‹å‘é€æŒ‰é’®åç«‹å³æ˜¾ç¤ºï¼Œä¸é˜»å¡äº AI å“åº”
- **æœ¬åœ°çŠ¶æ€ä¼˜å…ˆ**ï¼šä½¿ç”¨ `addMessageToCurrentConversation` æ–¹æ³•ç›´æ¥ä¿®æ”¹ Zustand çŠ¶æ€
- **æœåŠ¡ç«¯åŒæ­¥**ï¼šåç»­ `conversationApi.get()` åˆ·æ–°ç¡®ä¿ä¸æœåŠ¡ç«¯æ•°æ®ä¿æŒä¸€è‡´
- æå‡ç”¨æˆ·ä½“éªŒï¼šåé¦ˆè¿…é€Ÿï¼Œå³ä½¿ AI å“åº”è¾ƒæ…¢ä¹Ÿä¸ä¼šå½±å“æ¶ˆæ¯æ˜¾ç¤º

**handleCardsDrawn(cards):**
```
1. è°ƒç”¨ tarotApi.drawCards ä¿å­˜æŠ½ç‰Œç»“æœï¼ˆSYSTEM æ¶ˆæ¯ï¼‰
2. æ ‡è®° has_drawn_cards = trueï¼ˆé˜²æ­¢é‡å¤æŠ½ç‰Œï¼‰
3. åˆ·æ–°å¯¹è¯
4. æ¸…ç©º pendingDrawRequest
5. å»¶è¿Ÿ0.5ç§’åè‡ªåŠ¨å‘é€"è¯·æ ¹æ®æŠ½ç‰Œç»“æœè¿›è¡Œè§£è¯»"ï¼ˆUSER æ¶ˆæ¯ï¼Œç•Œé¢ä¸æ˜¾ç¤ºï¼‰
6. è§¦å‘ AI æµå¼è§£è¯»
7. åç«¯æ£€æµ‹åˆ°"è¯·æ ¹æ®æŠ½ç‰Œç»“æœè¿›è¡Œè§£è¯»"æ¶ˆæ¯ï¼Œåœ¨AIå›å¤æ—¶é™„åŠ  tarot_cards æ•°æ®
8. å‰ç«¯æ¸²æŸ“å¸¦æœ‰æŠ½ç‰Œç»“æœçš„AIæ¶ˆæ¯ï¼Œæ˜¾ç¤ºç¾åŒ–çš„å¡ç‰ŒUI
```

**æŠ½ç‰Œç»“æœæ˜¾ç¤ºæœºåˆ¶ï¼š**
- åç«¯åœ¨ä¿å­˜AIè§£è¯»æ¶ˆæ¯æ—¶ï¼Œæ£€æµ‹ç”¨æˆ·æœ€åä¸€æ¡æ¶ˆæ¯æ˜¯å¦ä¸º"è¯·æ ¹æ®æŠ½ç‰Œç»“æœè¿›è¡Œè§£è¯»"
- å¦‚æœæ˜¯ï¼Œä»å¯¹è¯å†å²ä¸­è·å–æœ€è¿‘çš„æŠ½ç‰Œç»“æœï¼ˆé€šè¿‡ `get_latest_tarot_cards()`ï¼‰
- å°†æŠ½ç‰Œç»“æœé™„åŠ åˆ°AIæ¶ˆæ¯çš„ `tarot_cards` å’Œ `draw_request` å­—æ®µ
- å‰ç«¯ ChatMessage ç»„ä»¶æ£€æµ‹åˆ°æ¶ˆæ¯åŒ…å« `tarot_cards` å­—æ®µæ—¶ï¼Œæ¸²æŸ“ç¾åŒ–çš„å¡ç‰ŒUI
- æ¯å¼ å¡ç‰‡æ˜¾ç¤ºï¼šæ¸å˜è‰²èƒŒæ™¯ã€å¡ç‰Œåç§°ã€æ­£é€†ä½æ ‡è®°ã€ä½ç½®æ ‡ç­¾ï¼ˆå¦‚"è¿‡å»"ã€"ç°åœ¨"ã€"æœªæ¥"ï¼‰
- æ­£ä½å¡ç‰‡ä½¿ç”¨ç´«ç²‰æ¸å˜ï¼ˆfrom-purple-500 to-pink-600ï¼‰ï¼Œé€†ä½å¡ç‰‡ä½¿ç”¨é›ç´«æ¸å˜ï¼ˆfrom-indigo-600 to-purple-700ï¼‰
- é¼ æ ‡æ‚¬åœæ—¶å¡ç‰‡æ”¾å¤§ï¼Œå¢å¼ºäº¤äº’ä½“éªŒ

**UI å¸ƒå±€ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Sidebar]  â”‚  [Main Content]           â”‚
â”‚            â”‚                            â”‚
â”‚ å¯¹è¯åˆ—è¡¨    â”‚  æ¬¢è¿é¡µé¢                  â”‚
â”‚            â”‚  æˆ–                        â”‚
â”‚            â”‚  èŠå¤©ç•Œé¢                  â”‚
â”‚            â”‚                            â”‚
â”‚ [è®¾ç½®]     â”‚  [è¾“å…¥æ¡†]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡æœºåˆ¶ï¼š**
- æ— å½“å‰å¯¹è¯æ—¶æ˜¾ç¤ºæ¬¢è¿é¡µé¢å’Œä¼šè¯æŒ‰é’®
- æœ‰å½“å‰å¯¹è¯æ—¶æ˜¾ç¤ºèŠå¤©ç•Œé¢
- ä½¿ç”¨ ref å®ç°è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
- æµå¼æ¶ˆæ¯ä½œä¸ºä¸´æ—¶æ¶ˆæ¯æ˜¾ç¤ºï¼Œå®Œæˆåæ›¿æ¢ä¸ºçœŸå®æ¶ˆæ¯
- æŠ½ç‰Œåå…è®¸ç»§ç»­å¯¹è¯å’Œæ·±å…¥æ¢è®¨
- è‡ªåŠ¨è§¦å‘è§£è¯»çš„æ¶ˆæ¯åœ¨ç•Œé¢ä¸Šéšè—ï¼ˆå†…å®¹ä¸º"è¯·æ ¹æ®æŠ½ç‰Œç»“æœè¿›è¡Œè§£è¯»"ï¼‰
- æ‰€æœ‰å¼¹çª—ä½¿ç”¨ AnimatePresence å®ç°è¿›å‡ºåŠ¨ç”»

---

## æ ¸å¿ƒæµç¨‹è¯¦è§£

### 1. ç”¨æˆ·æ³¨å†Œ/ç™»å½•æµç¨‹

```
å‰ç«¯                     åç«¯                      å­˜å‚¨
 â”‚                        â”‚                         â”‚
 â”‚  POST /api/users/register                        â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
 â”‚                        â”‚  hash_password          â”‚
 â”‚                        â”‚  check_username_exists  â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                        â”‚  save_user              â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
 â”‚  User (without password_hash)                    â”‚
 â”‚                        â”‚                         â”‚
 â”‚  setUser(user)         â”‚                         â”‚
 â”‚  localStorage.setItem  â”‚                         â”‚
 â”‚                        â”‚                         â”‚
```

### 2. åˆ›å»ºå¯¹è¯æµç¨‹

```
å‰ç«¯                     åç«¯                      å­˜å‚¨
 â”‚                        â”‚                         â”‚
 â”‚  é€‰æ‹©ä¼šè¯ç±»å‹           â”‚                         â”‚
 â”‚  POST /api/conversations?user_id=xxx             â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
 â”‚                        â”‚  generate_conv_id       â”‚
 â”‚                        â”‚  create_conversation    â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
 â”‚  Conversation          â”‚                         â”‚
 â”‚                        â”‚                         â”‚
 â”‚  addConversation       â”‚                         â”‚
 â”‚  setCurrentConversationâ”‚                         â”‚
 â”‚                        â”‚                         â”‚
```

### 3. å¡”ç½—å åœå®Œæ•´æµç¨‹

```
å‰ç«¯                         åç«¯                      Gemini API
 â”‚                            â”‚                          â”‚
 â”‚  1. ç”¨æˆ·ç‚¹å‡»"å¡”ç½—å åœ"      â”‚                          â”‚
 â”‚  åˆ›å»ºå¯¹è¯ï¼Œå‘é€ç©ºæ¶ˆæ¯       â”‚                          â”‚
 â”‚  POST /api/tarot/message (content="")                â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  æ£€æµ‹é¦–æ¬¡å¯¹è¯             â”‚
 â”‚                            â”‚  ï¼ˆç©ºæ¶ˆæ¯ && 0æ¡å†å²ï¼‰    â”‚
 â”‚                            â”‚  âœ… ä½¿ç”¨é¢„è®¾ç¡¬ç¼–ç å¼€åœºç™½  â”‚
 â”‚                            â”‚  éšæœºé€‰æ‹©3ç§æ–‡æ¡ˆä¹‹ä¸€      â”‚
 â”‚                            â”‚  "{æ˜µç§°}ï¼æ¬¢è¿æ¥åˆ°å¡”ç½—..." â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”‚  ç›´æ¥è¿”å›ï¼ˆä¸è°ƒç”¨AIï¼‰     â”‚
 â”‚  "æœ‹å‹ï¼æ¬¢è¿æ¥åˆ°å¡”ç½—..."   â”‚  é€å­—æµå¼è¾“å‡º             â”‚
 â”‚  ï¼ˆç§’çº§å“åº”ï¼‰               â”‚  ä¿å­˜åˆ°å¯¹è¯å†å²           â”‚
 â”‚                            â”‚                          â”‚
 â”‚  2. ç”¨æˆ·è¾“å…¥å…·ä½“é—®é¢˜        â”‚                          â”‚
 â”‚  POST /api/tarot/message   â”‚                          â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  add_user_message        â”‚
 â”‚                            â”‚  stream_response         â”‚
 â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚  "æˆ‘å»ºè®®ä½¿ç”¨ä¸‰å¼ ç‰Œ..."     â”‚                          â”‚
 â”‚  <draw_cards>{...}</...>   â”‚                          â”‚
 â”‚                            â”‚  extract_draw_instructionâ”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
 â”‚  data: {"draw_cards":{...}}â”‚                          â”‚
 â”‚                            â”‚  add_assistant_message   â”‚
 â”‚                            â”‚  (with draw_request)     â”‚
 â”‚                            â”‚                          â”‚
 â”‚  3. æ‰“å¼€æŠ½ç‰Œå™¨             â”‚                          â”‚
 â”‚  ç”¨æˆ·é€‰æ‹©3å¼ ç‰Œ             â”‚                          â”‚
 â”‚  POST /api/tarot/draw      â”‚                          â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  TarotService.draw_cards â”‚
 â”‚                            â”‚  add_system_message      â”‚
 â”‚                            â”‚  (tarot_cards + draw_request) â”‚
 â”‚                            â”‚  mark_cards_drawn=true   â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
 â”‚  DrawCardsResponse         â”‚                          â”‚
 â”‚                            â”‚                          â”‚
 â”‚  4. è‡ªåŠ¨è§¦å‘è§£è¯»ï¼ˆéšè—ï¼‰   â”‚                          â”‚
 â”‚  POST /api/tarot/message   â”‚                          â”‚
 â”‚  "è¯·æ ¹æ®æŠ½ç‰Œç»“æœè¿›è¡Œè§£è¯»"  â”‚                          â”‚
 â”‚  (ç•Œé¢ä¸æ˜¾ç¤ºæ­¤æ¶ˆæ¯)         â”‚                          â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  add_user_message        â”‚
 â”‚                            â”‚  stream_response         â”‚
 â”‚                            â”‚  format_messages:        â”‚
 â”‚                            â”‚  - [æŠ½ç‰Œç»“æœ] ...ï¼ˆè½¬ä¸ºuserï¼‰â”‚
 â”‚                            â”‚  - "è¯·æ ¹æ®..." (user)    â”‚
 â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                            â”‚  AI çœ‹åˆ°æŠ½ç‰Œç»“æœæ ‡è®°     â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚  "æ ¹æ®ä½ æŠ½åˆ°çš„ç‰Œ..."       â”‚  ä¸è¿”å›æŠ½ç‰ŒæŒ‡ä»¤          â”‚
 â”‚  "è¿‡å»ä½ç½®ï¼šæ„šè€…ï¼ˆæ­£ä½ï¼‰..."â”‚                         â”‚
 â”‚  "å»ºè®®..."                 â”‚                          â”‚
 â”‚                            â”‚                          â”‚
 â”‚  5. ç»§ç»­å¤šè½®å¯¹è¯           â”‚                          â”‚
 â”‚  ç”¨æˆ·å¯ä»¥ç»§ç»­æé—®          â”‚                          â”‚
 â”‚  AI å¯ä»¥ç»§ç»­è®¨è®º           â”‚                          â”‚
 â”‚  ä½†ä¸èƒ½å†æ¬¡æŠ½ç‰Œ            â”‚                          â”‚
```

**å…³é”®æœºåˆ¶è¯´æ˜ï¼š**
1. **ç¡¬ç¼–ç å¼€åœºç™½ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰**ï¼šç‚¹å‡»å¡”ç½—æŒ‰é’®åï¼Œåç«¯ç›´æ¥è¿”å›é¢„è®¾å¼€åœºç™½ï¼Œè€Œä¸è°ƒç”¨AIç”Ÿæˆ
   - **æ£€æµ‹æ¡ä»¶**ï¼šç©ºæ¶ˆæ¯ï¼ˆ`content=""`) ä¸”å¯¹è¯å†å²ä¸ºç©ºï¼ˆ`len(messages)==0`ï¼‰
   - **é¢„è®¾æ–‡æ¡ˆ**ï¼š3ç§å¼€åœºç™½æ¨¡æ¿ï¼Œéšæœºé€‰æ‹©ä¸€ç§
     - `"{æ˜µç§°}ï¼æ¬¢è¿æ¥åˆ°å¡”ç½—çš„ç¥ç§˜ä¸–ç•Œï½ ä»Šå¤©æœ‰ä»€ä¹ˆæƒ³é—®çš„å—ï¼Ÿæ— è®ºæ˜¯çˆ±æƒ…ã€äº‹ä¸šè¿˜æ˜¯äººç”Ÿå›°æƒ‘ï¼Œå¡”ç½—éƒ½ä¼šä¸ºä½ æŒ‡å¼•æ–¹å‘ã€‚"`
     - `"{æ˜µç§°}ï¼Œä½ å¥½å‘€ï¼âœ¨ å¡”ç½—ç‰Œå·²ç»å‡†å¤‡å¥½äº†ï¼Œæƒ³æ¢ç´¢ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿæ„Ÿæƒ…ã€å·¥ä½œã€è¿˜æ˜¯å†…å¿ƒçš„è¿·èŒ«ï¼Ÿ"`
     - `"å—¨ï¼Œ{æ˜µç§°}ï¼å¾ˆé«˜å…´è§åˆ°ä½ ï½ è®©å¡”ç½—ç‰Œä¸ºä½ æ­ç¤ºç­”æ¡ˆå§ï¼ä½ å¯ä»¥é—®æˆ‘å…³äºçˆ±æƒ…ã€äº‹ä¸šã€å†³ç­–ç­‰ä»»ä½•é—®é¢˜å“¦ï¼"`
   - **æ˜µç§°å¤„ç†**ï¼šä½¿ç”¨ `user.profile.nickname`ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨"æœ‹å‹"ä½œä¸ºé»˜è®¤ç§°å‘¼
   - **æµå¼è¾“å‡º**ï¼šä¿æŒé€å­—æµå¼è¾“å‡ºï¼Œç¡®ä¿UIä½“éªŒä¸€è‡´
   - **æ€§èƒ½æå‡**ï¼šä»åŸæ¥çš„å‡ ç§’AIç”Ÿæˆæ—¶é—´ä¼˜åŒ–åˆ°å‡ ä¹å³æ—¶å“åº”
2. **æŠ½ç‰Œç»“æœä¼ é€’**ï¼šSYSTEM æ¶ˆæ¯åœ¨å‘é€ç»™ AI æ—¶è½¬æ¢ä¸ºå¸¦ `[æŠ½ç‰Œç»“æœ]` æ ‡è®°çš„ USER æ¶ˆæ¯
3. **è½¯çº¦æŸæŠ½ç‰Œ**ï¼šä½¿ç”¨ AI æç¤ºè¯å¼•å¯¼ï¼Œé¿å…ä¸å¿…è¦çš„é‡å¤æŠ½ç‰Œï¼Œä½†å…è®¸æ–°é—®é¢˜æ—¶å†æ¬¡æŠ½ç‰Œ
4. **è‡ªåŠ¨è§¦å‘è§£è¯»**ï¼šå‰ç«¯è‡ªåŠ¨å‘é€è§¦å‘æ¶ˆæ¯ï¼Œä½†é€šè¿‡ ChatMessage ç»„ä»¶è¿‡æ»¤ï¼Œä¸æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
5. **AI è¯†åˆ«æœºåˆ¶**ï¼šç³»ç»Ÿæç¤ºè¯æ˜ç¡®å‘Šè¯‰ AI çœ‹åˆ° `[æŠ½ç‰Œç»“æœ]` åç›´æ¥è§£è¯»ï¼Œä¸è¦å†æ¬¡è¿”å›æŠ½ç‰ŒæŒ‡ä»¤
6. **ç»§ç»­å¯¹è¯**ï¼šè§£è¯»å®Œæˆåï¼Œç”¨æˆ·ä»å¯ç»§ç»­æé—®å’Œæ·±å…¥æ¢è®¨

### 4. æ˜Ÿåº§å’¨è¯¢å®Œæ•´æµç¨‹ï¼ˆAIæ™ºèƒ½åˆ¤æ–­ï¼‰

```
å‰ç«¯                         åç«¯                      å¤–éƒ¨API / Gemini API
 â”‚                            â”‚                          â”‚
 â”‚  1. ç”¨æˆ·ç‚¹å‡»"æ˜Ÿåº§"æŒ‰é’®      â”‚                          â”‚
 â”‚  åˆ›å»ºå¯¹è¯ï¼Œå‘é€ç©ºæ¶ˆæ¯       â”‚                          â”‚
 â”‚  POST /api/astrology/message (content="")            â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  æ£€æµ‹é¦–æ¬¡å¯¹è¯             â”‚
 â”‚                            â”‚  ï¼ˆç©ºæ¶ˆæ¯ && 0æ¡å†å²ï¼‰    â”‚
 â”‚                            â”‚  âœ… ä½¿ç”¨é¢„è®¾ç¡¬ç¼–ç å¼€åœºç™½  â”‚
 â”‚                            â”‚  éšæœºé€‰æ‹©3ç§æ–‡æ¡ˆä¹‹ä¸€      â”‚
 â”‚                            â”‚  "{æ˜µç§°}ï¼ä»Šå¤©æœ‰ä»€ä¹ˆæƒ³é—®çš„ï¼Ÿ"
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”‚  ç›´æ¥è¿”å›ï¼ˆä¸è°ƒç”¨AIï¼‰     â”‚
 â”‚  "æœ‹å‹ï¼ä»Šå¤©æœ‰ä»€ä¹ˆæƒ³é—®çš„..." â”‚  é€å­—æµå¼è¾“å‡º             â”‚
 â”‚  ï¼ˆç§’çº§å“åº”ï¼‰               â”‚  ä¿å­˜åˆ°å¯¹è¯å†å²           â”‚
 â”‚                            â”‚                          â”‚
 â”‚  2. ç”¨æˆ·æå‡ºé—®é¢˜            â”‚                          â”‚
 â”‚  POST /api/astrology/message                         â”‚
 â”‚  "æˆ‘çš„ä¸Šå‡æ˜Ÿåº§æ˜¯ä»€ä¹ˆï¼Ÿ"     â”‚                          â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  add_user_message        â”‚
 â”‚                            â”‚  stream_response         â”‚
 â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                            â”‚  AI åˆ¤æ–­ï¼šéœ€è¦æ˜Ÿç›˜èµ„æ–™   â”‚
 â”‚                            â”‚  æ£€æŸ¥ç”¨æˆ·èµ„æ–™ï¼šä¸å®Œæ•´     â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”‚
 â”‚  "è¿™ä¸ªé—®é¢˜éœ€è¦æ ¹æ®æ‚¨çš„æœ¬å‘½ç›˜æ¥åˆ†æ..."                â”‚
 â”‚  <need_profile>{...}</need_profile>                  â”‚
 â”‚                            â”‚  æ£€æµ‹åˆ° need_profile æ ‡ç­¾â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
 â”‚  data: {"need_profile":{}}  â”‚                          â”‚
 â”‚                            â”‚                          â”‚
 â”‚  3. å‰ç«¯å¼¹å‡ºèµ„æ–™å¡«å†™çª—å£    â”‚                          â”‚
 â”‚  ç”¨æˆ·å¡«å†™ï¼šæ€§åˆ«ã€å‡ºç”Ÿå¹´æœˆæ—¥  â”‚                          â”‚
 â”‚  æ—¶åˆ†ã€å‡ºç”ŸåŸå¸‚             â”‚                          â”‚
 â”‚                            â”‚                          â”‚
 â”‚  4. æäº¤èµ„æ–™                â”‚                          â”‚
 â”‚  PUT /api/users/{id}/profile                         â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  save_user               â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
 â”‚                            â”‚                          â”‚
 â”‚  5. è·å–æ˜Ÿç›˜æ•°æ®            â”‚                          â”‚
 â”‚  POST /api/astrology/fetch-chart                     â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  fetch_natal_chart       â”‚
 â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                            â”‚  POST xingpan.vip API   â”‚
 â”‚                            â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                            â”‚  format_chart_to_text    â”‚
 â”‚                            â”‚  add_system_message      â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  ([æ˜Ÿç›˜æ•°æ®])            â”‚
 â”‚                            â”‚                          â”‚
 â”‚  6. é€šçŸ¥AIèµ„æ–™å·²è¡¥å……        â”‚                          â”‚
 â”‚  POST /api/astrology/message                         â”‚
 â”‚  "æˆ‘å·²ç»å¡«å†™å¥½å‡ºç”Ÿä¿¡æ¯äº†"   â”‚                          â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  add_user_message        â”‚
 â”‚                            â”‚  stream_response         â”‚
 â”‚                            â”‚  (æºå¸¦æ˜Ÿç›˜æ•°æ®)           â”‚
 â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                            â”‚  AI çœ‹åˆ°æ˜Ÿç›˜æ•°æ®          â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚  "å¤ªå¥½äº†ï¼æ ¹æ®æ‚¨çš„æ˜Ÿç›˜..."  â”‚  AI åŸºäºæ˜Ÿç›˜è§£è¯»         â”‚
 â”‚  "æ‚¨çš„ä¸Šå‡æ˜Ÿåº§æ˜¯..."        â”‚                          â”‚
 â”‚                            â”‚                          â”‚
 â”‚  ã€æƒ…å†µ2ï¼šä¸éœ€è¦æ˜Ÿç›˜çš„é—®é¢˜ã€‘â”‚                          â”‚
 â”‚  POST /api/astrology/message                         â”‚
 â”‚  "åŒå­åº§ä»Šå¤©è¿åŠ¿å¦‚ä½•ï¼Ÿ"     â”‚                          â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  add_user_message        â”‚
 â”‚                            â”‚  stream_response         â”‚
 â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                            â”‚  AI åˆ¤æ–­ï¼šä¸éœ€è¦æ˜Ÿç›˜èµ„æ–™ â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚  "åŒå­åº§ä»Šå¤©è¿åŠ¿..."        â”‚  AI ç›´æ¥å›ç­”             â”‚
 â”‚  ï¼ˆä¸è§¦å‘èµ„æ–™æ”¶é›†ï¼‰         â”‚                          â”‚
 â”‚                            â”‚                          â”‚
 â”‚  ã€æƒ…å†µ3ï¼šç”¨æˆ·è·³è¿‡å¡«å†™èµ„æ–™ã€‘â”‚                          â”‚
 â”‚  ç”¨æˆ·ç‚¹å‡»"æš‚æ—¶è·³è¿‡"         â”‚                          â”‚
 â”‚  å…³é—­å¼¹çª—ï¼Œç»§ç»­å¯¹è¯         â”‚                          â”‚
 â”‚  AI å¯ä»¥åŸºäºä¸€èˆ¬æ˜Ÿåº§çŸ¥è¯†å›ç­”                          â”‚
 â”‚                            â”‚                          â”‚
```

**å…³é”®æœºåˆ¶è¯´æ˜ï¼š**
1. **ç¡¬ç¼–ç å¼€åœºç™½ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰**ï¼šç‚¹å‡»æ˜Ÿåº§æŒ‰é’®åï¼Œåç«¯ç›´æ¥è¿”å›é¢„è®¾å¼€åœºç™½ï¼Œè€Œä¸è°ƒç”¨AIç”Ÿæˆ
   - **æ£€æµ‹æ¡ä»¶**ï¼šç©ºæ¶ˆæ¯ï¼ˆ`content=""`) ä¸”å¯¹è¯å†å²ä¸ºç©ºï¼ˆ`len(messages)==0`ï¼‰
   - **é¢„è®¾æ–‡æ¡ˆ**ï¼š3ç§å¼€åœºç™½æ¨¡æ¿ï¼Œéšæœºé€‰æ‹©ä¸€ç§
     - `"{æ˜µç§°}ï¼ä»Šå¤©æœ‰ä»€ä¹ˆæƒ³é—®çš„ï¼Ÿæˆ‘å¯ä»¥å¸®ä½ çœ‹æ˜Ÿåº§ã€è¿åŠ¿ã€æ˜Ÿç›˜ç­‰ä»»ä½•é—®é¢˜ï½"`
     - `"{æ˜µç§°}ï¼Œä½ å¥½å‘€ï¼âœ¨ æƒ³èŠèŠä½ çš„æ˜Ÿåº§ã€è¿åŠ¿ï¼Œè¿˜æ˜¯æƒ³æ·±å…¥äº†è§£ä½ çš„æœ¬å‘½ç›˜ï¼Ÿ"`
     - `"å—¨ï¼Œ{æ˜µç§°}ï¼å¾ˆé«˜å…´è§åˆ°ä½ ï½ ä»Šå¤©æƒ³æ¢ç´¢ä»€ä¹ˆå‘¢ï¼Ÿæ˜Ÿåº§ã€å¡”ç½—è¿˜æ˜¯æ˜Ÿç›˜åˆ†æéƒ½å¯ä»¥å“¦ï¼"`
   - **æ˜µç§°å¤„ç†**ï¼šä½¿ç”¨ `user.profile.nickname`ï¼ˆå¦‚æœæœ‰ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨"æœ‹å‹"ä½œä¸ºé»˜è®¤ç§°å‘¼
   - **æµå¼è¾“å‡º**ï¼šä¿æŒé€å­—æµå¼è¾“å‡ºï¼Œç¡®ä¿UIä½“éªŒä¸€è‡´
   - **æ€§èƒ½æå‡**ï¼šä»åŸæ¥çš„å‡ ç§’AIç”Ÿæˆæ—¶é—´ä¼˜åŒ–åˆ°å‡ ä¹å³æ—¶å“åº”
2. **AIæ™ºèƒ½åˆ¤æ–­**ï¼šAIæ ¹æ®ç”¨æˆ·é—®é¢˜è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦éœ€è¦æ˜Ÿç›˜èµ„æ–™
   - éœ€è¦æ˜Ÿç›˜èµ„æ–™çš„é—®é¢˜ï¼šæœ¬å‘½ç›˜ã€ä¸Šå‡æ˜Ÿåº§ã€æœˆäº®æ˜Ÿåº§ã€ä¸ªäººè¡Œæ˜Ÿè½åº§ã€å®«ä½ã€ç›¸ä½ç­‰
   - ä¸éœ€è¦æ˜Ÿç›˜èµ„æ–™çš„é—®é¢˜ï¼šæ˜Ÿåº§æ€§æ ¼ã€ä¸€èˆ¬è¿åŠ¿ã€æ˜Ÿåº§é…å¯¹ã€æ˜Ÿåº§çŸ¥è¯†ç­‰
3. **æŒ‰éœ€è§¦å‘èµ„æ–™æ”¶é›†**ï¼š
   - AIé€šè¿‡ `<need_profile>` æ ‡ç­¾å‘ŠçŸ¥å‰ç«¯éœ€è¦ç”¨æˆ·èµ„æ–™
   - å‰ç«¯æ£€æµ‹åˆ°æ ‡ç­¾åå¼¹å‡ºèµ„æ–™å¡«å†™çª—å£
   - ä¸éœ€è¦æ˜Ÿç›˜èµ„æ–™çš„é—®é¢˜ï¼ŒAIç›´æ¥å›ç­”ï¼Œä¸è§¦å‘å¼¹çª—
4. **è‡ªåŠ¨è·å–æ˜Ÿç›˜**ï¼šAIä¹Ÿå¯ä»¥é€šè¿‡ `<fetch_chart>` æ ‡ç­¾è§¦å‘æ˜Ÿç›˜æ•°æ®è·å–ï¼ˆå¦‚æœç”¨æˆ·èµ„æ–™å®Œæ•´ä½†æ˜Ÿç›˜æœªè·å–ï¼‰
5. **æ˜Ÿç›˜æ•°æ®ä¼ é€’**ï¼šSYSTEMæ¶ˆæ¯æºå¸¦æ˜Ÿç›˜æ•°æ®ï¼Œåœ¨å‘é€ç»™AIæ—¶è½¬æ¢ä¸ºå¸¦`[æ˜Ÿç›˜æ•°æ®]`æ ‡è®°çš„ç”¨æˆ·æ¶ˆæ¯
6. **çµæ´»å¯¹è¯**ï¼šç”¨æˆ·å¯ä»¥å…ˆå’¨è¯¢ä¸€èˆ¬æ˜Ÿåº§é—®é¢˜ï¼Œéœ€è¦æ—¶å†è¡¥å……èµ„æ–™è·å–ç²¾å‡†æ˜Ÿç›˜è§£è¯»
7. **æ¸¸å®¢æ¨¡å¼**ï¼šæ¸¸å®¢ç”¨æˆ·å¡«å†™çš„èµ„æ–™åŒæ ·ä¼šä¿å­˜åˆ° profile ä¸­ï¼ˆä½†ä¸ä¼šæŒä¹…åŒ–åˆ°æ³¨å†Œè´¦å·ï¼‰

### 5. æŠ½ç‰ŒåŠ¨ç”»æµç¨‹

```
1. åˆå§‹çŠ¶æ€
   [å¼€å§‹æ´—ç‰Œ]

2. ç‚¹å‡»æ´—ç‰Œ
   ğŸ´ æ—‹è½¬
   ğŸ´ æ—‹è½¬ç§»åŠ¨
   ğŸ´ æ—‹è½¬ç¼©æ”¾
   ï¼ˆ2ç§’åŠ¨ç”»ï¼‰

3. æ´—ç‰Œå®Œæˆ
   é¡¶éƒ¨æ˜¾ç¤ºå¡æ§½ï¼š
   [ä½ç½®1] [ä½ç½®2] [ä½ç½®3]
   
   åº•éƒ¨æ‰‡å½¢å±•å¼€ï¼š
        ğŸ´ğŸ´ğŸ´
       ğŸ´    ğŸ´
      ğŸ´      ğŸ´

4. ç”¨æˆ·ç‚¹å‡»é€‰ç‰Œ
   é€‰ä¸­çš„ç‰Œï¼š
   - æ”¾å¤§1.3å€
   - ä¸Šç§»20px
   - é»„è‰²å…‰åœˆ
   
   å·²é€‰2/3å¼ 

5. é€‰å¤Ÿæ•°é‡
   æ˜¾ç¤º [ç¡®è®¤æŠ½ç‰Œ] æŒ‰é’®

6. ç¡®è®¤æŠ½ç‰Œ
   é€‰ä¸­çš„ç‰ŒåŠ¨ç”»ç§»åŠ¨åˆ°é¡¶éƒ¨å¡æ§½
   æ˜¾ç¤ºæ­£é€†ä½æ ‡è¯†
   å»¶è¿Ÿ1.5ç§’åå…³é—­
```

---

## é€šç”¨è®¾è®¡æœºåˆ¶

### 1. é”™è¯¯å¤„ç†æœºåˆ¶

**åç«¯ï¼š**
- æ‰€æœ‰è·¯ç”±ä½¿ç”¨ try-except æ•è·å¼‚å¸¸
- ä¸šåŠ¡é€»è¾‘é”™è¯¯æŠ›å‡º ValueErrorï¼Œè·¯ç”±è½¬æ¢ä¸º 400/404/401
- ä½¿ç”¨ HTTPException ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
- æœªé¢„æœŸé”™è¯¯è¿”å› 500 çŠ¶æ€ç 

**å‰ç«¯ï¼š**
- API è°ƒç”¨ä½¿ç”¨ try-catch æ•è·å¼‚å¸¸
- é”™è¯¯ä½¿ç”¨ alert æç¤ºç”¨æˆ·ï¼ˆåç»­å¯æ”¹è¿›ä¸º Toastï¼‰
- é”™è¯¯æ—¶æ¢å¤ UI çŠ¶æ€ï¼ˆå–æ¶ˆåŠ è½½çŠ¶æ€ç­‰ï¼‰

### 2. æ•°æ®æŒä¹…åŒ–æœºåˆ¶

**åç«¯æœ¬åœ°å­˜å‚¨ï¼š**
- ä½¿ç”¨ JSON æ–‡ä»¶å­˜å‚¨ç”¨æˆ·å’Œå¯¹è¯æ•°æ®
- æ–‡ä»¶è·¯å¾„ï¼š`backend/data/users.json`ã€`backend/data/conversations.json`
- ä½¿ç”¨å¼‚æ­¥æ–‡ä»¶æ“ä½œï¼ˆaiofilesï¼‰æé«˜æ€§èƒ½
- æ•°æ®ç»“æ„ä¸ºå­—å…¸ï¼Œé”®ä¸º IDï¼Œå€¼ä¸ºå¯¹è±¡

**å‰ç«¯æœ¬åœ°å­˜å‚¨ï¼š**
- ç”¨æˆ·ä¿¡æ¯æŒä¹…åŒ–åˆ° localStorageï¼ˆä½¿ç”¨ Zustand persistï¼‰
- å¯¹è¯åˆ—è¡¨æ¯æ¬¡ç™»å½•åä»æœåŠ¡å™¨åŠ è½½
- å­˜å‚¨é”®åï¼š`auth-storage`

### 3. é˜²é‡å¤æŠ½ç‰Œæœºåˆ¶

**å®ç°æ–¹å¼ï¼š**
- å¯¹è¯æ¨¡å‹åŒ…å« `has_drawn_cards` å­—æ®µ
- æŠ½ç‰ŒæˆåŠŸåè°ƒç”¨ `mark_cards_drawn` è®¾ç½®ä¸º true
- åç»­æŠ½ç‰Œè¯·æ±‚æ£€æŸ¥æ­¤å­—æ®µï¼Œå¦‚æœä¸º true è¿”å› 400 é”™è¯¯
- AI ç³»ç»Ÿæç¤ºè¯æ˜ç¡®è¯´æ˜åªèƒ½æŠ½ç‰Œä¸€æ¬¡
- AI çœ‹åˆ° `[æŠ½ç‰Œç»“æœ]` æ ‡è®°åä¸å†è¿”å›æŠ½ç‰ŒæŒ‡ä»¤
- å‰ç«¯åœ¨è§£è¯»æ—¶æ£€æµ‹åˆ°æŠ½ç‰ŒæŒ‡ä»¤ä¼šå‘å‡ºè­¦å‘Šï¼ˆä½†ä¸»è¦ä¾èµ–åç«¯å’Œ AI æœºåˆ¶ï¼‰

**ä¸‰å±‚é˜²æŠ¤ï¼š**
1. **åç«¯ API å±‚**ï¼šhas_drawn_cards æ ‡è®°é˜»æ­¢é‡å¤ API è°ƒç”¨
2. **AI æç¤ºå±‚**ï¼šç³»ç»Ÿæç¤ºè¯å’ŒæŠ½ç‰Œç»“æœæ ‡è®°å¼•å¯¼ AI è¡Œä¸º
3. **å‰ç«¯é€»è¾‘å±‚**ï¼šconsole.warn æ£€æµ‹å¼‚å¸¸æƒ…å†µ

### 4. æµå¼è¾“å‡ºæœºåˆ¶

**åç«¯ï¼š**
- ä½¿ç”¨ AsyncGenerator å®ç°å¼‚æ­¥ç”Ÿæˆå™¨
- ä½¿ç”¨ StreamingResponse è¿”å› SSE æ ¼å¼
- æ•°æ®æ ¼å¼ï¼š`data: {JSON}\n\n`
- ç»“æŸæ ‡è®°ï¼š`data: [DONE]\n\n`

**å‰ç«¯ï¼š**
- ä½¿ç”¨ Fetch API çš„ ReadableStream
- ä½¿ç”¨ TextDecoder è§£ç å­—èŠ‚æµ
- é€è¡Œè§£æ SSE æ ¼å¼
- é€šè¿‡å›è°ƒå‡½æ•°å®æ—¶æ›´æ–° UI

### 5. åŠ¨ç”»æœºåˆ¶

**åŸåˆ™ï¼š**
- æ‰€æœ‰äº¤äº’éƒ½æœ‰åé¦ˆåŠ¨ç”»
- ä½¿ç”¨ Framer Motion ç»Ÿä¸€åŠ¨ç”»å®ç°
- å¸¸ç”¨åŠ¨ç”»ï¼šæ·¡å…¥ï¼ˆfadeInï¼‰ã€æ»‘å…¥ï¼ˆslideUpï¼‰ã€æ‚¬æµ®ï¼ˆfloatï¼‰

**å¸¸è§åŠ¨ç”»ï¼š**
- ç»„ä»¶è¿›å…¥ï¼šopacity 0â†’1, y 20â†’0
- æŒ‰é’® hoverï¼šscale 1â†’1.05
- æŒ‰é’® tapï¼šscale 1â†’0.95
- å¡ç‰‡æ‚¬åœï¼šscale 1â†’1.2, z ä¸Šå‡
- åˆ—è¡¨é¡¹ï¼šå»¶è¿Ÿè¿›å…¥åŠ¨ç”»ï¼ˆstaggerï¼‰

### 6. å“åº”å¼è®¾è®¡æœºåˆ¶

**å¸ƒå±€ï¼š**
- ä½¿ç”¨ Tailwind CSS çš„ flex å¸ƒå±€
- ä¾§è¾¹æ å›ºå®šå®½åº¦ï¼ˆ256pxï¼‰
- ä¸»å†…å®¹åŒºåŸŸå æ»¡å‰©ä½™ç©ºé—´
- èŠå¤©æ¶ˆæ¯æœ€å¤§å®½åº¦ 3xlï¼ˆ768pxï¼‰

**é€‚é…ï¼š**
- å½“å‰ä»…æ”¯æŒæ¡Œé¢ç«¯
- ç§»åŠ¨ç«¯éœ€è¦å¢åŠ å“åº”å¼æ–­ç‚¹å’Œä¾§è¾¹æ æŠ˜å 

**é—®é¢˜èƒŒæ™¯ï¼š**
- React çš„ `setState` æ˜¯å¼‚æ­¥çš„ï¼Œä¸ä¼šç«‹å³æ›´æ–°çŠ¶æ€
- JavaScript é—­åŒ…ä¼šæ•è·å®šä¹‰æ—¶çš„å˜é‡å€¼ï¼Œè€Œéæ‰§è¡Œæ—¶çš„å€¼
- ç»„åˆä½¿ç”¨ä¼šå¯¼è‡´é—­åŒ…æ•è·æ—§çš„çŠ¶æ€å€¼

**é”™è¯¯æ¨¡å¼ï¼ˆé¿å…ï¼‰ï¼š**
```typescript
// âŒ é”™è¯¯ï¼šé—­åŒ…æ•è·æ—§çŠ¶æ€
const [currentConv, setCurrentConv] = useState(null);

const handleCreate = async () => {
  const newConv = await createConversation();
  setCurrentConv(newConv);  // å¼‚æ­¥æ›´æ–°ï¼Œä¸ä¼šç«‹å³ç”Ÿæ•ˆ
  
  // é”™è¯¯æ–¹å¼1ï¼šç›´æ¥ä½¿ç”¨çŠ¶æ€
  sendMessage(currentConv.id);  // currentConv ä»ç„¶æ˜¯ nullï¼
  
  // é”™è¯¯æ–¹å¼2ï¼šä½¿ç”¨ setTimeout
  setTimeout(() => {
    sendMessage(currentConv.id);  // é—­åŒ…æ•è·çš„ä»æ˜¯æ—§å€¼ nullï¼
  }, 100);
};
```

**æ­£ç¡®æ¨¡å¼ï¼ˆæ¨èï¼‰ï¼š**
```typescript
// âœ… æ­£ç¡®ï¼šç›´æ¥ä½¿ç”¨å±€éƒ¨å˜é‡
const handleCreate = async () => {
  const newConv = await createConversation();
  setCurrentConv(newConv);  // æ›´æ–°çŠ¶æ€ï¼ˆå¼‚æ­¥ï¼‰
  
  // æ–¹å¼1ï¼šç›´æ¥ä½¿ç”¨å±€éƒ¨å˜é‡ï¼ˆæ¨èï¼‰
  await sendMessage(newConv.id);  // ä½¿ç”¨ newConvï¼Œä¸ä¾èµ–çŠ¶æ€
  
  // æ–¹å¼2ï¼šå†…è”é€»è¾‘
  await api.sendMessage(newConv.id, content);  // ä¸è°ƒç”¨ä¾èµ–çŠ¶æ€çš„å‡½æ•°
};
```

**è®¾è®¡åŸåˆ™ï¼š**
1. **ä¼˜å…ˆä½¿ç”¨å±€éƒ¨å˜é‡/å‡½æ•°å‚æ•°** - é¿å…ä¾èµ– React çŠ¶æ€
2. **å†…è”é€»è¾‘è€Œéå‡½æ•°è°ƒç”¨** - å‡å°‘çŠ¶æ€ä¾èµ–é“¾
3. **ä½¿ç”¨ useEffect ç›‘å¬çŠ¶æ€å˜åŒ–** - éœ€è¦å“åº”çŠ¶æ€æ›´æ–°æ—¶ä½¿ç”¨
4. **é¿å… setTimeout å¤„ç†çŠ¶æ€é—®é¢˜** - æ²»æ ‡ä¸æ²»æœ¬

**é€‚ç”¨åœºæ™¯ï¼š**
- åˆ›å»ºèµ„æºåç«‹å³æ“ä½œè¯¥èµ„æº
- çŠ¶æ€æ›´æ–°åç«‹å³æ‰§è¡Œä¾èµ–è¯¥çŠ¶æ€çš„æ“ä½œ
- è¡¨å•æäº¤ã€å¯¹è¯åˆ›å»ºç­‰åœºæ™¯

**æœ¬é¡¹ç›®åº”ç”¨ï¼š**
- `handleSelectSession`ï¼šåˆ›å»ºå¯¹è¯åç«‹å³å‘é€æ¶ˆæ¯
- ä½¿ç”¨ `newConv.conversation_id` è€Œé `currentConversation.conversation_id`
- é¿å…äº†é—­åŒ…æ•è· null å€¼çš„é—®é¢˜

### 8. å®‰å…¨æœºåˆ¶

**å¯†ç å®‰å…¨ï¼š**
- ä½¿ç”¨ bcrypt åŠ å¯†å¯†ç 
- å¯†ç å“ˆå¸Œæ°¸ä¸è¿”å›ç»™å‰ç«¯
- ç™»å½•å¤±è´¥ç»Ÿä¸€æç¤º"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"

**API å®‰å…¨ï¼š**
- ä½¿ç”¨ CORS é™åˆ¶è·¨åŸŸè¯·æ±‚
- API Key é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®
- æ•æ„Ÿé…ç½®ä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶

### 9. æ€§èƒ½ä¼˜åŒ–æœºåˆ¶

**åç«¯ï¼š**
- ä½¿ç”¨å¼‚æ­¥æ“ä½œï¼ˆasync/awaitï¼‰æé«˜å¹¶å‘æ€§èƒ½
- æ–‡ä»¶æ“ä½œä½¿ç”¨ aiofiles
- ä½¿ç”¨æµå¼è¾“å‡ºå‡å°‘ç­‰å¾…æ—¶é—´

**å‰ç«¯ï¼š**
- ä½¿ç”¨ Zustand è½»é‡çº§çŠ¶æ€ç®¡ç†
- æŒ‰éœ€åŠ è½½ï¼ˆæœªå®ç°ä»£ç åˆ†å‰²ï¼‰
- ä½¿ç”¨ Vite æ„å»ºï¼Œå¼€å‘æœåŠ¡å™¨å¯åŠ¨å¿«

---

## æ•°æ®æ¨¡å‹å…³ç³»å›¾

```
User (ç”¨æˆ·)
 â”‚
 â”œâ”€ user_id: string (PK)
 â”œâ”€ user_type: UserType
 â”œâ”€ username: string (unique)
 â”œâ”€ password_hash: string
 â””â”€ profile: UserProfile
      â”œâ”€ nickname: string
      â”œâ”€ gender: Gender
      â””â”€ birth_date: ...

Conversation (å¯¹è¯)
 â”‚
 â”œâ”€ conversation_id: string (PK)
 â”œâ”€ user_id: string (FK â†’ User)
 â”œâ”€ session_type: SessionType
 â”œâ”€ title: string
 â”œâ”€ has_drawn_cards: boolean
 â”œâ”€ is_completed: boolean
 â””â”€ messages: Message[]
      â”‚
      â”œâ”€ role: MessageRole
      â”œâ”€ content: string
      â”œâ”€ timestamp: string
      â”œâ”€ tarot_cards: TarotCard[]
      â”‚    â”œâ”€ card_id: int
      â”‚    â”œâ”€ card_name: string
      â”‚    â””â”€ reversed: boolean
      â””â”€ draw_request: DrawCardsRequest
           â”œâ”€ spread_type: TarotSpread
           â”œâ”€ card_count: int
           â””â”€ positions: string[]
```

---

## æ‰©å±•ç‚¹

### 1. æ•°æ®åº“è¿ç§»

å½“å‰ä½¿ç”¨ JSON æ–‡ä»¶å­˜å‚¨ï¼Œå¯ä»¥è¿ç§»åˆ°æ•°æ®åº“ï¼š

**æ¨èï¼š**
- SQLiteï¼ˆç®€å•ï¼Œé€‚åˆå•æœºï¼‰
- PostgreSQLï¼ˆåŠŸèƒ½å¼ºå¤§ï¼Œé€‚åˆç”Ÿäº§ï¼‰
- MongoDBï¼ˆçµæ´»ï¼Œé€‚åˆæ–‡æ¡£å­˜å‚¨ï¼‰

**æ”¹åŠ¨ç‚¹ï¼š**
- ä¿®æ”¹ `storage_service.py` å®ç°æ•°æ®åº“æ“ä½œ
- å…¶ä»–ä»£ç æ— éœ€ä¿®æ”¹ï¼ˆä¾èµ–æŠ½è±¡ï¼‰

### 2. ç”¨æˆ·è®¤è¯å¢å¼º

**å¯æ·»åŠ ï¼š**
- JWT Token è®¤è¯
- åˆ·æ–° Token æœºåˆ¶
- é‚®ç®±éªŒè¯
- å¯†ç é‡ç½®
- OAuth ç¬¬ä¸‰æ–¹ç™»å½•

### 3. ç§»åŠ¨ç«¯é€‚é…

**éœ€è¦ï¼š**
- å“åº”å¼å¸ƒå±€ï¼ˆTailwind æ–­ç‚¹ï¼‰
- ä¾§è¾¹æ æŠ˜å /æŠ½å±‰
- è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ
- ç§»åŠ¨ç«¯æŠ½ç‰Œäº¤äº’ä¼˜åŒ–

### 4. å¯¼å‡ºåŠŸèƒ½

**å¯å¯¼å‡ºï¼š**
- å¯¹è¯å†å²ï¼ˆPDF/Markdownï¼‰
- æŠ½ç‰Œç»“æœå›¾ç‰‡
- åˆ†äº«åˆ°ç¤¾äº¤åª’ä½“

---

## ç»´æŠ¤æ³¨æ„äº‹é¡¹

### 1. æ·»åŠ æ–°çš„ä¼šè¯ç±»å‹

1. åœ¨ `backend/models.py` çš„ `SessionType` æšä¸¾æ·»åŠ æ–°ç±»å‹
2. åœ¨ `GeminiService` æ·»åŠ å¯¹åº”çš„ç³»ç»Ÿæç¤ºè¯
3. åœ¨å‰ç«¯ `types/index.ts` åŒæ­¥æ·»åŠ æšä¸¾
4. åœ¨ `SessionButtons.tsx` æ·»åŠ æŒ‰é’®é…ç½®
5. åœ¨ `App.tsx` çš„ `handleSelectSession` æ·»åŠ é€»è¾‘

### 2. ä¿®æ”¹å¡”ç½—ç‰Œæ•°æ®

1. ä¿®æ”¹ `backend/config.py` çš„ `TAROT_CARDS` åˆ—è¡¨
2. ç¡®ä¿æœ‰ 78 å¼ ç‰Œï¼ˆæˆ–è°ƒæ•´ TarotService çš„é€»è¾‘ï¼‰
3. å¦‚æœç‰Œæ•°å˜åŒ–ï¼Œä¿®æ”¹å‰ç«¯æŠ½ç‰Œå™¨çš„ç‰Œæ•°é‡

### 3. è°ƒæ•´ AI è¡Œä¸º

1. ä¿®æ”¹ `backend/services/gemini_service.py` çš„ `TAROT_SYSTEM_PROMPT`
2. è°ƒæ•´ `generation_config`ï¼ˆtemperature, top_p, max_tokensï¼‰
3. å¦‚æœä¿®æ”¹æŠ½ç‰ŒæŒ‡ä»¤æ ¼å¼ï¼ŒåŒæ­¥ä¿®æ”¹å‰ç«¯è§£æé€»è¾‘

### 4. æ›´æ¢ AI æ¨¡å‹

1. ä¿®æ”¹ `backend/config.py` çš„ `GEMINI_MODEL`
2. å¦‚æœæ›´æ¢ APIï¼ˆå¦‚ OpenAIï¼‰ï¼Œéœ€é‡å†™ `GeminiService`
3. ä¿æŒæ¥å£ä¸€è‡´ï¼Œå…¶ä»–ä»£ç æ— éœ€ä¿®æ”¹

### 5. æ€§èƒ½ç›‘æ§

**å»ºè®®æ·»åŠ ï¼š**
- API å“åº”æ—¶é—´æ—¥å¿—
- é”™è¯¯æ—¥å¿—ï¼ˆæ–‡ä»¶/Sentryï¼‰
- ç”¨æˆ·è¡Œä¸ºåˆ†æ
- æ¨¡å‹è°ƒç”¨ç»Ÿè®¡

---

## æ€»ç»“

### æ¶æ„ä¼˜åŠ¿

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šå‰åç«¯åˆ†ç¦»ï¼Œå„å±‚èŒè´£æ¸…æ™°
2. **æ˜“äºæ‰©å±•**ï¼šæ–°å¢ä¼šè¯ç±»å‹ã€AI æ¨¡å‹ã€æ•°æ®åº“éƒ½å¾ˆç®€å•
3. **ç”¨æˆ·ä½“éªŒ**ï¼šæµå¼è¾“å‡ºã€åŠ¨ç”»æ•ˆæœã€å®æ—¶åé¦ˆ
4. **æ•°æ®å®‰å…¨**ï¼šå¯†ç åŠ å¯†ã€æœ¬åœ°å­˜å‚¨ã€éšç§ä¿æŠ¤

### æŠ€æœ¯äº®ç‚¹

1. **æµå¼ AI å¯¹è¯**ï¼šä½¿ç”¨ SSE å®ç°æ‰“å­—æœºæ•ˆæœ
2. **å¡”ç½—ç‰ŒåŠ¨ç”»**ï¼šæ‰‡å½¢å±•å¼€ã€æ´—ç‰Œã€é€‰ç‰Œå…¨æµç¨‹
3. **æ˜Ÿç›˜è§£è¯»**ï¼šé›†æˆå¤–éƒ¨æ˜Ÿç›˜APIï¼Œæ™ºèƒ½åˆ¤æ–­ç”¨æˆ·èµ„æ–™å®Œæ•´æ€§
4. **çŠ¶æ€ç®¡ç†**ï¼šZustand è½»é‡çº§ä¸”æ˜“ç”¨
5. **å¼‚æ­¥æ¶æ„**ï¼šåç«¯å…¨å¼‚æ­¥ï¼Œæ€§èƒ½ä¼˜ç§€
6. **å¤šä¼šè¯ç±»å‹**ï¼šæ”¯æŒå¡”ç½—å åœã€æ˜Ÿç›˜è§£è¯»ï¼Œæ˜“äºæ‰©å±•

### æ”¹è¿›æ–¹å‘

1. **æ•°æ®æŒä¹…åŒ–**ï¼šè¿ç§»åˆ°æ•°æ®åº“
2. **è®¤è¯ç³»ç»Ÿ**ï¼šæ·»åŠ  JWTã€æƒé™ç®¡ç†
3. **é”™è¯¯å¤„ç†**ï¼šToast æç¤ºã€é”™è¯¯æ—¥å¿—
4. **ç§»åŠ¨ç«¯**ï¼šå“åº”å¼å¸ƒå±€ã€è§¦æ‘¸ä¼˜åŒ–
5. **æµ‹è¯•**ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•
6. **éƒ¨ç½²**ï¼šDockeråŒ–ã€CI/CD
7. **æ˜Ÿç›˜åŠŸèƒ½å¢å¼º**ï¼š
   - æ‰©å±•åŸå¸‚åˆ—è¡¨æˆ–é›†æˆåœ°ç†ç¼–ç æœåŠ¡
   - æ·»åŠ æ˜Ÿç›˜å›¾å½¢åŒ–å±•ç¤ºï¼ˆSVG/Canvasï¼‰
   - æ”¯æŒåˆç›˜ã€æµå¹´ç­‰æ›´å¤šæ˜Ÿç›˜ç±»å‹
8. **èŠæ„ˆåŠŸèƒ½**ï¼šæ·»åŠ å¿ƒç†å’¨è¯¢å¯¹è¯æ¨¡å¼
