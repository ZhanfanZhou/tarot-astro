# å¡”ç½—å åœåº”ç”¨ - æ¶æ„è®¾è®¡æ–‡æ¡£

## é¡¹ç›®æ¦‚è¿°

è¿™æ˜¯ä¸€ä¸ªåŸºäº AI çš„å¡”ç½—å åœåº”ç”¨ï¼Œä½¿ç”¨ Google Gemini 2.0 Flash æ¨¡å‹æä¾›ä¸“ä¸šçš„å¡”ç½—ç‰Œè§£è¯»ã€‚åº”ç”¨é‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼Œå‰ç«¯ä½¿ç”¨ Reactï¼Œåç«¯ä½¿ç”¨ FastAPIï¼Œæ•°æ®å­˜å‚¨ä½¿ç”¨æœ¬åœ° JSON æ–‡ä»¶ã€‚

## æŠ€æœ¯æ¶æ„

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚         â”‚                 â”‚         â”‚                  â”‚
â”‚  React Frontend â”‚ â—„â”€â”€â”€â”€â”€â–º â”‚  FastAPI Backendâ”‚ â—„â”€â”€â”€â”€â”€â–º â”‚ Gemini 2.0 Flash â”‚
â”‚                 â”‚  HTTP   â”‚                 â”‚   API   â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â”‚                           â”‚
         â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚         â”‚                 â”‚
â”‚  LocalStorage   â”‚         â”‚   JSON Files    â”‚
â”‚   (Browser)     â”‚         â”‚   (Backend)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆ

**åç«¯ï¼š**
- FastAPI 0.115.0 - Web æ¡†æ¶
- Uvicorn - ASGI æœåŠ¡å™¨
- Google GenerativeAI 0.8.3 - Gemini API SDK
- Pydantic 2.9.2 - æ•°æ®éªŒè¯
- Passlib - å¯†ç åŠ å¯†
- Aiofiles - å¼‚æ­¥æ–‡ä»¶æ“ä½œ

**å‰ç«¯ï¼š**
- React 18.3.1 - UI æ¡†æ¶
- TypeScript 5.7.2 - ç±»å‹å®‰å…¨
- Vite 6.0.5 - æ„å»ºå·¥å…·
- Tailwind CSS 3.4.17 - æ ·å¼æ¡†æ¶
- Framer Motion 11.11.17 - åŠ¨ç”»åº“
- Zustand 5.0.2 - çŠ¶æ€ç®¡ç†
- Axios 1.7.9 - HTTP å®¢æˆ·ç«¯

---

## åç«¯æ¶æ„è®¾è®¡

### 1. æ ¸å¿ƒæ¨¡å—

#### 1.1 æ•°æ®æ¨¡å‹å±‚ (models.py)

**åŠŸèƒ½ï¼š** å®šä¹‰æ‰€æœ‰æ•°æ®ç»“æ„å’Œç±»å‹

**æ ¸å¿ƒæ¨¡å‹ï¼š**
- `User` - ç”¨æˆ·æ¨¡å‹ï¼ˆåŒ…å« IDã€ç±»å‹ã€ç”¨æˆ·åã€å¯†ç å“ˆå¸Œã€ä¸ªäººèµ„æ–™ï¼‰
- `UserProfile` - ç”¨æˆ·èµ„æ–™ï¼ˆæ˜µç§°ã€æ€§åˆ«ã€å‡ºç”Ÿæ—¥æœŸï¼‰
- `Conversation` - å¯¹è¯æ¨¡å‹ï¼ˆåŒ…å«æ¶ˆæ¯åˆ—è¡¨ã€ä¼šè¯ç±»å‹ã€å®ŒæˆçŠ¶æ€ï¼‰
- `Message` - æ¶ˆæ¯æ¨¡å‹ï¼ˆè§’è‰²ã€å†…å®¹ã€æ—¶é—´æˆ³ã€å¡”ç½—ç‰Œç»“æœï¼‰
- `TarotCard` - å¡”ç½—ç‰Œæ¨¡å‹ï¼ˆç‰ŒIDã€ç‰Œåã€æ˜¯å¦é€†ä½ï¼‰
- `DrawCardsRequest` - æŠ½ç‰Œè¯·æ±‚ï¼ˆç‰Œé˜µç±»å‹ã€ç‰Œæ•°ã€ä½ç½®å«ä¹‰ï¼‰

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ Pydantic BaseModel å®ç°æ•°æ®éªŒè¯
- ä½¿ç”¨ Enum å®šä¹‰æšä¸¾ç±»å‹ï¼ˆUserType, Gender, MessageRole, SessionType, TarotSpreadï¼‰
- ä½¿ç”¨ Field æ·»åŠ é»˜è®¤å€¼å’ŒéªŒè¯è§„åˆ™

#### 1.2 é…ç½®å±‚ (config.py)

**åŠŸèƒ½ï¼š** é›†ä¸­ç®¡ç†æ‰€æœ‰é…ç½®é¡¹

**é…ç½®å†…å®¹ï¼š**
- API å¯†é’¥é…ç½®ï¼ˆGemini API Keyï¼‰
- æ–‡ä»¶è·¯å¾„é…ç½®ï¼ˆæ•°æ®ç›®å½•ã€ç”¨æˆ·æ–‡ä»¶ã€å¯¹è¯æ–‡ä»¶ï¼‰
- CORS é…ç½®ï¼ˆå…è®¸çš„æºï¼‰
- å¡”ç½—ç‰Œæ•°æ®ï¼ˆ78å¼ ç‰Œçš„åç§°åˆ—è¡¨ï¼‰

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ç¯å¢ƒå˜é‡åŠ è½½æ•æ„Ÿé…ç½®
- ä½¿ç”¨ pathlib ç®¡ç†æ–‡ä»¶è·¯å¾„
- è‡ªåŠ¨åˆ›å»ºå¿…è¦çš„ç›®å½•

#### 1.3 å­˜å‚¨æœåŠ¡å±‚ (services/storage_service.py)

**åŠŸèƒ½ï¼š** ç»Ÿä¸€ç®¡ç†æœ¬åœ° JSON æ–‡ä»¶å­˜å‚¨

**æ ¸å¿ƒæ–¹æ³•ï¼š**

**ç”¨æˆ·ç›¸å…³ï¼š**
- `get_user(user_id)` - æ ¹æ® ID è·å–ç”¨æˆ·
- `get_user_by_username(username)` - æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·
- `save_user(user)` - ä¿å­˜ç”¨æˆ·
- `delete_user(user_id)` - åˆ é™¤ç”¨æˆ·

**å¯¹è¯ç›¸å…³ï¼š**
- `get_conversation(conversation_id)` - è·å–å¯¹è¯
- `get_user_conversations(user_id)` - è·å–ç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯
- `save_conversation(conversation)` - ä¿å­˜å¯¹è¯
- `delete_conversation(conversation_id)` - åˆ é™¤å¯¹è¯

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ aiofiles å®ç°å¼‚æ­¥æ–‡ä»¶æ“ä½œï¼Œæé«˜æ€§èƒ½
- æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯å¼‚æ­¥çš„ï¼ˆasync/awaitï¼‰
- ä½¿ç”¨ JSON æ ¼å¼å­˜å‚¨ï¼Œæ˜“äºè°ƒè¯•å’Œè¿ç§»
- å†…éƒ¨ä½¿ç”¨å­—å…¸ä½œä¸ºç´¢å¼•ï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡

#### 1.4 ç”¨æˆ·æœåŠ¡å±‚ (services/user_service.py)

**åŠŸèƒ½ï¼š** å¤„ç†ç”¨æˆ·ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `hash_password(password)` - å¯†ç å“ˆå¸Œ
- `verify_password(plain, hashed)` - å¯†ç éªŒè¯
- `create_guest_user(profile)` - åˆ›å»ºæ¸¸å®¢ç”¨æˆ·
- `create_registered_user(register_data)` - åˆ›å»ºæ³¨å†Œç”¨æˆ·
- `authenticate_user(username, password)` - ç”¨æˆ·è®¤è¯
- `update_user_profile(user_id, profile)` - æ›´æ–°ç”¨æˆ·èµ„æ–™
- `get_user(user_id)` - è·å–ç”¨æˆ·ä¿¡æ¯

**è°ƒç”¨å…³ç³»ï¼š**
```
create_guest_user â†’ generate UUID â†’ save_user (StorageService)
create_registered_user â†’ check username â†’ hash_password â†’ save_user
authenticate_user â†’ get_user_by_username â†’ verify_password
update_user_profile â†’ get_user â†’ save_user
```

**è®¾è®¡æœºåˆ¶ï¼š**
- æ¸¸å®¢ ID ä½¿ç”¨ `guest_` å‰ç¼€ + 12ä½éšæœºå­—ç¬¦
- æ³¨å†Œç”¨æˆ· ID ä½¿ç”¨ `user_` å‰ç¼€ + 12ä½éšæœºå­—ç¬¦
- ä½¿ç”¨ bcrypt ç®—æ³•åŠ å¯†å¯†ç ï¼Œä¿è¯å®‰å…¨æ€§
- æ³¨å†Œæ—¶æ£€æŸ¥ç”¨æˆ·åå”¯ä¸€æ€§

#### 1.5 å¯¹è¯æœåŠ¡å±‚ (services/conversation_service.py)

**åŠŸèƒ½ï¼š** ç®¡ç†å¯¹è¯ç”Ÿå‘½å‘¨æœŸå’Œæ¶ˆæ¯

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `create_conversation(user_id, session_type)` - åˆ›å»ºæ–°å¯¹è¯
- `get_conversation(conversation_id)` - è·å–å¯¹è¯
- `get_user_conversations(user_id)` - è·å–ç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯
- `add_message(conversation_id, role, content, ...)` - æ·»åŠ æ¶ˆæ¯
- `update_conversation_title(conversation_id, title)` - æ›´æ–°æ ‡é¢˜
- `mark_cards_drawn(conversation_id)` - æ ‡è®°å·²æŠ½ç‰Œ
- `mark_completed(conversation_id)` - æ ‡è®°å·²å®Œæˆ
- `delete_conversation(conversation_id)` - åˆ é™¤å¯¹è¯

**è°ƒç”¨å…³ç³»ï¼š**
```
create_conversation â†’ generate UUID â†’ save_conversation
add_message â†’ get_conversation â†’ append message â†’ update timestamp â†’ save_conversation
mark_cards_drawn â†’ get_conversation â†’ set flag â†’ save_conversation
```

**è®¾è®¡æœºåˆ¶ï¼š**
- å¯¹è¯ ID ä½¿ç”¨ `conv_` å‰ç¼€ + 16ä½éšæœºå­—ç¬¦
- è‡ªåŠ¨æ ¹æ®ä¼šè¯ç±»å‹ç”Ÿæˆé»˜è®¤æ ‡é¢˜
- ç”¨æˆ·ç¬¬ä¸€æ¡æ¶ˆæ¯è‡ªåŠ¨ç”Ÿæˆå¯¹è¯æ ‡é¢˜ï¼ˆæˆªå–å‰20å­—ç¬¦ï¼‰
- æ¯æ¬¡æ·»åŠ æ¶ˆæ¯éƒ½æ›´æ–° `updated_at` æ—¶é—´æˆ³
- ä½¿ç”¨ `has_drawn_cards` æ ‡è®°é˜²æ­¢é‡å¤æŠ½ç‰Œ
- ä½¿ç”¨ `is_completed` æ ‡è®°å®ŒæˆçŠ¶æ€

#### 1.6 Gemini AI æœåŠ¡å±‚ (services/gemini_service.py)

**åŠŸèƒ½ï¼š** ä¸ Gemini API äº¤äº’ï¼Œå®ç° AI å¯¹è¯å’Œå¡”ç½—è§£è¯»

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `_build_user_context(user)` - æ„å»ºç”¨æˆ·ä¸Šä¸‹æ–‡ä¿¡æ¯
- `_format_messages_for_gemini(messages, user)` - æ ¼å¼åŒ–æ¶ˆæ¯
- `stream_response(messages, user)` - æµå¼ç”Ÿæˆå›å¤ï¼ˆå¼‚æ­¥ç”Ÿæˆå™¨ï¼‰
- `extract_draw_cards_instruction(text)` - æå–æŠ½ç‰ŒæŒ‡ä»¤
- `remove_draw_cards_tags(text)` - ç§»é™¤æŠ½ç‰Œæ ‡ç­¾

**ç³»ç»Ÿæç¤ºè¯ï¼ˆTAROT_SYSTEM_PROMPTï¼‰ï¼š**
```
ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„å¡”ç½—å åœå¸ˆå’Œå‘½ç†å¸ˆ...
1. é¦–æ¬¡å¯¹è¯æ—¶ï¼Œå¼•å¯¼ç”¨æˆ·è¯´å‡ºé—®é¢˜
2. åˆ†æé—®é¢˜ï¼Œå†³å®šç‰Œé˜µå’Œç‰Œæ•°
3. åœ¨<draw_cards>æ ‡ç­¾ä¸­è¿”å›æŠ½ç‰ŒæŒ‡ä»¤
4. æ”¶åˆ°æŠ½ç‰Œç»“æœåï¼Œè¿›è¡Œä¸“ä¸šè§£è¯»
5. è§£è¯»å®Œæ¯•åï¼Œè¯¢é—®æ˜¯å¦ç»§ç»­æ¢è®¨
6. ä¸èƒ½å†æ¬¡æŠ½ç‰Œ
```

**è°ƒç”¨å…³ç³»ï¼š**
```
stream_response â†’ _format_messages_for_gemini â†’ _build_user_context
              â†’ model.start_chat â†’ send_message_async â†’ yield chunks
              
extract_draw_cards_instruction â†’ regex search â†’ parse JSON
```

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨è‡ªå®šä¹‰æ ‡ç­¾ `<draw_cards>...</draw_cards>` ä¼ é€’æŠ½ç‰ŒæŒ‡ä»¤
- æŠ½ç‰ŒæŒ‡ä»¤ä½¿ç”¨ JSON æ ¼å¼ï¼ŒåŒ…å« spread_typeã€card_countã€positions
- ç”¨æˆ·èµ„æ–™ï¼ˆæ˜µç§°ã€æ€§åˆ«ã€ç”Ÿæ—¥ï¼‰ä¼šè¢«æ·»åŠ åˆ°ç³»ç»Ÿæç¤ºä¸­ï¼Œç”¨äºä¸ªæ€§åŒ–
- ä½¿ç”¨æµå¼è¾“å‡ºï¼ˆAsyncGeneratorï¼‰ï¼Œå®ç°æ‰“å­—æœºæ•ˆæœ
- å†å²æ¶ˆæ¯ä¼šè¢«å®Œæ•´ä¼ é€’ç»™ AIï¼Œä¿æŒä¸Šä¸‹æ–‡è¿è´¯æ€§
- æŠ½ç‰Œç»“æœä¼šè¢«æ ¼å¼åŒ–æ·»åŠ åˆ°æ¶ˆæ¯ä¸­ï¼ŒåŒ…å«ä½ç½®ã€ç‰Œåã€æ­£é€†ä½

#### 1.7 å¡”ç½—ç‰ŒæœåŠ¡å±‚ (services/tarot_service.py)

**åŠŸèƒ½ï¼š** å¤„ç†å¡”ç½—ç‰ŒæŠ½ç‰Œé€»è¾‘

**æ ¸å¿ƒæ–¹æ³•ï¼š**
- `draw_cards(draw_request)` - æŠ½å–å¡”ç½—ç‰Œ
- `get_all_cards()` - è·å–æ‰€æœ‰å¡”ç½—ç‰Œåç§°
- `get_card_name(card_id)` - æ ¹æ®IDè·å–ç‰Œå

**æŠ½ç‰Œç®—æ³•ï¼š**
```python
1. ç”Ÿæˆ0-77çš„å®Œæ•´ç‰Œç»„ï¼ˆ78å¼ ï¼‰
2. ä½¿ç”¨ random.shuffle æ´—ç‰Œ
3. æŠ½å–å‰ N å¼ ç‰Œ
4. æ¯å¼ ç‰Œæœ‰30%æ¦‚ç‡é€†ä½
5. è¿”å› TarotCard å¯¹è±¡åˆ—è¡¨
```

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ Python å†…ç½® random æ¨¡å—å®ç°éšæœºæŠ½ç‰Œ
- ç‰Œ ID ä» 0-77 å¯¹åº” TAROT_CARDS åˆ—è¡¨
- é€†ä½æ¦‚ç‡è®¾ç½®ä¸º 30%ï¼Œç¬¦åˆå¡”ç½—å åœæƒ¯ä¾‹
- æŠ½ç‰Œç»“æœåŒ…å«ç‰Œ IDã€ç‰Œåã€é€†ä½çŠ¶æ€

### 2. API è·¯ç”±å±‚

#### 2.1 ç”¨æˆ·è·¯ç”± (routers/users.py)

**ç«¯ç‚¹ï¼š**
- `POST /api/users/guest` - åˆ›å»ºæ¸¸å®¢ç”¨æˆ·
- `POST /api/users/register` - ç”¨æˆ·æ³¨å†Œ
- `POST /api/users/login` - ç”¨æˆ·ç™»å½•
- `GET /api/users/{user_id}` - è·å–ç”¨æˆ·ä¿¡æ¯
- `PUT /api/users/{user_id}/profile` - æ›´æ–°ç”¨æˆ·èµ„æ–™

**è°ƒç”¨æµç¨‹ï¼š**
```
POST /api/users/register
  â†’ UserService.create_registered_user
  â†’ UserService.hash_password
  â†’ StorageService.save_user
  â†’ è¿”å› Userï¼ˆä¸åŒ…å«å¯†ç å“ˆå¸Œï¼‰
```

**è®¾è®¡æœºåˆ¶ï¼š**
- æ‰€æœ‰è¿”å›çš„ User å¯¹è±¡éƒ½ä¸åŒ…å« password_hashï¼ˆå®‰å…¨è€ƒè™‘ï¼‰
- ä½¿ç”¨ HTTPException ç»Ÿä¸€é”™è¯¯å¤„ç†
- ç™»å½•å¤±è´¥è¿”å› 401 çŠ¶æ€ç 
- ç”¨æˆ·ä¸å­˜åœ¨è¿”å› 404 çŠ¶æ€ç 

#### 2.2 å¯¹è¯è·¯ç”± (routers/conversations.py)

**ç«¯ç‚¹ï¼š**
- `POST /api/conversations?user_id={user_id}` - åˆ›å»ºæ–°å¯¹è¯
- `GET /api/conversations/{conversation_id}` - è·å–å¯¹è¯è¯¦æƒ…
- `GET /api/conversations/user/{user_id}` - è·å–ç”¨æˆ·çš„æ‰€æœ‰å¯¹è¯
- `PUT /api/conversations/title` - æ›´æ–°å¯¹è¯æ ‡é¢˜
- `DELETE /api/conversations/{conversation_id}` - åˆ é™¤å¯¹è¯

**è°ƒç”¨æµç¨‹ï¼š**
```
POST /api/conversations
  â†’ ConversationService.create_conversation
  â†’ StorageService.save_conversation
  â†’ è¿”å› Conversation
```

**è®¾è®¡æœºåˆ¶ï¼š**
- åˆ›å»ºå¯¹è¯æ—¶é€šè¿‡ query å‚æ•°ä¼ é€’ user_id
- è·å–ç”¨æˆ·å¯¹è¯æ—¶æŒ‰ updated_at å€’åºæ’åº
- åˆ é™¤å¯¹è¯è¿”å›æˆåŠŸæ¶ˆæ¯

#### 2.3 å¡”ç½—è·¯ç”± (routers/tarot.py)

**ç«¯ç‚¹ï¼š**
- `POST /api/tarot/message` - å‘é€æ¶ˆæ¯å¹¶è·å–AIæµå¼å›å¤
- `POST /api/tarot/draw?conversation_id={id}` - æŠ½å–å¡”ç½—ç‰Œ
- `GET /api/tarot/cards` - è·å–æ‰€æœ‰å¡”ç½—ç‰Œ

**æ ¸å¿ƒåŠŸèƒ½ - æµå¼æ¶ˆæ¯ï¼š**

```python
POST /api/tarot/message
  1. è·å–å¯¹è¯
  2. æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  3. è°ƒç”¨ GeminiService.stream_response
  4. æµå¼è¿”å› AI å›å¤ï¼ˆSSE æ ¼å¼ï¼‰
  5. æ£€æµ‹æ˜¯å¦åŒ…å«æŠ½ç‰ŒæŒ‡ä»¤
  6. å¦‚æœæœ‰æŠ½ç‰ŒæŒ‡ä»¤ï¼Œå‘é€ draw_cards äº‹ä»¶
  7. ä¿å­˜ AI æ¶ˆæ¯
```

**æµå¼å“åº”æ ¼å¼ï¼ˆServer-Sent Eventsï¼‰ï¼š**
```
data: {"content": "æ–‡æœ¬å†…å®¹"}\n\n
data: {"draw_cards": {...}}\n\n
data: [DONE]\n\n
```

**è°ƒç”¨æµç¨‹ï¼š**
```
POST /api/tarot/draw
  â†’ ConversationService.get_conversation
  â†’ æ£€æŸ¥ has_drawn_cards
  â†’ TarotService.draw_cards
  â†’ ConversationService.add_message (SYSTEM role)
  â†’ ConversationService.mark_cards_drawn
  â†’ è¿”å› DrawCardsResponse
```

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ StreamingResponse å®ç°æµå¼è¾“å‡º
- ä½¿ç”¨ SSEï¼ˆServer-Sent Eventsï¼‰åè®®
- æŠ½ç‰Œå‰æ£€æŸ¥ has_drawn_cards é˜²æ­¢é‡å¤æŠ½ç‰Œ
- æŠ½ç‰Œç»“æœä»¥ SYSTEM è§’è‰²ä¿å­˜ï¼Œä¸åœ¨å‰ç«¯æ˜¾ç¤º
- æŠ½ç‰ŒæŒ‡ä»¤ä» AI å›å¤ä¸­æå–å¹¶ç§»é™¤ï¼Œä¸æ˜¾ç¤ºç»™ç”¨æˆ·

### 3. ä¸»åº”ç”¨ (main.py)

**åŠŸèƒ½ï¼š** FastAPI åº”ç”¨å…¥å£

**é…ç½®ï¼š**
- CORS ä¸­é—´ä»¶ï¼ˆå…è®¸å‰ç«¯è·¨åŸŸè¯·æ±‚ï¼‰
- è·¯ç”±æ³¨å†Œï¼ˆusers, conversations, tarotï¼‰
- å¥åº·æ£€æŸ¥ç«¯ç‚¹

**ç«¯ç‚¹ï¼š**
- `GET /` - æ ¹è·¯å¾„ï¼Œè¿”å›APIä¿¡æ¯
- `GET /health` - å¥åº·æ£€æŸ¥
- `GET /docs` - Swagger UI æ–‡æ¡£

---

## å‰ç«¯æ¶æ„è®¾è®¡

### 1. çŠ¶æ€ç®¡ç†

#### 1.1 è®¤è¯çŠ¶æ€ (stores/useAuthStore.ts)

**åŠŸèƒ½ï¼š** ç®¡ç†ç”¨æˆ·ç™»å½•çŠ¶æ€

**çŠ¶æ€ï¼š**
- `user: User | null` - å½“å‰ç™»å½•ç”¨æˆ·
- `setUser(user)` - è®¾ç½®ç”¨æˆ·
- `logout()` - é€€å‡ºç™»å½•

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ Zustand persist ä¸­é—´ä»¶æŒä¹…åŒ–åˆ° localStorage
- å­˜å‚¨é”®åä¸º `auth-storage`
- é€€å‡ºç™»å½•æ—¶æ¸…ç©ºç”¨æˆ·ä¿¡æ¯

#### 1.2 å¯¹è¯çŠ¶æ€ (stores/useConversationStore.ts)

**åŠŸèƒ½ï¼š** ç®¡ç†å¯¹è¯åˆ—è¡¨å’Œå½“å‰å¯¹è¯

**çŠ¶æ€ï¼š**
- `conversations: Conversation[]` - å¯¹è¯åˆ—è¡¨
- `currentConversation: Conversation | null` - å½“å‰å¯¹è¯
- `setConversations` - è®¾ç½®å¯¹è¯åˆ—è¡¨
- `setCurrentConversation` - è®¾ç½®å½“å‰å¯¹è¯
- `addConversation` - æ·»åŠ å¯¹è¯ï¼ˆæ’å…¥åˆ°åˆ—è¡¨å¤´éƒ¨ï¼‰
- `updateConversation` - æ›´æ–°å¯¹è¯
- `removeConversation` - ç§»é™¤å¯¹è¯

**è®¾è®¡æœºåˆ¶ï¼š**
- ä¸æŒä¹…åŒ–åˆ° localStorageï¼Œæ¯æ¬¡ç™»å½•åä»æœåŠ¡å™¨åŠ è½½
- æ·»åŠ å¯¹è¯æ—¶æ’å…¥åˆ°åˆ—è¡¨å¤´éƒ¨ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
- æ›´æ–°å¯¹è¯æ—¶åŒæ—¶æ›´æ–°åˆ—è¡¨å’Œå½“å‰å¯¹è¯ï¼ˆå¦‚æœåŒ¹é…ï¼‰

### 2. API æœåŠ¡å±‚ (services/api.ts)

#### 2.1 ç”¨æˆ· API (userApi)

**æ–¹æ³•ï¼š**
- `createGuest(profile)` - åˆ›å»ºæ¸¸å®¢
- `register(username, password, profile)` - æ³¨å†Œ
- `login(username, password)` - ç™»å½•
- `getUser(userId)` - è·å–ç”¨æˆ·ä¿¡æ¯
- `updateProfile(userId, profile)` - æ›´æ–°èµ„æ–™

#### 2.2 å¯¹è¯ API (conversationApi)

**æ–¹æ³•ï¼š**
- `create(userId, sessionType)` - åˆ›å»ºå¯¹è¯
- `get(conversationId)` - è·å–å¯¹è¯
- `getUserConversations(userId)` - è·å–ç”¨æˆ·å¯¹è¯åˆ—è¡¨
- `updateTitle(conversationId, title)` - æ›´æ–°æ ‡é¢˜
- `delete(conversationId)` - åˆ é™¤å¯¹è¯

#### 2.3 å¡”ç½— API (tarotApi)

**æ–¹æ³•ï¼š**
- `sendMessage(conversationId, content, onChunk, onDrawCards)` - å‘é€æ¶ˆæ¯
- `drawCards(conversationId, drawRequest)` - æŠ½ç‰Œ
- `getAllCards()` - è·å–æ‰€æœ‰å¡”ç½—ç‰Œ

**æµå¼æ¶ˆæ¯å¤„ç†ï¼š**
```javascript
sendMessage æµç¨‹ï¼š
1. ä½¿ç”¨ fetch API å‘é€è¯·æ±‚
2. è·å– response.body.getReader()
3. ä½¿ç”¨ TextDecoder è§£ç å­—èŠ‚æµ
4. æŒ‰è¡Œåˆ†å‰²ï¼Œè§£æ SSE æ ¼å¼
5. å¦‚æœæ˜¯ contentï¼Œè°ƒç”¨ onChunk å›è°ƒ
6. å¦‚æœæ˜¯ draw_cardsï¼Œè°ƒç”¨ onDrawCards å›è°ƒ
7. é‡åˆ° [DONE] ç»“æŸ
```

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ Axios å¤„ç†æ™®é€š HTTP è¯·æ±‚
- ä½¿ç”¨åŸç”Ÿ Fetch API å¤„ç†æµå¼è¯·æ±‚
- æµå¼æ¶ˆæ¯ä½¿ç”¨å›è°ƒå‡½æ•°å®æ—¶å¤„ç†æ•°æ®å—
- é”™è¯¯å¤„ç†ç»Ÿä¸€æŠ›å‡ºå¼‚å¸¸

### 3. UI ç»„ä»¶

#### 3.1 ä¾§è¾¹æ ç»„ä»¶ (Sidebar.tsx)

**åŠŸèƒ½ï¼š** æ˜¾ç¤ºå¯¹è¯åˆ—è¡¨å’ŒåŠŸèƒ½æŒ‰é’®

**Propsï¼š**
- `conversations` - å¯¹è¯åˆ—è¡¨
- `currentConversationId` - å½“å‰å¯¹è¯ID
- `onNewConversation` - æ–°å»ºå¯¹è¯å›è°ƒ
- `onSelectConversation` - é€‰æ‹©å¯¹è¯å›è°ƒ
- `onDeleteConversation` - åˆ é™¤å¯¹è¯å›è°ƒ
- `onOpenSettings` - æ‰“å¼€è®¾ç½®å›è°ƒ

**UI ç»“æ„ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [+ æ–°å åœ]      â”‚  <- Header
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å¯¹è¯1 [åˆ é™¤]    â”‚
â”‚  å¯¹è¯2 [åˆ é™¤]    â”‚  <- å¯¹è¯åˆ—è¡¨ï¼ˆå¯æ»šåŠ¨ï¼‰
â”‚  å¯¹è¯3 [åˆ é™¤]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [âš™ï¸ è®¾ç½®]       â”‚  <- Footer
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’ï¼š**
- é¼ æ ‡æ‚¬åœæ˜¾ç¤ºåˆ é™¤æŒ‰é’®
- å½“å‰å¯¹è¯é«˜äº®æ˜¾ç¤º
- å¯¹è¯æŒ‰æ›´æ–°æ—¶é—´æ’åº
- æ—¶é—´æ˜¾ç¤ºç›¸å¯¹æ—¶é—´ï¼ˆä»Šå¤©ã€æ˜¨å¤©ã€Nå¤©å‰ï¼‰

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ Framer Motion å®ç°è¿›å…¥åŠ¨ç”»
- ä½¿ç”¨ group-hover å®ç°æ‚¬åœæ•ˆæœ
- åˆ é™¤æ—¶é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼ˆstopPropagationï¼‰

#### 3.2 èŠå¤©æ¶ˆæ¯ç»„ä»¶ (ChatMessage.tsx)

**åŠŸèƒ½ï¼š** æ˜¾ç¤ºå•æ¡æ¶ˆæ¯

**Propsï¼š**
- `message: Message` - æ¶ˆæ¯å¯¹è±¡

**UI ç»“æ„ï¼š**
```
ç”¨æˆ·æ¶ˆæ¯ï¼ˆå³ä¾§ï¼‰:
[å¤´åƒ]  [æ¶ˆæ¯æ°”æ³¡]  [æ—¶é—´]

AIæ¶ˆæ¯ï¼ˆå·¦ä¾§ï¼‰:
[æ—¶é—´]  [æ¶ˆæ¯æ°”æ³¡]  [å¤´åƒ]

å¦‚æœæœ‰å¡”ç½—ç‰Œç»“æœï¼Œåœ¨æ¶ˆæ¯ä¸‹æ–¹æ˜¾ç¤ºï¼š
æŠ½åˆ°çš„ç‰Œï¼š
ä½ç½®1: ç‰Œå (æ­£/é€†ä½)
ä½ç½®2: ç‰Œå (æ­£/é€†ä½)
```

**è®¾è®¡æœºåˆ¶ï¼š**
- ç”¨æˆ·æ¶ˆæ¯ä½¿ç”¨ä¸»é¢˜è‰²èƒŒæ™¯ï¼ŒAIæ¶ˆæ¯ä½¿ç”¨æš—è‰²èƒŒæ™¯
- ä½¿ç”¨ Framer Motion å®ç°æ·¡å…¥åŠ¨ç”»
- ç³»ç»Ÿæ¶ˆæ¯ä¸æ˜¾ç¤ºï¼ˆrole === 'system'ï¼‰
- æ”¯æŒæ˜¾ç¤ºæŠ½ç‰Œç»“æœå’Œä½ç½®å«ä¹‰

#### 3.3 èŠå¤©è¾“å…¥ç»„ä»¶ (ChatInput.tsx)

**åŠŸèƒ½ï¼š** æ¶ˆæ¯è¾“å…¥æ¡†

**Propsï¼š**
- `onSend(message)` - å‘é€æ¶ˆæ¯å›è°ƒ
- `disabled` - æ˜¯å¦ç¦ç”¨
- `placeholder` - å ä½ç¬¦æ–‡æœ¬

**äº¤äº’ï¼š**
- å›è½¦é”®å‘é€æ¶ˆæ¯
- å‘é€æŒ‰é’®åŠ¨ç”»æ•ˆæœï¼ˆhover æ”¾å¤§ï¼Œtap ç¼©å°ï¼‰
- å‘é€åè‡ªåŠ¨æ¸…ç©ºè¾“å…¥æ¡†
- ç¦ç”¨æ—¶æ˜¾ç¤ºä¸å¯ç”¨çŠ¶æ€

#### 3.4 ä¼šè¯æŒ‰é’®ç»„ä»¶ (SessionButtons.tsx)

**åŠŸèƒ½ï¼š** é€‰æ‹©ä¼šè¯ç±»å‹ï¼ˆå¡”ç½—ã€æ˜Ÿç›˜ã€èŠæ„ˆï¼‰

**Propsï¼š**
- `onSelectSession(sessionType)` - é€‰æ‹©ä¼šè¯å›è°ƒ
- `disabled` - æ˜¯å¦ç¦ç”¨

**UI ç»“æ„ï¼š**
```
[å¡”ç½—å åœ]  [æ˜Ÿç›˜è§£è¯»]  [èŠæ„ˆ]
    âœ¨         â­        ğŸ’¬
```

**è®¾è®¡æœºåˆ¶ï¼š**
- æ¯ä¸ªæŒ‰é’®æœ‰ç‹¬ç‰¹çš„æ¸å˜è‰²
- hover æ—¶æ”¾å¤§å¹¶ä¸Šç§»
- æ˜Ÿç›˜å’ŒèŠæ„ˆæ ‡è®°ä¸º"å³å°†æ¨å‡º"
- å³å°†æ¨å‡ºçš„æŒ‰é’®ç¦ç”¨å¹¶æ˜¾ç¤ºæç¤º

#### 3.5 å¡”ç½—ç‰ŒæŠ½ç‰Œå™¨ç»„ä»¶ (TarotCardDrawer.tsx)

**åŠŸèƒ½ï¼š** å¡”ç½—ç‰ŒæŠ½ç‰ŒåŠ¨ç”»å’Œäº¤äº’

**Propsï¼š**
- `isOpen` - æ˜¯å¦æ‰“å¼€
- `drawRequest` - æŠ½ç‰Œè¯·æ±‚
- `onClose` - å…³é—­å›è°ƒ
- `onCardsDrawn(cards)` - æŠ½ç‰Œå®Œæˆå›è°ƒ

**äº¤äº’æµç¨‹ï¼š**
```
1. æ‰“å¼€å¼¹çª— â†’ æ˜¾ç¤º"å¼€å§‹æ´—ç‰Œ"æŒ‰é’®
2. ç‚¹å‡»æ´—ç‰Œ â†’ æ’­æ”¾æ´—ç‰ŒåŠ¨ç”»ï¼ˆ2ç§’ï¼‰
3. æ´—ç‰Œå®Œæˆ â†’ ç‰Œä»¥æ‰‡å½¢å±•å¼€
4. ç”¨æˆ·ç‚¹å‡»ç‰Œ â†’ ç‰Œè¢«é€‰ä¸­å¹¶é«˜äº®
5. é€‰å¤ŸæŒ‡å®šæ•°é‡ â†’ æ˜¾ç¤º"ç¡®è®¤æŠ½ç‰Œ"æŒ‰é’®
6. ç¡®è®¤æŠ½ç‰Œ â†’ ç‰Œç§»åŠ¨åˆ°é¡¶éƒ¨å¡æ§½
7. å»¶è¿Ÿ1.5ç§’ â†’ å…³é—­å¹¶è¿”å›ç»“æœ
```

**UI ç»“æ„ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æŠ½å–å¡”ç½—ç‰Œ            [X]    â”‚  <- Header
â”‚  è¯·é€‰æ‹©3å¼ ç‰Œ (å·²é€‰2å¼ )        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [å¡æ§½1] [å¡æ§½2] [å¡æ§½3]      â”‚  <- é¡¶éƒ¨å¡æ§½
â”‚                              â”‚
â”‚       ğŸ´ğŸ´ğŸ´ğŸ´ğŸ´              â”‚  <- æ‰‡å½¢å±•å¼€çš„ç‰Œ
â”‚      ğŸ´       ğŸ´             â”‚
â”‚     ğŸ´         ğŸ´            â”‚
â”‚                              â”‚
â”‚     [ç¡®è®¤æŠ½ç‰Œ]               â”‚  <- ç¡®è®¤æŒ‰é’®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ´—ç‰ŒåŠ¨ç”»ï¼š**
- 10å¼ ç‰Œåœ¨ä¸­å¿ƒæ—‹è½¬ã€ç¼©æ”¾ã€ç§»åŠ¨
- æ¯å¼ ç‰Œæœ‰ä¸åŒçš„å»¶è¿Ÿå’Œè·¯å¾„

**æ‰‡å½¢å±•å¼€ç®—æ³•ï¼š**
```javascript
78å¼ ç‰Œæ’åˆ—æˆ180åº¦æ‰‡å½¢ï¼š
- è§’åº¦èŒƒå›´ï¼š-90Â° ~ 90Â°
- åŠå¾„ï¼š400px
- Yè½´å‹ç¼©ï¼š0.6å€ï¼ˆæ¤­åœ†æ•ˆæœï¼‰
- æ¯å¼ ç‰Œæ—‹è½¬ï¼šangle + 90Â°
```

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨ Framer Motion å®ç°æ‰€æœ‰åŠ¨ç”»
- ç‚¹å‡»èƒŒæ™¯å…³é—­ï¼ˆæ´—ç‰Œæ—¶ç¦ç”¨ï¼‰
- é€‰ä¸­çš„ç‰Œæ”¾å¤§å¹¶ä¸Šç§»
- ä½¿ç”¨åŠé€æ˜é»‘è‰²èƒŒæ™¯+æ¨¡ç³Šæ•ˆæœ
- å¡æ§½æ˜¾ç¤ºä½ç½®åç§°æˆ–åºå·

#### 3.6 è®¤è¯å¼¹çª—ç»„ä»¶ (AuthModal.tsx)

**åŠŸèƒ½ï¼š** ç”¨æˆ·ç™»å½•/æ³¨å†Œ

**Propsï¼š**
- `isOpen` - æ˜¯å¦æ‰“å¼€
- `onClose` - å…³é—­å›è°ƒ
- `onGuestLogin(profile)` - æ¸¸å®¢ç™»å½•å›è°ƒ
- `onRegister(username, password, profile)` - æ³¨å†Œå›è°ƒ
- `onLogin(username, password)` - ç™»å½•å›è°ƒ

**æ¨¡å¼åˆ‡æ¢ï¼š**
```
choice (é€‰æ‹©) â†’ guest (æ¸¸å®¢)
             â†’ register (æ³¨å†Œ)
             â†’ login (ç™»å½•)
```

**UI ç»“æ„ï¼ˆé€‰æ‹©æ¨¡å¼ï¼‰ï¼š**
```
æ¬¢è¿æ¥åˆ°å¡”ç½—å åœ

[æ¸¸å®¢æ¨¡å¼]
 å¿«é€Ÿå¼€å§‹ï¼Œä½†ä¸ä¿å­˜å†å²è®°å½•

[æ³¨å†Œè´¦å·]
 ä¿å­˜å†å²è®°å½•ï¼Œéšæ—¶æŸ¥çœ‹

[å·²æœ‰è´¦å·ï¼Ÿç«‹å³ç™»å½•]
```

**è®¾è®¡æœºåˆ¶ï¼š**
- ä½¿ç”¨çŠ¶æ€æœºç®¡ç†æ¨¡å¼åˆ‡æ¢
- æ¸¸å®¢æ¨¡å¼å¯å¡«å†™æ˜µç§°ï¼ˆå¯é€‰ï¼‰
- æ³¨å†Œ/ç™»å½•éœ€è¦ç”¨æˆ·åå’Œå¯†ç 
- ä½¿ç”¨å›¾æ ‡å¢å¼ºè¾“å…¥æ¡†è§†è§‰æ•ˆæœ
- è¡¨å•æäº¤åè‡ªåŠ¨å…³é—­å¼¹çª—

### 4. ä¸»åº”ç”¨ (App.tsx)

**åŠŸèƒ½ï¼š** åº”ç”¨ä¸»å…¥å£ï¼Œæ•´åˆæ‰€æœ‰ç»„ä»¶å’Œé€»è¾‘

**çŠ¶æ€ï¼š**
- `showAuthModal` - æ˜¯å¦æ˜¾ç¤ºè®¤è¯å¼¹çª—
- `showSettings` - æ˜¯å¦æ˜¾ç¤ºè®¾ç½®
- `isLoading` - æ˜¯å¦åŠ è½½ä¸­
- `streamingMessage` - æµå¼è¾“å‡ºçš„æ¶ˆæ¯
- `showCardDrawer` - æ˜¯å¦æ˜¾ç¤ºæŠ½ç‰Œå™¨
- `pendingDrawRequest` - å¾…å¤„ç†çš„æŠ½ç‰Œè¯·æ±‚

**ç”Ÿå‘½å‘¨æœŸï¼š**
```
1. ç»„ä»¶æŒ‚è½½ â†’ æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
   - æœªç™»å½• â†’ æ˜¾ç¤ºè®¤è¯å¼¹çª—
   - å·²ç™»å½• â†’ åŠ è½½ç”¨æˆ·å¯¹è¯åˆ—è¡¨

2. ç”¨æˆ·ç™»å½•æˆåŠŸ â†’ åŠ è½½å¯¹è¯åˆ—è¡¨ â†’ éšè—è®¤è¯å¼¹çª—

3. é€‰æ‹©ä¼šè¯ç±»å‹ â†’ åˆ›å»ºæ–°å¯¹è¯ â†’ è‡ªåŠ¨å‘é€åˆå§‹æ¶ˆæ¯

4. ç”¨æˆ·å‘é€æ¶ˆæ¯ â†’ æµå¼æ¥æ”¶AIå›å¤ â†’ æ£€æµ‹æŠ½ç‰ŒæŒ‡ä»¤
   - æœ‰æŠ½ç‰ŒæŒ‡ä»¤ â†’ æ‰“å¼€æŠ½ç‰Œå™¨
   - æ— æŠ½ç‰ŒæŒ‡ä»¤ â†’ æ­£å¸¸æ˜¾ç¤ºå›å¤

5. ç”¨æˆ·æŠ½ç‰Œ â†’ ä¿å­˜æŠ½ç‰Œç»“æœ â†’ è‡ªåŠ¨å‘é€è§£è¯»è¯·æ±‚

6. æ¶ˆæ¯æ›´æ–° â†’ è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
```

**æ ¸å¿ƒæ–¹æ³•ï¼š**

**handleSelectSession(sessionType):**
```
1. åˆ›å»ºæ–°å¯¹è¯ï¼ˆAPI è°ƒç”¨ï¼‰
2. æ·»åŠ åˆ°å¯¹è¯åˆ—è¡¨
3. è®¾ç½®ä¸ºå½“å‰å¯¹è¯ï¼ˆReact çŠ¶æ€æ›´æ–°ï¼‰
4. å¦‚æœæ˜¯å¡”ç½—å åœï¼š
   a. éšæœºé€‰æ‹©ä¸€ç§å¼€åœºç™½ï¼ˆ5ç§ï¼‰
   b. ç›´æ¥ä½¿ç”¨ newConv.conversation_id å‘é€æ¶ˆæ¯
   c. è®¾ç½® loading çŠ¶æ€
   d. è°ƒç”¨ tarotApi.sendMessageï¼ˆæµå¼æ¥æ”¶ï¼‰
   e. åˆ·æ–°å¯¹è¯å¹¶æ›´æ–°çŠ¶æ€
```

**é‡è¦**ï¼šç›´æ¥ä½¿ç”¨ `newConv.conversation_id` è€Œä¸æ˜¯ä¾èµ– `currentConversation` çŠ¶æ€ï¼Œé¿å… JavaScript é—­åŒ…æ•è·æ—§çŠ¶æ€çš„é—®é¢˜ã€‚è¿™æ˜¯å¤„ç† React å¼‚æ­¥çŠ¶æ€æ›´æ–°çš„æ­£ç¡®æ–¹å¼ã€‚

**handleSendMessage(content):**
```
1. è®¾ç½®åŠ è½½çŠ¶æ€
2. è°ƒç”¨ tarotApi.sendMessage
3. å®æ—¶æ¥æ”¶æ–‡æœ¬å— â†’ æ›´æ–° streamingMessage
4. æ¥æ”¶åˆ°æŠ½ç‰ŒæŒ‡ä»¤ â†’ æ‰“å¼€æŠ½ç‰Œå™¨
5. æµå¼ç»“æŸ â†’ åˆ·æ–°å¯¹è¯ â†’ æ¸…ç©º streamingMessage
```

**handleCardsDrawn(cards):**
```
1. è°ƒç”¨ tarotApi.drawCards ä¿å­˜æŠ½ç‰Œç»“æœï¼ˆSYSTEM æ¶ˆæ¯ï¼‰
2. æ ‡è®° has_drawn_cards = trueï¼ˆé˜²æ­¢é‡å¤æŠ½ç‰Œï¼‰
3. åˆ·æ–°å¯¹è¯
4. æ¸…ç©º pendingDrawRequest
5. å»¶è¿Ÿ0.5ç§’åè‡ªåŠ¨å‘é€"è¯·æ ¹æ®æŠ½ç‰Œç»“æœè¿›è¡Œè§£è¯»"ï¼ˆUSER æ¶ˆæ¯ï¼Œç•Œé¢ä¸æ˜¾ç¤ºï¼‰
6. è§¦å‘ AI æµå¼è§£è¯»
```

**UI å¸ƒå±€ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Sidebar]  â”‚  [Main Content]           â”‚
â”‚            â”‚                            â”‚
â”‚ å¯¹è¯åˆ—è¡¨    â”‚  æ¬¢è¿é¡µé¢                  â”‚
â”‚            â”‚  æˆ–                        â”‚
â”‚            â”‚  èŠå¤©ç•Œé¢                  â”‚
â”‚            â”‚                            â”‚
â”‚ [è®¾ç½®]     â”‚  [è¾“å…¥æ¡†]                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è®¾è®¡æœºåˆ¶ï¼š**
- æ— å½“å‰å¯¹è¯æ—¶æ˜¾ç¤ºæ¬¢è¿é¡µé¢å’Œä¼šè¯æŒ‰é’®
- æœ‰å½“å‰å¯¹è¯æ—¶æ˜¾ç¤ºèŠå¤©ç•Œé¢
- ä½¿ç”¨ ref å®ç°è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
- æµå¼æ¶ˆæ¯ä½œä¸ºä¸´æ—¶æ¶ˆæ¯æ˜¾ç¤ºï¼Œå®Œæˆåæ›¿æ¢ä¸ºçœŸå®æ¶ˆæ¯
- æŠ½ç‰Œåå…è®¸ç»§ç»­å¯¹è¯å’Œæ·±å…¥æ¢è®¨
- è‡ªåŠ¨è§¦å‘è§£è¯»çš„æ¶ˆæ¯åœ¨ç•Œé¢ä¸Šéšè—ï¼ˆå†…å®¹ä¸º"è¯·æ ¹æ®æŠ½ç‰Œç»“æœè¿›è¡Œè§£è¯»"ï¼‰
- æ‰€æœ‰å¼¹çª—ä½¿ç”¨ AnimatePresence å®ç°è¿›å‡ºåŠ¨ç”»

---

## æ ¸å¿ƒæµç¨‹è¯¦è§£

### 1. ç”¨æˆ·æ³¨å†Œ/ç™»å½•æµç¨‹

```
å‰ç«¯                     åç«¯                      å­˜å‚¨
 â”‚                        â”‚                         â”‚
 â”‚  POST /api/users/register                        â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
 â”‚                        â”‚  hash_password          â”‚
 â”‚                        â”‚  check_username_exists  â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                        â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚                        â”‚  save_user              â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
 â”‚  User (without password_hash)                    â”‚
 â”‚                        â”‚                         â”‚
 â”‚  setUser(user)         â”‚                         â”‚
 â”‚  localStorage.setItem  â”‚                         â”‚
 â”‚                        â”‚                         â”‚
```

### 2. åˆ›å»ºå¯¹è¯æµç¨‹

```
å‰ç«¯                     åç«¯                      å­˜å‚¨
 â”‚                        â”‚                         â”‚
 â”‚  é€‰æ‹©ä¼šè¯ç±»å‹           â”‚                         â”‚
 â”‚  POST /api/conversations?user_id=xxx             â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
 â”‚                        â”‚  generate_conv_id       â”‚
 â”‚                        â”‚  create_conversation    â”‚
 â”‚                        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                         â”‚
 â”‚  Conversation          â”‚                         â”‚
 â”‚                        â”‚                         â”‚
 â”‚  addConversation       â”‚                         â”‚
 â”‚  setCurrentConversationâ”‚                         â”‚
 â”‚                        â”‚                         â”‚
```

### 3. å¡”ç½—å åœå®Œæ•´æµç¨‹

```
å‰ç«¯                         åç«¯                      Gemini API
 â”‚                            â”‚                          â”‚
 â”‚  1. ç”¨æˆ·ç‚¹å‡»"å¡”ç½—å åœ"      â”‚                          â”‚
 â”‚  éšæœºé€‰æ‹©å¼€åœºç™½å‘é€         â”‚                          â”‚
 â”‚  (5ç§ä¸åŒé£æ ¼çš„é—®å€™è¯­)      â”‚                          â”‚
 â”‚  POST /api/tarot/message   â”‚                          â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  add_user_message        â”‚
 â”‚                            â”‚  stream_response         â”‚
 â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚  "æ¬¢è¿...è¯·å‘Šè¯‰æˆ‘ä½ çš„é—®é¢˜"   â”‚                          â”‚
 â”‚                            â”‚                          â”‚
 â”‚  2. ç”¨æˆ·è¾“å…¥å…·ä½“é—®é¢˜        â”‚                          â”‚
 â”‚  POST /api/tarot/message   â”‚                          â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  add_user_message        â”‚
 â”‚                            â”‚  stream_response         â”‚
 â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚  "æˆ‘å»ºè®®ä½¿ç”¨ä¸‰å¼ ç‰Œ..."     â”‚                          â”‚
 â”‚  <draw_cards>{...}</...>   â”‚                          â”‚
 â”‚                            â”‚  extract_draw_instructionâ”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
 â”‚  data: {"draw_cards":{...}}â”‚                          â”‚
 â”‚                            â”‚  add_assistant_message   â”‚
 â”‚                            â”‚  (with draw_request)     â”‚
 â”‚                            â”‚                          â”‚
 â”‚  3. æ‰“å¼€æŠ½ç‰Œå™¨             â”‚                          â”‚
 â”‚  ç”¨æˆ·é€‰æ‹©3å¼ ç‰Œ             â”‚                          â”‚
 â”‚  POST /api/tarot/draw      â”‚                          â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  TarotService.draw_cards â”‚
 â”‚                            â”‚  add_system_message      â”‚
 â”‚                            â”‚  (tarot_cards + draw_request) â”‚
 â”‚                            â”‚  mark_cards_drawn=true   â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                          â”‚
 â”‚  DrawCardsResponse         â”‚                          â”‚
 â”‚                            â”‚                          â”‚
 â”‚  4. è‡ªåŠ¨è§¦å‘è§£è¯»ï¼ˆéšè—ï¼‰   â”‚                          â”‚
 â”‚  POST /api/tarot/message   â”‚                          â”‚
 â”‚  "è¯·æ ¹æ®æŠ½ç‰Œç»“æœè¿›è¡Œè§£è¯»"  â”‚                          â”‚
 â”‚  (ç•Œé¢ä¸æ˜¾ç¤ºæ­¤æ¶ˆæ¯)         â”‚                          â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                          â”‚
 â”‚                            â”‚  add_user_message        â”‚
 â”‚                            â”‚  stream_response         â”‚
 â”‚                            â”‚  format_messages:        â”‚
 â”‚                            â”‚  - [æŠ½ç‰Œç»“æœ] ...ï¼ˆè½¬ä¸ºuserï¼‰â”‚
 â”‚                            â”‚  - "è¯·æ ¹æ®..." (user)    â”‚
 â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                            â”‚  AI çœ‹åˆ°æŠ½ç‰Œç»“æœæ ‡è®°     â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€streamingâ”€â”€â”€â”€â”€â”€â”€â”‚
 â”‚  "æ ¹æ®ä½ æŠ½åˆ°çš„ç‰Œ..."       â”‚  ä¸è¿”å›æŠ½ç‰ŒæŒ‡ä»¤          â”‚
 â”‚  "è¿‡å»ä½ç½®ï¼šæ„šè€…ï¼ˆæ­£ä½ï¼‰..."â”‚                         â”‚
 â”‚  "å»ºè®®..."                 â”‚                          â”‚
 â”‚                            â”‚                          â”‚
 â”‚  5. ç»§ç»­å¤šè½®å¯¹è¯           â”‚                          â”‚
 â”‚  ç”¨æˆ·å¯ä»¥ç»§ç»­æé—®          â”‚                          â”‚
 â”‚  AI å¯ä»¥ç»§ç»­è®¨è®º           â”‚                          â”‚
 â”‚  ä½†ä¸èƒ½å†æ¬¡æŠ½ç‰Œ            â”‚                          â”‚
```

**å…³é”®æœºåˆ¶è¯´æ˜ï¼š**
1. **éšæœºå¼€åœºç™½**ï¼šç‚¹å‡»å¡”ç½—å åœæŒ‰é’®æ—¶ï¼Œéšæœºä»5ç§å¼€åœºç™½ä¸­é€‰æ‹©ä¸€ä¸ªå‘é€ï¼Œæå‡ç”¨æˆ·ä½“éªŒå¤šæ ·æ€§
   - "ä½ å¥½ï¼Œæˆ‘æƒ³è¿›è¡Œä¸€æ¬¡å¡”ç½—å åœ"
   - "æ™šä¸Šå¥½ï¼Œèƒ½å¸®æˆ‘çœ‹çœ‹å¡”ç½—ç‰Œå—ï¼Ÿ"
   - "æˆ‘æƒ³è¯·æ•™ä¸€äº›é—®é¢˜ï¼Œå¯ä»¥å¸®æˆ‘å åœä¸€ä¸‹å—ï¼Ÿ"
   - "æœ€è¿‘æœ‰äº›è¿·èŒ«ï¼Œå¸Œæœ›å¡”ç½—ç‰Œèƒ½ç»™æˆ‘ä¸€äº›æŒ‡å¼•"
   - "ä½ å¥½å‘€ï¼Œæƒ³é€šè¿‡å¡”ç½—ç‰Œäº†è§£ä¸€ä¸‹è‡ªå·±çš„è¿åŠ¿"
2. **æŠ½ç‰Œç»“æœä¼ é€’**ï¼šSYSTEM æ¶ˆæ¯åœ¨å‘é€ç»™ AI æ—¶è½¬æ¢ä¸ºå¸¦ `[æŠ½ç‰Œç»“æœ]` æ ‡è®°çš„ USER æ¶ˆæ¯
3. **é˜²é‡å¤æŠ½ç‰Œ**ï¼šä½¿ç”¨ `has_drawn_cards` æ ‡è®°ï¼Œåç«¯ API ä¼šæ‹’ç»é‡å¤æŠ½ç‰Œè¯·æ±‚
4. **è‡ªåŠ¨è§¦å‘è§£è¯»**ï¼šå‰ç«¯è‡ªåŠ¨å‘é€è§¦å‘æ¶ˆæ¯ï¼Œä½†é€šè¿‡ ChatMessage ç»„ä»¶è¿‡æ»¤ï¼Œä¸æ˜¾ç¤ºåœ¨ç•Œé¢ä¸Š
5. **AI è¯†åˆ«æœºåˆ¶**ï¼šç³»ç»Ÿæç¤ºè¯æ˜ç¡®å‘Šè¯‰ AI çœ‹åˆ° `[æŠ½ç‰Œç»“æœ]` åç›´æ¥è§£è¯»ï¼Œä¸è¦å†æ¬¡è¿”å›æŠ½ç‰ŒæŒ‡ä»¤
6. **ç»§ç»­å¯¹è¯**ï¼šè§£è¯»å®Œæˆåï¼Œç”¨æˆ·ä»å¯ç»§ç»­æé—®å’Œæ·±å…¥æ¢è®¨

### 4. æŠ½ç‰ŒåŠ¨ç”»æµç¨‹

```
1. åˆå§‹çŠ¶æ€
   [å¼€å§‹æ´—ç‰Œ]

2. ç‚¹å‡»æ´—ç‰Œ
   ğŸ´ æ—‹è½¬
   ğŸ´ æ—‹è½¬ç§»åŠ¨
   ğŸ´ æ—‹è½¬ç¼©æ”¾
   ï¼ˆ2ç§’åŠ¨ç”»ï¼‰

3. æ´—ç‰Œå®Œæˆ
   é¡¶éƒ¨æ˜¾ç¤ºå¡æ§½ï¼š
   [ä½ç½®1] [ä½ç½®2] [ä½ç½®3]
   
   åº•éƒ¨æ‰‡å½¢å±•å¼€ï¼š
        ğŸ´ğŸ´ğŸ´
       ğŸ´    ğŸ´
      ğŸ´      ğŸ´

4. ç”¨æˆ·ç‚¹å‡»é€‰ç‰Œ
   é€‰ä¸­çš„ç‰Œï¼š
   - æ”¾å¤§1.3å€
   - ä¸Šç§»20px
   - é»„è‰²å…‰åœˆ
   
   å·²é€‰2/3å¼ 

5. é€‰å¤Ÿæ•°é‡
   æ˜¾ç¤º [ç¡®è®¤æŠ½ç‰Œ] æŒ‰é’®

6. ç¡®è®¤æŠ½ç‰Œ
   é€‰ä¸­çš„ç‰ŒåŠ¨ç”»ç§»åŠ¨åˆ°é¡¶éƒ¨å¡æ§½
   æ˜¾ç¤ºæ­£é€†ä½æ ‡è¯†
   å»¶è¿Ÿ1.5ç§’åå…³é—­
```

---

## é€šç”¨è®¾è®¡æœºåˆ¶

### 1. é”™è¯¯å¤„ç†æœºåˆ¶

**åç«¯ï¼š**
- æ‰€æœ‰è·¯ç”±ä½¿ç”¨ try-except æ•è·å¼‚å¸¸
- ä¸šåŠ¡é€»è¾‘é”™è¯¯æŠ›å‡º ValueErrorï¼Œè·¯ç”±è½¬æ¢ä¸º 400/404/401
- ä½¿ç”¨ HTTPException ç»Ÿä¸€é”™è¯¯å“åº”æ ¼å¼
- æœªé¢„æœŸé”™è¯¯è¿”å› 500 çŠ¶æ€ç 

**å‰ç«¯ï¼š**
- API è°ƒç”¨ä½¿ç”¨ try-catch æ•è·å¼‚å¸¸
- é”™è¯¯ä½¿ç”¨ alert æç¤ºç”¨æˆ·ï¼ˆåç»­å¯æ”¹è¿›ä¸º Toastï¼‰
- é”™è¯¯æ—¶æ¢å¤ UI çŠ¶æ€ï¼ˆå–æ¶ˆåŠ è½½çŠ¶æ€ç­‰ï¼‰

### 2. æ•°æ®æŒä¹…åŒ–æœºåˆ¶

**åç«¯æœ¬åœ°å­˜å‚¨ï¼š**
- ä½¿ç”¨ JSON æ–‡ä»¶å­˜å‚¨ç”¨æˆ·å’Œå¯¹è¯æ•°æ®
- æ–‡ä»¶è·¯å¾„ï¼š`backend/data/users.json`ã€`backend/data/conversations.json`
- ä½¿ç”¨å¼‚æ­¥æ–‡ä»¶æ“ä½œï¼ˆaiofilesï¼‰æé«˜æ€§èƒ½
- æ•°æ®ç»“æ„ä¸ºå­—å…¸ï¼Œé”®ä¸º IDï¼Œå€¼ä¸ºå¯¹è±¡

**å‰ç«¯æœ¬åœ°å­˜å‚¨ï¼š**
- ç”¨æˆ·ä¿¡æ¯æŒä¹…åŒ–åˆ° localStorageï¼ˆä½¿ç”¨ Zustand persistï¼‰
- å¯¹è¯åˆ—è¡¨æ¯æ¬¡ç™»å½•åä»æœåŠ¡å™¨åŠ è½½
- å­˜å‚¨é”®åï¼š`auth-storage`

### 3. é˜²é‡å¤æŠ½ç‰Œæœºåˆ¶

**å®ç°æ–¹å¼ï¼š**
- å¯¹è¯æ¨¡å‹åŒ…å« `has_drawn_cards` å­—æ®µ
- æŠ½ç‰ŒæˆåŠŸåè°ƒç”¨ `mark_cards_drawn` è®¾ç½®ä¸º true
- åç»­æŠ½ç‰Œè¯·æ±‚æ£€æŸ¥æ­¤å­—æ®µï¼Œå¦‚æœä¸º true è¿”å› 400 é”™è¯¯
- AI ç³»ç»Ÿæç¤ºè¯æ˜ç¡®è¯´æ˜åªèƒ½æŠ½ç‰Œä¸€æ¬¡
- AI çœ‹åˆ° `[æŠ½ç‰Œç»“æœ]` æ ‡è®°åä¸å†è¿”å›æŠ½ç‰ŒæŒ‡ä»¤
- å‰ç«¯åœ¨è§£è¯»æ—¶æ£€æµ‹åˆ°æŠ½ç‰ŒæŒ‡ä»¤ä¼šå‘å‡ºè­¦å‘Šï¼ˆä½†ä¸»è¦ä¾èµ–åç«¯å’Œ AI æœºåˆ¶ï¼‰

**ä¸‰å±‚é˜²æŠ¤ï¼š**
1. **åç«¯ API å±‚**ï¼šhas_drawn_cards æ ‡è®°é˜»æ­¢é‡å¤ API è°ƒç”¨
2. **AI æç¤ºå±‚**ï¼šç³»ç»Ÿæç¤ºè¯å’ŒæŠ½ç‰Œç»“æœæ ‡è®°å¼•å¯¼ AI è¡Œä¸º
3. **å‰ç«¯é€»è¾‘å±‚**ï¼šconsole.warn æ£€æµ‹å¼‚å¸¸æƒ…å†µ

### 4. æµå¼è¾“å‡ºæœºåˆ¶

**åç«¯ï¼š**
- ä½¿ç”¨ AsyncGenerator å®ç°å¼‚æ­¥ç”Ÿæˆå™¨
- ä½¿ç”¨ StreamingResponse è¿”å› SSE æ ¼å¼
- æ•°æ®æ ¼å¼ï¼š`data: {JSON}\n\n`
- ç»“æŸæ ‡è®°ï¼š`data: [DONE]\n\n`

**å‰ç«¯ï¼š**
- ä½¿ç”¨ Fetch API çš„ ReadableStream
- ä½¿ç”¨ TextDecoder è§£ç å­—èŠ‚æµ
- é€è¡Œè§£æ SSE æ ¼å¼
- é€šè¿‡å›è°ƒå‡½æ•°å®æ—¶æ›´æ–° UI

### 5. åŠ¨ç”»æœºåˆ¶

**åŸåˆ™ï¼š**
- æ‰€æœ‰äº¤äº’éƒ½æœ‰åé¦ˆåŠ¨ç”»
- ä½¿ç”¨ Framer Motion ç»Ÿä¸€åŠ¨ç”»å®ç°
- å¸¸ç”¨åŠ¨ç”»ï¼šæ·¡å…¥ï¼ˆfadeInï¼‰ã€æ»‘å…¥ï¼ˆslideUpï¼‰ã€æ‚¬æµ®ï¼ˆfloatï¼‰

**å¸¸è§åŠ¨ç”»ï¼š**
- ç»„ä»¶è¿›å…¥ï¼šopacity 0â†’1, y 20â†’0
- æŒ‰é’® hoverï¼šscale 1â†’1.05
- æŒ‰é’® tapï¼šscale 1â†’0.95
- å¡ç‰‡æ‚¬åœï¼šscale 1â†’1.2, z ä¸Šå‡
- åˆ—è¡¨é¡¹ï¼šå»¶è¿Ÿè¿›å…¥åŠ¨ç”»ï¼ˆstaggerï¼‰

### 6. å“åº”å¼è®¾è®¡æœºåˆ¶

**å¸ƒå±€ï¼š**
- ä½¿ç”¨ Tailwind CSS çš„ flex å¸ƒå±€
- ä¾§è¾¹æ å›ºå®šå®½åº¦ï¼ˆ256pxï¼‰
- ä¸»å†…å®¹åŒºåŸŸå æ»¡å‰©ä½™ç©ºé—´
- èŠå¤©æ¶ˆæ¯æœ€å¤§å®½åº¦ 3xlï¼ˆ768pxï¼‰

**é€‚é…ï¼š**
- å½“å‰ä»…æ”¯æŒæ¡Œé¢ç«¯
- ç§»åŠ¨ç«¯éœ€è¦å¢åŠ å“åº”å¼æ–­ç‚¹å’Œä¾§è¾¹æ æŠ˜å 

### 7. å®‰å…¨æœºåˆ¶

**å¯†ç å®‰å…¨ï¼š**
- ä½¿ç”¨ bcrypt åŠ å¯†å¯†ç 
- å¯†ç å“ˆå¸Œæ°¸ä¸è¿”å›ç»™å‰ç«¯
- ç™»å½•å¤±è´¥ç»Ÿä¸€æç¤º"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯"

**API å®‰å…¨ï¼š**
- ä½¿ç”¨ CORS é™åˆ¶è·¨åŸŸè¯·æ±‚
- API Key é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®
- æ•æ„Ÿé…ç½®ä¸æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶

### 8. æ€§èƒ½ä¼˜åŒ–æœºåˆ¶

**åç«¯ï¼š**
- ä½¿ç”¨å¼‚æ­¥æ“ä½œï¼ˆasync/awaitï¼‰æé«˜å¹¶å‘æ€§èƒ½
- æ–‡ä»¶æ“ä½œä½¿ç”¨ aiofiles
- ä½¿ç”¨æµå¼è¾“å‡ºå‡å°‘ç­‰å¾…æ—¶é—´

**å‰ç«¯ï¼š**
- ä½¿ç”¨ Zustand è½»é‡çº§çŠ¶æ€ç®¡ç†
- æŒ‰éœ€åŠ è½½ï¼ˆæœªå®ç°ä»£ç åˆ†å‰²ï¼‰
- ä½¿ç”¨ Vite æ„å»ºï¼Œå¼€å‘æœåŠ¡å™¨å¯åŠ¨å¿«

---

## æ•°æ®æ¨¡å‹å…³ç³»å›¾

```
User (ç”¨æˆ·)
 â”‚
 â”œâ”€ user_id: string (PK)
 â”œâ”€ user_type: UserType
 â”œâ”€ username: string (unique)
 â”œâ”€ password_hash: string
 â””â”€ profile: UserProfile
      â”œâ”€ nickname: string
      â”œâ”€ gender: Gender
      â””â”€ birth_date: ...

Conversation (å¯¹è¯)
 â”‚
 â”œâ”€ conversation_id: string (PK)
 â”œâ”€ user_id: string (FK â†’ User)
 â”œâ”€ session_type: SessionType
 â”œâ”€ title: string
 â”œâ”€ has_drawn_cards: boolean
 â”œâ”€ is_completed: boolean
 â””â”€ messages: Message[]
      â”‚
      â”œâ”€ role: MessageRole
      â”œâ”€ content: string
      â”œâ”€ timestamp: string
      â”œâ”€ tarot_cards: TarotCard[]
      â”‚    â”œâ”€ card_id: int
      â”‚    â”œâ”€ card_name: string
      â”‚    â””â”€ reversed: boolean
      â””â”€ draw_request: DrawCardsRequest
           â”œâ”€ spread_type: TarotSpread
           â”œâ”€ card_count: int
           â””â”€ positions: string[]
```

---

## æ‰©å±•ç‚¹

### 1. æ•°æ®åº“è¿ç§»

å½“å‰ä½¿ç”¨ JSON æ–‡ä»¶å­˜å‚¨ï¼Œå¯ä»¥è¿ç§»åˆ°æ•°æ®åº“ï¼š

**æ¨èï¼š**
- SQLiteï¼ˆç®€å•ï¼Œé€‚åˆå•æœºï¼‰
- PostgreSQLï¼ˆåŠŸèƒ½å¼ºå¤§ï¼Œé€‚åˆç”Ÿäº§ï¼‰
- MongoDBï¼ˆçµæ´»ï¼Œé€‚åˆæ–‡æ¡£å­˜å‚¨ï¼‰

**æ”¹åŠ¨ç‚¹ï¼š**
- ä¿®æ”¹ `storage_service.py` å®ç°æ•°æ®åº“æ“ä½œ
- å…¶ä»–ä»£ç æ— éœ€ä¿®æ”¹ï¼ˆä¾èµ–æŠ½è±¡ï¼‰

### 2. ç”¨æˆ·è®¤è¯å¢å¼º

**å¯æ·»åŠ ï¼š**
- JWT Token è®¤è¯
- åˆ·æ–° Token æœºåˆ¶
- é‚®ç®±éªŒè¯
- å¯†ç é‡ç½®
- OAuth ç¬¬ä¸‰æ–¹ç™»å½•

### 3. æ˜Ÿç›˜è§£è¯»åŠŸèƒ½

**éœ€è¦ï¼š**
- é›†æˆæ˜Ÿåº§è®¡ç®—åº“
- è®¾è®¡æ˜Ÿç›˜ Prompt
- å®ç°æ˜Ÿç›˜ç»˜åˆ¶ï¼ˆSVG/Canvasï¼‰
- å¤ç”¨å¯¹è¯å’Œæµå¼è¾“å‡ºæœºåˆ¶

### 4. ç§»åŠ¨ç«¯é€‚é…

**éœ€è¦ï¼š**
- å“åº”å¼å¸ƒå±€ï¼ˆTailwind æ–­ç‚¹ï¼‰
- ä¾§è¾¹æ æŠ˜å /æŠ½å±‰
- è§¦æ‘¸æ‰‹åŠ¿æ”¯æŒ
- ç§»åŠ¨ç«¯æŠ½ç‰Œäº¤äº’ä¼˜åŒ–

### 5. å¯¼å‡ºåŠŸèƒ½

**å¯å¯¼å‡ºï¼š**
- å¯¹è¯å†å²ï¼ˆPDF/Markdownï¼‰
- æŠ½ç‰Œç»“æœå›¾ç‰‡
- åˆ†äº«åˆ°ç¤¾äº¤åª’ä½“

---

## ç»´æŠ¤æ³¨æ„äº‹é¡¹

### 1. æ·»åŠ æ–°çš„ä¼šè¯ç±»å‹

1. åœ¨ `backend/models.py` çš„ `SessionType` æšä¸¾æ·»åŠ æ–°ç±»å‹
2. åœ¨ `GeminiService` æ·»åŠ å¯¹åº”çš„ç³»ç»Ÿæç¤ºè¯
3. åœ¨å‰ç«¯ `types/index.ts` åŒæ­¥æ·»åŠ æšä¸¾
4. åœ¨ `SessionButtons.tsx` æ·»åŠ æŒ‰é’®é…ç½®
5. åœ¨ `App.tsx` çš„ `handleSelectSession` æ·»åŠ é€»è¾‘

### 2. ä¿®æ”¹å¡”ç½—ç‰Œæ•°æ®

1. ä¿®æ”¹ `backend/config.py` çš„ `TAROT_CARDS` åˆ—è¡¨
2. ç¡®ä¿æœ‰ 78 å¼ ç‰Œï¼ˆæˆ–è°ƒæ•´ TarotService çš„é€»è¾‘ï¼‰
3. å¦‚æœç‰Œæ•°å˜åŒ–ï¼Œä¿®æ”¹å‰ç«¯æŠ½ç‰Œå™¨çš„ç‰Œæ•°é‡

### 3. è°ƒæ•´ AI è¡Œä¸º

1. ä¿®æ”¹ `backend/services/gemini_service.py` çš„ `TAROT_SYSTEM_PROMPT`
2. è°ƒæ•´ `generation_config`ï¼ˆtemperature, top_p, max_tokensï¼‰
3. å¦‚æœä¿®æ”¹æŠ½ç‰ŒæŒ‡ä»¤æ ¼å¼ï¼ŒåŒæ­¥ä¿®æ”¹å‰ç«¯è§£æé€»è¾‘

### 4. æ›´æ¢ AI æ¨¡å‹

1. ä¿®æ”¹ `backend/config.py` çš„ `GEMINI_MODEL`
2. å¦‚æœæ›´æ¢ APIï¼ˆå¦‚ OpenAIï¼‰ï¼Œéœ€é‡å†™ `GeminiService`
3. ä¿æŒæ¥å£ä¸€è‡´ï¼Œå…¶ä»–ä»£ç æ— éœ€ä¿®æ”¹

### 5. æ€§èƒ½ç›‘æ§

**å»ºè®®æ·»åŠ ï¼š**
- API å“åº”æ—¶é—´æ—¥å¿—
- é”™è¯¯æ—¥å¿—ï¼ˆæ–‡ä»¶/Sentryï¼‰
- ç”¨æˆ·è¡Œä¸ºåˆ†æ
- æ¨¡å‹è°ƒç”¨ç»Ÿè®¡

---

## æ€»ç»“

### æ¶æ„ä¼˜åŠ¿

1. **æ¨¡å—åŒ–è®¾è®¡**ï¼šå‰åç«¯åˆ†ç¦»ï¼Œå„å±‚èŒè´£æ¸…æ™°
2. **æ˜“äºæ‰©å±•**ï¼šæ–°å¢ä¼šè¯ç±»å‹ã€AI æ¨¡å‹ã€æ•°æ®åº“éƒ½å¾ˆç®€å•
3. **ç”¨æˆ·ä½“éªŒ**ï¼šæµå¼è¾“å‡ºã€åŠ¨ç”»æ•ˆæœã€å®æ—¶åé¦ˆ
4. **æ•°æ®å®‰å…¨**ï¼šå¯†ç åŠ å¯†ã€æœ¬åœ°å­˜å‚¨ã€éšç§ä¿æŠ¤

### æŠ€æœ¯äº®ç‚¹

1. **æµå¼ AI å¯¹è¯**ï¼šä½¿ç”¨ SSE å®ç°æ‰“å­—æœºæ•ˆæœ
2. **å¡”ç½—ç‰ŒåŠ¨ç”»**ï¼šæ‰‡å½¢å±•å¼€ã€æ´—ç‰Œã€é€‰ç‰Œå…¨æµç¨‹
3. **çŠ¶æ€ç®¡ç†**ï¼šZustand è½»é‡çº§ä¸”æ˜“ç”¨
4. **å¼‚æ­¥æ¶æ„**ï¼šåç«¯å…¨å¼‚æ­¥ï¼Œæ€§èƒ½ä¼˜ç§€

### æ”¹è¿›æ–¹å‘

1. **æ•°æ®æŒä¹…åŒ–**ï¼šè¿ç§»åˆ°æ•°æ®åº“
2. **è®¤è¯ç³»ç»Ÿ**ï¼šæ·»åŠ  JWTã€æƒé™ç®¡ç†
3. **é”™è¯¯å¤„ç†**ï¼šToast æç¤ºã€é”™è¯¯æ—¥å¿—
4. **ç§»åŠ¨ç«¯**ï¼šå“åº”å¼å¸ƒå±€ã€è§¦æ‘¸ä¼˜åŒ–
5. **æµ‹è¯•**ï¼šå•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•
6. **éƒ¨ç½²**ï¼šDockeråŒ–ã€CI/CD
