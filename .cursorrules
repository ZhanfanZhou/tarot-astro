# Instructions

During your interaction with the user, if you find anything reusable in this project (e.g. version of a library, model name), especially about a fix to a mistake you made or a correction you received, you should take note in the `Lessons` section in the `.cursorrules` file so you will not make the same mistake again. åŒæ—¶ä½ éœ€è¦ç»´æŠ¤ä¸€ä¸ªç¨‹åºæ¶æ„è®¾è®¡æ–‡æ¡£`arch.md`ï¼Œæ¯æ¬¡å®Œæˆä¸€ä¸ªç¼–ç ä»»åŠ¡åï¼Œéœ€è¦å¯¹`arch.md`è¿›è¡Œæ›´æ–°ã€‚æ³¨æ„ï¼ŒLessonsä¸éœ€è¦äº‹æ— å·¨ç»†è®°å½•ï¼Œå‚è€ƒä»¥ä¸‹è§„åˆ™ï¼Œåœ¨ç¼–ç æ—¶ï¼š
1.å·²ç§»é™¤çš„æœºåˆ¶ï¼Œå·²åˆ é™¤çš„åŠŸèƒ½ä¸éœ€è¦è®°å½•ä¸ºlearnings
2.é€šè¿‡ä¿®æ”¹æˆ–æ–°å¢å¤„ç†æœºåˆ¶çš„é—®é¢˜ä¿®å¤æˆ–ä¼˜åŒ–ï¼Œä¸ç›´æ¥è®°å½•ä¸ºlearningsï¼Œåº”è¯¥åœ¨ç¨‹åºæ¶æ„è®¾è®¡è¯´æ˜æ–‡æ¡£ä¸­è®°å½•ï¼Œå¹¶åŒºåˆ†è¿™ä¸ªæœºåˆ¶æ˜¯åªåº”ç”¨åœ¨å•ç‹¬æŸä¸ªåŠŸèƒ½ï¼Œè¿˜æ˜¯æ•´ä½“æ™®éçš„æœºåˆ¶ï¼Œè¯´æ˜æ¸…æ¥šè¿™ä¸ªæœºåˆ¶çš„è®¾è®¡åŠ¨æœºï¼Œä¸‹æ¬¡ä»£ç ä¿®æ”¹æ—¶åº”è¯¥éµå®ˆè¿™äº›æœºåˆ¶
3.é‡æ„ç±»ä¿®æ”¹ï¼Œå’Œä¿®æ”¹æœºåˆ¶ç±»ä¼¼ï¼Œåº”è¯¥åœ¨ç¨‹åºæ¶æ„è®¾è®¡è¯´æ˜æ–‡æ¡£ä¸­è®°å½•
4.ç¼–ç çº§é—®é¢˜ä¿®æ”¹ï¼Œå¦‚APIä½¿ç”¨é”™è¯¯ï¼Œç±»å‹é”™è¯¯ï¼Œæ–‡ä»¶åéæ³•å­—ç¬¦ä¿®å¤ç­‰ï¼Œå¯ä»¥è®°å½•åˆ°learnings

`arch.md`æ–‡æ¡£ï¼Œå†…å®¹å¿…é¡»åŒ…æ‹¬ï¼š
1.æ¯ä¸ªåŠŸèƒ½æ¨¡å—çš„æ•´ä½“å®ç°é€»è¾‘ï¼Œæ¶‰åŠå“ªäº›æœºåˆ¶ï¼Œæ¨¡å—é—´çš„å…³ç³»
2.åŠŸèƒ½æ¨¡å—ä¸­ï¼Œå‡½æ•°è°ƒç”¨å…³ç³»ï¼Œå„ä¸ªå‡½æ•°å®ç°äº†è¯¥åŠŸèƒ½æ¨¡å—çš„å“ªäº›å­åŠŸèƒ½

# Tools & Resources

`arch.md`æ˜¯ç¨‹åºæ¶æ„è®¾è®¡è¯´æ˜æ–‡æ¡£ï¼Œéœ€è¦æ ¹æ®ç¼–ç ä»»åŠ¡çš„å®Œæˆæƒ…å†µï¼ŒåŠæ—¶æ›´æ–°ã€‚æ¯æ¬¡ç¼–ç ä¿®æ”¹å‰ï¼Œå¦‚æœ‰å¿…è¦ï¼Œæ‰¾åˆ°è¦ä¿®æ”¹çš„æ¨¡å—å¯¹åº”çš„ç« èŠ‚å‚è€ƒï¼Œé¿å…å¼•å…¥æ–°çš„bugï¼ï¼ï¼NOTE: arch.mdå†…å®¹å¾ˆå¤šï¼Œä½ åªå…³æ³¨éœ€è¦ä¿®æ”¹æ¨¡å—ï¼Œä¸è¦ä¿®æ”¹ä¸å±äºä½ è´Ÿè´£çš„æ¨¡å—ï¼ï¼ï¼
`Lessons` section in the `.cursorrules` æ˜¯ç¼–ç ç»éªŒæ€»ç»“ï¼Œéœ€è¦æ ¹æ®ç¼–ç ä»»åŠ¡çš„å®Œæˆæƒ…å†µï¼Œç²¾ç‚¼åœ°æ€»ç»“å…³é”®ç‚¹ã€‚
`update_log.md`æ˜¯æ›´æ–°æ—¥å¿—ï¼Œä½ æ¯æ¬¡å®Œæˆç¼–ç ä»»åŠ¡åçš„æ€»ç»“åŒæ­¥è¾“å…¥åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œè¯¥æ–‡ä»¶åªå†™æ”¹åŠ¨ç‚¹ï¼Œä¸è®°å½•ç»éªŒï¼Œç»éªŒæ€»ç»“éƒ½å†™åœ¨`.cursorrules`ä¸­ã€‚

# Lessons

## User Specified Lessons
- You have a python venv in ./venv. Use (.\venv\Scripts\activate) in Windows or (source venv/bin/activate) in MacOS to activate it when doing python development. First, to check whether 'uv' is available, use `which uv`. If that's the case, first activate the venv, and then use `uv pip install` to install packages. Otherwise, fall back to `pip`.
- Due to Cursor's limit, when you use `git` and need to submit a multiline commit message, first write the message in a file, and then use `git commit -F <filename>` or commit. And then remove the file. Include "[Cursor] " in the commit message and PR title.
- IMPORTANT: Note that the way to run bash command are different in different operating systems. For example, on Windows, you need to use python instead of python3. On Windows, you are using powershell instead of terminal.

## Cursor learned

### API ä½¿ç”¨æ³¨æ„äº‹é¡¹

1. **Gemini API æµå¼è¾“å‡º**ï¼šä½¿ç”¨ `model.start_chat()` åˆ›å»ºä¼šè¯ï¼Œç„¶åç”¨ `send_message_async(stream=True)` å®ç°æµå¼è¾“å‡º
2. **è‡ªå®šä¹‰ AI æŒ‡ä»¤ä¼ é€’**ï¼šä½¿ç”¨ XML æ ‡ç­¾ï¼ˆå¦‚ `<draw_cards>...</draw_cards>`ï¼‰åœ¨ AI å›å¤ä¸­åµŒå…¥ç»“æ„åŒ–æŒ‡ä»¤ï¼Œç„¶åç”¨æ­£åˆ™è¡¨è¾¾å¼æå–
3. **FastAPI æµå¼å“åº”**ï¼šä½¿ç”¨ `StreamingResponse` + Server-Sent Events (SSE) æ ¼å¼ï¼ˆ`data: {JSON}\n\n`ï¼‰
4. **Zustand æŒä¹…åŒ–**ï¼šä½¿ç”¨ `persist()` ä¸­é—´ä»¶ï¼Œé…ç½® `name` å±æ€§æŒ‡å®š localStorage é”®å
5. **æ˜Ÿç›˜API JSONæ ¼å¼**ï¼šä½¿ç”¨ `json=params` è€Œé `data=params` å‘é€è¯·æ±‚ï¼Œç¡®ä¿æ•°ç»„å‚æ•°æ­£ç¡®ä¼ é€’

### æ–‡ä»¶è·¯å¾„å’Œå‘½åè§„èŒƒ

1. **åç«¯è·¯ç”±æ–‡ä»¶**ï¼šä½¿ç”¨å¤æ•°å½¢å¼ï¼Œå¦‚ `users.py`, `conversations.py`
2. **å‰ç«¯ç»„ä»¶**ï¼šä½¿ç”¨ PascalCaseï¼Œå¦‚ `ChatMessage.tsx`, `TarotCardDrawer.tsx`
3. **çŠ¶æ€ç®¡ç†**ï¼šä½¿ç”¨ `useXxxStore.ts` å‘½åï¼Œå¦‚ `useAuthStore.ts`
4. **API æœåŠ¡**ï¼šç»Ÿä¸€æ”¾åœ¨ `services/api.ts`ï¼Œå¯¼å‡ºå¤šä¸ª API å¯¹è±¡

### Windows ç‰¹å®šæ³¨æ„äº‹é¡¹

- è¿è¡Œè„šæœ¬ä½¿ç”¨ `.bat` æ–‡ä»¶
- æ¿€æ´» venv ä½¿ç”¨ `.\venv\Scripts\activate`
- Python å‘½ä»¤ä½¿ç”¨ `python` è€Œé `python3`
- ä½¿ç”¨ PowerShell è€Œé bash

### macOS ç‰¹å®šæ³¨æ„äº‹é¡¹

- **Python æ¨¡å—å¯¼å…¥è·¯å¾„**ï¼šåœ¨ macOS ä¸Šè¿è¡Œ Python æ—¶ï¼Œå½“å‰å·¥ä½œç›®å½•æ˜¯é¡¹ç›®æ ¹ç›®å½•ï¼Œå› æ­¤ä¸éœ€è¦ `backend.` å‰ç¼€
  - é”™è¯¯ï¼š`from backend.config import CORS_ORIGINS`
  - æ­£ç¡®ï¼š`from config import CORS_ORIGINS`
- **ç«¯å£å ç”¨å¤„ç†**ï¼šä½¿ç”¨ `lsof -ti:8000 | xargs kill -9` æ¸…ç†å ç”¨ç«¯å£çš„è¿›ç¨‹
- **å¯åŠ¨è„šæœ¬æƒé™**ï¼šä½¿ç”¨ `chmod +x run_backend.sh` ç»™è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™

### ç¼–ç ç±»é—®é¢˜è®°å½•

#### 1. Python é—­åŒ…å˜é‡ä½œç”¨åŸŸé—®é¢˜

**é—®é¢˜ï¼š** åœ¨ Python é—­åŒ…ä¸­å¯¹å¤–éƒ¨å˜é‡èµ‹å€¼ï¼Œä¼šå¯¼è‡´è¯¥å˜é‡è¢«è§†ä¸ºå±€éƒ¨å˜é‡ï¼Œä»è€Œåœ¨èµ‹å€¼å‰ä½¿ç”¨æ—¶æŠ¥ `UnboundLocalError`

**é”™è¯¯ä¿¡æ¯ï¼š** `UnboundLocalError: local variable 'conversation' referenced before assignment`

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# é”™è¯¯å†™æ³•ï¼šåœ¨é—­åŒ…ä¸­é‡æ–°èµ‹å€¼å¤–éƒ¨å˜é‡
async def generate():
    # ä½¿ç”¨å¤–éƒ¨å˜é‡
    async for event in service.stream_response(conversation.messages):  # âŒ æŠ¥é”™
        ...
        # åé¢é‡æ–°èµ‹å€¼äº† conversation
        conversation = await get_conversation(id)  # âŒ å¯¼è‡´å‰é¢æŠ¥é”™

# æ­£ç¡®å†™æ³•ï¼šä½¿ç”¨ä¸åŒçš„å˜é‡å
async def generate():
    # ä½¿ç”¨å¤–éƒ¨å˜é‡
    async for event in service.stream_response(conversation.messages):  # âœ… æ­£å¸¸
        ...
        # ä½¿ç”¨ä¸åŒçš„å˜é‡å
        updated_conv = await get_conversation(id)  # âœ… é¿å…å†²çª
```

**æ ¸å¿ƒåŸåˆ™ï¼š**
1. Python åœ¨å‡½æ•°å®šä¹‰æ—¶æ‰«æä»£ç ï¼Œçœ‹åˆ°å˜é‡è¢«èµ‹å€¼å°±è®¤ä¸ºæ˜¯å±€éƒ¨å˜é‡
2. å³ä½¿èµ‹å€¼åœ¨åé¢ï¼Œå‰é¢çš„å¼•ç”¨ä¹Ÿä¼šæŠ¥é”™
3. åœ¨é—­åŒ…ä¸­é¿å…å¯¹å¤–éƒ¨å˜é‡é‡æ–°èµ‹å€¼
4. éœ€è¦æ›´æ–°çš„å€¼ä½¿ç”¨æ–°å˜é‡åï¼ˆå¦‚ `updated_xxx`ï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°ä¸­ä½¿ç”¨å¤–éƒ¨å˜é‡
- ä»»ä½•é—­åŒ…éœ€è¦æ›´æ–°å¤–éƒ¨å˜é‡çš„åœºæ™¯
- FastAPI æµå¼å“åº”ä¸­çš„å˜é‡ç®¡ç†

#### 2. FastAPI Query å‚æ•°å£°æ˜

**é—®é¢˜ï¼š** FastAPI æ¥å£åŒæ—¶æ¥æ”¶è¯·æ±‚ä½“å’ŒæŸ¥è¯¢å‚æ•°æ—¶ï¼Œéœ€è¦æ˜ç¡®å£°æ˜å‚æ•°æ¥æº

**é”™è¯¯ä¿¡æ¯ï¼š** 422 Unprocessable Entity

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# é”™è¯¯å†™æ³•ï¼šFastAPI ä¸çŸ¥é“ conversation_id ä»å“ªé‡Œæ¥
@router.post("/draw")
async def draw_cards(
    conversation_id: str,  # âŒ å¯èƒ½è¢«è¯¯è§£ä¸ºè¯·æ±‚ä½“
    draw_request: DrawCardsRequest
):
    ...

# æ­£ç¡®å†™æ³•ï¼šæ˜ç¡®æŒ‡å®šä¸ºæŸ¥è¯¢å‚æ•°
from fastapi import Query

@router.post("/draw")
async def draw_cards(
    draw_request: DrawCardsRequest,  # ä»è¯·æ±‚ä½“è·å–
    conversation_id: str = Query(...)  # âœ… æ˜ç¡®ä»æŸ¥è¯¢å‚æ•°è·å–
):
    ...
```

**æ ¸å¿ƒåŸåˆ™ï¼š**
1. Pydantic æ¨¡å‹å‚æ•°è‡ªåŠ¨ä»è¯·æ±‚ä½“è§£æ
2. ç®€å•ç±»å‹å‚æ•°éœ€è¦æ˜ç¡®æŒ‡å®šæ¥æºï¼ˆQuery, Path, Header ç­‰ï¼‰
3. å‚æ•°é¡ºåºï¼šè¯·æ±‚ä½“å‚æ•°åœ¨å‰ï¼Œå…¶ä»–å‚æ•°åœ¨åï¼ˆå¯é€‰ä½†æ¨èï¼‰

**é€‚ç”¨åœºæ™¯ï¼š**
- POST/PUT æ¥å£åŒæ—¶éœ€è¦è¯·æ±‚ä½“å’ŒæŸ¥è¯¢å‚æ•°
- éœ€è¦æ˜ç¡®å‚æ•°æ¥æºçš„æ‰€æœ‰ FastAPI æ¥å£

#### 3. Gemini API Protobuf ç±»å‹åºåˆ—åŒ–

**é—®é¢˜ï¼š** Gemini API è¿”å›çš„å‡½æ•°å‚æ•°åŒ…å« protobuf ç±»å‹ï¼ˆ`RepeatedComposite`ï¼‰ï¼Œæ— æ³•ç›´æ¥è¢« `json.dumps` åºåˆ—åŒ–

**é”™è¯¯ä¿¡æ¯ï¼š** `TypeError: Object of type RepeatedComposite is not JSON serializable`

**è§£å†³æ–¹æ¡ˆï¼š**
```python
# é”™è¯¯å†™æ³•
yield f"data: {json.dumps({'draw_cards': func_args})}\n\n"

# æ­£ç¡®å†™æ³•ï¼šå…ˆè½¬æ¢ä¸ºå¯åºåˆ—åŒ–æ ¼å¼
serializable_args = json.loads(json.dumps(func_args, default=str))
yield f"data: {json.dumps({'draw_cards': serializable_args})}\n\n"
```

**æ ¸å¿ƒåŸåˆ™ï¼š**
1. Gemini API çš„ `func_call.args` ä½¿ç”¨ `dict()` è½¬æ¢åï¼ŒåµŒå¥—çš„æ•°ç»„å¯èƒ½ä»æ˜¯ protobuf ç±»å‹
2. ä½¿ç”¨ `json.dumps(..., default=str)` å¯ä»¥å¤„ç†æ‰€æœ‰ä¸å¯åºåˆ—åŒ–çš„å¯¹è±¡
3. å†ç”¨ `json.loads()` è½¬å›æ¥ï¼Œå¾—åˆ°å®Œå…¨å¯åºåˆ—åŒ–çš„ Python åŸç”Ÿç±»å‹

**é€‚ç”¨åœºæ™¯ï¼š**
- å¤„ç† Gemini Function Calling çš„å‚æ•°
- ä»»ä½•æ¶‰åŠ protobuf æ•°æ®çš„ JSON åºåˆ—åŒ–
- SSE æµå¼è¾“å‡ºä¸­ä¼ é€’å¤æ‚å¯¹è±¡

#### 4. React çŠ¶æ€å¼‚æ­¥æ›´æ–°ä¸é—­åŒ…é—®é¢˜

**é—®é¢˜ï¼š** React çŠ¶æ€æ›´æ–°æ˜¯å¼‚æ­¥çš„ï¼Œé—­åŒ…ä¼šæ•è·æ—§çš„çŠ¶æ€å€¼

**æ ¸å¿ƒåŸåˆ™ï¼š**
1. **é¿å…åœ¨é—­åŒ…ä¸­ä¾èµ– React çŠ¶æ€** - é—­åŒ…æ•è·çš„æ˜¯å®šä¹‰æ—¶çš„å€¼
2. **ç›´æ¥ä½¿ç”¨å‡½æ•°å‚æ•°æˆ–å±€éƒ¨å˜é‡** - ç¡®ä¿ä½¿ç”¨æœ€æ–°çš„å€¼
3. **ä¸è¦ç”¨ setTimeout è§£å†³çŠ¶æ€æ›´æ–°é—®é¢˜** - æ²»æ ‡ä¸æ²»æœ¬
4. **å†…è”é€»è¾‘è€Œéè°ƒç”¨ä¾èµ–çŠ¶æ€çš„å‡½æ•°** - å‡å°‘çŠ¶æ€ä¾èµ–é“¾

**é€‚ç”¨åœºæ™¯ï¼š**
- åˆ›å»ºå¯¹è¯åç«‹å³å‘é€æ¶ˆæ¯
- çŠ¶æ€æ›´æ–°åç«‹å³æ‰§è¡Œä¾èµ–è¯¥çŠ¶æ€çš„æ“ä½œ
- ä»»ä½•æ¶‰åŠå¼‚æ­¥çŠ¶æ€æ›´æ–°çš„åœºæ™¯

#### 5. å¤–éƒ¨APIæ•°æ®è¯·æ±‚ä¸æ ¼å¼åŒ–çš„åŒæ­¥æ€§

**é—®é¢˜ï¼š** æ‰©å±•å¤–éƒ¨APIè¯·æ±‚å‚æ•°åï¼Œå¿˜è®°åŒæ­¥æ›´æ–°æ•°æ®æ ¼å¼åŒ–å‡½æ•°ï¼Œå¯¼è‡´æ–°æ•°æ®æ— æ³•ä¼ é€’ç»™AI


**æ ¸å¿ƒåŸåˆ™ï¼š**
1. **APIè¯·æ±‚æ‰©å±•æ—¶ï¼Œå¿…é¡»åŒæ­¥æ›´æ–°æ•°æ®å¤„ç†é“¾** - ä»è·å–åˆ°æ ¼å¼åŒ–åˆ°ä¼ é€’ï¼Œä¸‰ä¸ªç¯èŠ‚éƒ½è¦æ›´æ–°
2. **æ•°æ®æµå®Œæ•´æ€§æ£€æŸ¥** - é€šè¿‡æ—¥å¿—éªŒè¯æ•°æ®åœ¨æ¯ä¸ªç¯èŠ‚éƒ½æ­£ç¡®å¤„ç†
3. **æ·»åŠ è°ƒè¯•æ—¥å¿—** - åœ¨å…³é”®èŠ‚ç‚¹æ‰“å°æ•°æ®ï¼Œæ–¹ä¾¿è¿½è¸ªæ•°æ®æµå‘

**æ£€æŸ¥æ¸…å•ï¼ˆæ‰©å±•å¤–éƒ¨APIæ•°æ®æ—¶ï¼‰ï¼š**
- [ ] æ›´æ–°APIè¯·æ±‚å‚æ•°ï¼ˆå¦‚ `params` å­—å…¸ï¼‰
- [ ] æ›´æ–°æ•°æ®æ ¼å¼åŒ–å‡½æ•°ï¼ˆå¦‚ `format_chart_data_to_text()`ï¼‰
- [ ] ç¡®è®¤æ•°æ®æ­£ç¡®ä¼ é€’ç»™ä¸‹æ¸¸ï¼ˆå¦‚ä¼ é€’ç»™AIï¼‰
- [ ] æ·»åŠ æ—¥å¿—è¾“å‡ºï¼ŒéªŒè¯æ¯ä¸ªç¯èŠ‚çš„æ•°æ®

**é€‚ç”¨åœºæ™¯ï¼š**
- æ‰©å±•æ˜Ÿç›˜APIè¯·æ±‚çš„æ˜Ÿä½“ã€å®«ä½ç­‰æ•°æ®
- é›†æˆä»»ä½•å¤–éƒ¨APIæ—¶æ‰©å±•è¯·æ±‚å‚æ•°
- å¤šå±‚æ•°æ®å¤„ç†æµç¨‹çš„ä¿®æ”¹

#### 6. å¤šè·¯ç”±åŠŸèƒ½ä¸€è‡´æ€§ç»´æŠ¤

**é—®é¢˜ï¼š** æ˜Ÿåº§AIå’Œå¡”ç½—AIåŠŸèƒ½ä¸ä¸€è‡´ï¼Œæ˜Ÿåº§AIç¼ºå°‘æŠ½ç‰Œæ¥å£ï¼Œå¯¼è‡´å‰ç«¯è°ƒç”¨å¤±è´¥

**æ ¸å¿ƒåŸåˆ™ï¼š**
1. **åŠŸèƒ½å¯¹ç­‰æ€§** - ç›¸åŒåŠŸèƒ½åœ¨ä¸åŒè·¯ç”±ä¸­åº”è¯¥ä¿æŒä¸€è‡´
2. **æ¥å£å®Œæ•´æ€§** - æ¯ä¸ªè·¯ç”±éƒ½åº”è¯¥æœ‰å®Œæ•´çš„åŠŸèƒ½æ¥å£
3. **å‰ç«¯è·¯ç”±é€‰æ‹©** - æ ¹æ®ä¼šè¯ç±»å‹åŠ¨æ€é€‰æ‹©æ­£ç¡®çš„API
4. **é”™è¯¯å¤„ç†ç»Ÿä¸€** - ç›¸åŒåŠŸèƒ½åº”è¯¥æœ‰ç›¸åŒçš„é”™è¯¯å¤„ç†æœºåˆ¶

**æ£€æŸ¥æ¸…å•ï¼ˆå¤šè·¯ç”±åŠŸèƒ½å¼€å‘æ—¶ï¼‰ï¼š**
- [ ] ç¡®è®¤æ‰€æœ‰ç›¸å…³è·¯ç”±éƒ½æœ‰å¯¹åº”çš„æ¥å£
- [ ] å‰ç«¯æ ¹æ®ä¼šè¯ç±»å‹é€‰æ‹©æ­£ç¡®çš„API
- [ ] åŠŸèƒ½å®ç°é€»è¾‘ä¿æŒä¸€è‡´
- [ ] é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç®¡ç†ç»Ÿä¸€
- [ ] æ›´æ–°æ¶æ„æ–‡æ¡£ï¼Œè®°å½•æ–°å¢åŠŸèƒ½

**é€‚ç”¨åœºæ™¯ï¼š**
- ä¸ºå¤šä¸ªAIç±»å‹æ·»åŠ ç›¸åŒåŠŸèƒ½ï¼ˆå¦‚æŠ½ç‰Œã€æ˜Ÿç›˜ç­‰ï¼‰
- ä¿®å¤åŠŸèƒ½ä¸ä¸€è‡´å¯¼è‡´çš„è°ƒç”¨é”™è¯¯
- ç»Ÿä¸€å¤šè·¯ç”±çš„æ¥å£è®¾è®¡

#### 7. React å¼‚æ­¥å›è°ƒä¸­çš„çŠ¶æ€é—­åŒ…é™·é˜±

**é—®é¢˜ï¼š** åœ¨å¼‚æ­¥æµç¨‹ä¸­ä½¿ç”¨ React çŠ¶æ€æ¥è¿½è¸ªæ“ä½œï¼Œå¯¼è‡´é‡å¤æ‰§è¡Œ

**ç—‡çŠ¶ï¼š** 
- æ˜Ÿåº§AIè·å–æ˜Ÿç›˜æ•°æ®åè‡ªåŠ¨è§¦å‘AIå›å¤ï¼Œä½†è¿™æ¡å›å¤è¢«å‘é€äº†å¤šæ¬¡ï¼ˆå¦‚3æ¬¡ï¼‰
- ä½¿ç”¨ `setChartJustFetched(true)` åœ¨å›è°ƒä¸­è®¾ç½®çŠ¶æ€
- åœ¨åŒä¸€å‡½æ•°åé¢æ£€æŸ¥ `if (chartJustFetched)` æ—¶ä½¿ç”¨çš„æ˜¯æ—§çš„çŠ¶æ€å€¼

**é”™è¯¯å†™æ³•ï¼š**
```typescript
// âŒ é”™è¯¯ï¼šåœ¨å›è°ƒä¸­è®¾ç½®çŠ¶æ€ï¼Œç„¶åä¾èµ–è¯¥çŠ¶æ€åˆ¤æ–­
const [chartJustFetched, setChartJustFetched] = useState(false);

await astrologyApi.sendMessage(
  conversationId,
  content,
  (chunk) => { /* ... */ },
  async (instruction) => {
    // è®¾ç½®çŠ¶æ€ï¼ˆå¼‚æ­¥ç”Ÿæ•ˆï¼‰
    setChartJustFetched(true);  // âŒ æ ‡è®°1ï¼šè¿™ä¼šåŠ å…¥Reactæ‰¹å¤„ç†é˜Ÿåˆ—
  }
);

// åé¢çš„åˆ¤æ–­ä½¿ç”¨æ—§å€¼
if (chartJustFetched) {  // âŒ è¿™é‡Œ chartJustFetched ä»ç„¶æ˜¯ falseï¼ˆé—­åŒ…æ•è·çš„æ—§å€¼ï¼‰
  await astrologyApi.sendMessage(...);  // è¿™å¯¼è‡´é‡å¤å‘é€
}
```

**æ­£ç¡®å†™æ³•ï¼š**
```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æœ¬åœ°å˜é‡è¿½è¸ªï¼Œä¸ä¾èµ–ReactçŠ¶æ€
let chartWasFetched = false;  // æœ¬åœ°å˜é‡ï¼ŒåŒæ­¥ç”Ÿæ•ˆ

await astrologyApi.sendMessage(
  conversationId,
  content,
  (chunk) => { /* ... */ },
  async (instruction) => {
    // ç›´æ¥ä¿®æ”¹æœ¬åœ°å˜é‡ï¼ˆåŒæ­¥ï¼Œç«‹å³ç”Ÿæ•ˆï¼‰
    chartWasFetched = true;  // âœ… ç«‹å³ç”Ÿæ•ˆ
  }
);

// æ£€æŸ¥æœ¬åœ°å˜é‡ï¼ˆè·å–æœ€æ–°å€¼ï¼‰
if (chartWasFetched) {  // âœ… è¿™é‡Œèƒ½è·å–æœ€æ–°å€¼
  await astrologyApi.sendMessage(...);  // âœ… åªå‘é€ä¸€æ¬¡
}
```

**æ ¸å¿ƒåŸåˆ™ï¼š**
1. **å¼‚æ­¥çŠ¶æ€ vs åŒæ­¥å˜é‡**ï¼šå¯¹äºåœ¨åŒä¸€ä¸ªå¼‚æ­¥æ“ä½œå‘¨æœŸå†…éœ€è¦è¿½è¸ªçš„çŠ¶æ€ï¼Œä½¿ç”¨æœ¬åœ°å˜é‡è€Œé React çŠ¶æ€
2. **é—­åŒ…é™·é˜±**ï¼šå›è°ƒå‡½æ•°æ•è·çš„ React çŠ¶æ€æ˜¯å®šä¹‰æ—¶çš„å€¼ï¼Œä¸ä¼šè‡ªåŠ¨æ›´æ–°
3. **ä½•æ—¶ä½¿ç”¨ React çŠ¶æ€**ï¼šè·¨å‡½æ•°ã€è·¨ç»„ä»¶éœ€è¦å…±äº«çš„çŠ¶æ€ï¼›éœ€è¦è§¦å‘é‡æ–°æ¸²æŸ“çš„çŠ¶æ€
4. **ä½•æ—¶ä½¿ç”¨æœ¬åœ°å˜é‡**ï¼šå•ä¸ªå¼‚æ­¥æ“ä½œå‘¨æœŸå†…çš„ä¸´æ—¶çŠ¶æ€è¿½è¸ªï¼›å›è°ƒé“¾ä¸­çš„çŠ¶æ€åŒæ­¥

**ä¸ºä»€ä¹ˆæœ¬åœ°å˜é‡æœ‰æ•ˆï¼š**
- ä¸æ¶‰åŠ React çš„å¼‚æ­¥çŠ¶æ€æ›´æ–°æœºåˆ¶
- å›è°ƒå‡½æ•°ä¸­å¯¹æœ¬åœ°å˜é‡çš„ä¿®æ”¹ç«‹å³åœ¨åŒä¸€ä½œç”¨åŸŸå¯è§
- åœ¨å…³é”®å†³ç­–ç‚¹èƒ½è·å–æœ€æ–°çš„å€¼
- é¿å…äº†é—­åŒ…æ•è·æ—§å€¼çš„é—®é¢˜

**é€‚ç”¨åœºæ™¯ï¼š**
- è·å–æ•°æ®åè‡ªåŠ¨è§¦å‘åç»­æ“ä½œï¼ˆå¦‚æ˜Ÿç›˜è·å–åè‡ªåŠ¨è®©AIç»§ç»­è§£è¯»ï¼‰
- å›è°ƒé“¾ä¸­éœ€è¦è¿½è¸ªå‰ä¸€ä¸ªæ­¥éª¤çš„å®ŒæˆçŠ¶æ€
- å•ä¸ªç”¨æˆ·äº¤äº’æµç¨‹ä¸­çš„å¤šæ­¥æ“ä½œåè°ƒ
- ä¸éœ€è¦è·¨ç»„ä»¶å…±äº«çš„ä¸´æ—¶çŠ¶æ€
#### 8. Gemini Function Calling å‚æ•°ç±»å‹å’Œæµå¼å“åº”å¼‚å¸¸å¤„ç†`n
**é—®é¢˜ï¼?*
1. Gemini Function Calling è¿”å›çš„å‚æ•°ç±»å‹ä¸åç«¯æœŸæœ›ç±»å‹ä¸åŒ¹é…å¯¼è‡?422 é”™è¯¯
2. æµå¼å“åº”å¤„ç†ä¸­ï¼Œå½?finish_reason=1 æ—¶ï¼Œè®¿é—® .text å±æ€§æŠ›å‡?ValueError

**è§£å†³æ–¹æ¡ˆï¼?*
1. Gemini å‡½æ•°å®šä¹‰ä¸­æ·»åŠ?enum çº¦æŸ
2. Pydantic æ¨¡å‹ä½¿ç”¨ str ç±»å‹è€Œé enum
3. æµå¼å“åº”å¼‚å¸¸å¤„ç†ï¼štry-except æ•è· ValueError
